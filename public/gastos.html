<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gastos & Diárias — Motorista Plus</title>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#0b0f14; --bg2:#10161d; --card:#161c23;
      --primary:#f39220; --primary-700:#d47e16;
      --outline:#2b3a49; --text:#fff; --muted:#b5bcc7;
      --green:#2b9348; --red:#dc3545; --info:#0077b6;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,Arial,sans-serif}
    body{background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column}

    /* Voltar no topo */
    #voltarPainelTopo{
      position:fixed; top:12px; left:12px; z-index:9999;
      width:auto; padding:8px 14px;
      background:rgba(255,255,255,.08); color:#fff;
      border-radius:8px; border:1px solid rgba(255,255,255,.25);
      cursor:pointer; font-size:14px; backdrop-filter:blur(4px);
      transition:.3s ease;
    }
    #voltarPainelTopo:hover{ background:rgba(255,255,255,.16) }

    header{
      background:linear-gradient(180deg,rgba(0,0,0,.3),rgba(0,0,0,.6));
      padding:28px 16px; text-align:center; border-bottom:1px solid var(--outline)
    }
    header h1{font-weight:800;font-size:clamp(20px,4vw,30px)}
    header .plus{color:var(--primary)}

    .wrap{width:94%;max-width:1100px;margin:18px auto;flex:1;display:grid;gap:14px}

    .card{
      background:var(--card); border:1px solid var(--outline);
      padding:16px; border-radius:12px; backdrop-filter:blur(6px)
    }

    .dados{display:flex;gap:10px;flex-wrap:wrap}
    .dados div{min-width:180px;background:rgba(255,255,255,.05);border:1px solid var(--outline);
      padding:10px;border-radius:10px}
    .dados div b{color:var(--primary)}

    h2{color:var(--primary);font-size:1.15rem;margin-bottom:8px}
    label{display:block;font-size:13px;margin-top:8px;color:#e8e8e8}

    input,select,textarea,button{
      width:100%;padding:12px;border-radius:10px;border:1px solid var(--outline);
      background:rgba(255,255,255,.08);color:#fff;font-size:14px;outline:none;
      transition:box-shadow .2s ease, transform .08s ease, background .2s ease, border-color .2s ease;
    }
    input:focus,select:focus,textarea:focus{box-shadow:0 0 0 3px rgba(243,146,32,.15);border-color:var(--primary)}

    select{
      -webkit-appearance:none;-moz-appearance:none;appearance:none;
      background-image:linear-gradient(45deg,transparent 50%, #fff 50%),
                       linear-gradient(135deg, #fff 50%, transparent 50%),
                       linear-gradient(to right, transparent, transparent);
      background-position:calc(100% - 18px) calc(50% - 3px),
                          calc(100% - 13px) calc(50% - 3px),
                          calc(100% - 2.2em) 0.6em;
      background-size:5px 5px, 5px 5px, 1px 1.6em;
      background-repeat:no-repeat;
    }

    .grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media(max-width:900px){.grid2{grid-template-columns:1fr}}

    .btn{background:var(--primary);border:none;font-weight:700;color:#fff;cursor:pointer;transition:.25s}
    .btn:hover{background:var(--primary-700);transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn-green{background:var(--green)} .btn-green:hover{filter:brightness(1.05)}
    .btn-red{background:var(--red)} .btn-red:hover{filter:brightness(1.05)}
    .btn-info{background:var(--info)} .btn-info:hover{filter:brightness(1.05)}
    .btn-ghost{background:transparent;border:1px solid var(--outline);color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap}

    ul{list-style:none;padding-left:0;margin-top:8px;max-height:260px;overflow:auto}
    li{background:rgba(255,255,255,.05);border:1px solid var(--outline);
      padding:10px;border-radius:10px;margin:6px 0;display:flex;justify-content:space-between;gap:8px;align-items:center;flex-wrap:wrap}
    .tag{font-size:12px;color:var(--muted)}
    .row-actions{display:flex;gap:8px;flex-wrap:wrap}

    canvas{display:block;margin:10px auto;max-width:420px}
    footer{padding:12px;text-align:center;color:var(--muted);border-top:1px solid var(--outline)}
  </style>
</head>
<body>

  <button id="voltarPainelTopo" onclick="window.location.href='painel.html'">← Voltar</button>

  <header>
    <h1>Gastos & Diárias — Motorista<span class="plus">Plus</span></h1>
  </header>

  <main class="wrap">
    <!-- Dados do Motorista -->
    <section class="card">
      <h2>Dados do Motorista</h2>
      <div class="dados" id="dadosUsuario"></div>
    </section>

    <!-- Diárias -->
    <section class="card">
      <h2>Período da Viagem (diárias automáticas)</h2>
      <div class="row" style="margin-top:6px">
        <div style="flex:1 1 220px">
          <label for="tripStart">Data Início</label>
          <input type="date" id="tripStart">
        </div>
        <div style="flex:1 1 220px">
          <label for="tripEnd">Data Fim</label>
          <input type="date" id="tripEnd">
        </div>
        <div style="flex:0 0 180px;align-self:end">
          <button class="btn btn-green" id="calcDiarias">Calcular Diárias</button>
        </div>
        <div style="flex:0 0 180px;align-self:end">
          <button class="btn btn-ghost" id="clearDiarias">Limpar Diárias</button>
        </div>
      </div>
      <p id="totalDiariasText" class="tag" style="margin-top:8px">Total de diárias: 0 — Valor total: R$ 0,00</p>
    </section>

    <!-- GASTOS + VALES -->
    <div class="grid2">
      <!-- Gastos -->
      <section class="card">
        <h2>Registrar Gasto</h2>
        <label for="gastoDate">Data</label>
        <input type="date" id="gastoDate">

        <label for="gastoMotivo">Motivo</label>
        <input id="gastoMotivo" placeholder="Ex: Almoço, Pedágio">

        <label for="gastoLocal">Local</label>
        <input id="gastoLocal" placeholder="Ex: Posto X">

        <label for="gastoValor">Valor (R$)</label>
        <input id="gastoValor" type="number" step="0.01" min="0">

        <label for="gastoAut">Autorização</label>
        <select id="gastoAut">
          <option value="Francisco">Francisco</option>
          <option value="Vinicios">Vinicios</option>
          <option value="Jeferson">Jeferson</option>
          <option value="Daniel">Daniel</option>
          <option value="William">William</option>
          <option value="Douglas">Douglas</option>
          <option value="Valdir">Valdir</option>
          <option value="Outro">Outro</option>
        </select>

        <div class="row" style="margin-top:10px">
          <button class="btn btn-green" id="addGasto" style="flex:1 1 160px">Salvar</button>
          <button class="btn btn-ghost" id="cancelarEditGasto" style="flex:1 1 160px;display:none">Cancelar edição</button>
          <button class="btn btn-ghost" id="clearGasto" style="flex:1 1 160px">Limpar</button>
        </div>

        <h3 style="margin-top:12px;font-size:1rem;color:var(--primary)">Lista de Gastos</h3>
        <ul id="listaGastos"></ul>
      </section>

      <!-- Vales -->
      <section class="card">
        <h2>Retirada de Vales</h2>

        <label for="valeDate">Data</label>
        <input id="valeDate" type="date">

        <label for="valeMotivo">Descrição</label>
        <input id="valeMotivo" placeholder="Ex: Vale refeição, adiantamento...">

        <label for="valeValor">Valor (R$)</label>
        <input id="valeValor" type="number" step="0.01" min="0">

        <div class="row" style="margin-top:10px">
          <button class="btn btn-green" id="addVale" style="flex:1 1 160px">Salvar</button>
          <button class="btn btn-ghost" id="cancelarEditVale" style="flex:1 1 160px;display:none">Cancelar edição</button>
          <button class="btn btn-ghost" id="clearVale" style="flex:1 1 160px">Limpar</button>
        </div>

        <h3 style="margin-top:12px;font-size:1rem;color:var(--primary)">Lista de Vales</h3>
        <ul id="listaVales"></ul>
      </section>
    </div>

    <!-- Resumo -->
    <section class="card" style="text-align:center">
      <h2>Resumo Visual</h2>
      <canvas id="chartResumo" width="420" height="280"></canvas>
      <p id="saldoTexto" style="margin-top:6px;font-weight:700"></p>
    </section>

    <!-- Ações -->
    <section class="card" style="text-align:center">
      <div class="row" style="justify-content:center">
        <button class="btn btn-green" id="gerarPDF" style="flex:0 0 200px">Gerar PDF</button>
        <button class="btn btn-ghost" id="exportExcel" style="flex:0 0 200px">Exportar Excel</button>
        <button class="btn btn-red" id="clearAll" style="flex:0 0 200px">Apagar TODOS</button>
      </div>
    </section>

  </main>

  <footer>© 2025 Motorista Plus</footer>
<script type="module">
/* ====================== FIREBASE ====================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import {
  getFirestore, doc, getDoc, addDoc, updateDoc, deleteDoc,
  collection, query, orderBy, onSnapshot, getDocs, serverTimestamp
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyCnlpnTTJvJPZxuZdmpKQWbbHtvH72nMUU",
  authDomain: "motorista-plus-c53f4.firebaseapp.com",
  projectId: "motorista-plus-c53f4",
  storageBucket: "motorista-plus-c53f4.firebasestorage.app",
  messagingSenderId: "766097061342",
  appId: "1:766097061342:web:36d999bec6d9fe8c46994f",
  measurementId: "G-CBT2D0CXPN"
});

const auth = getAuth(app);
const db   = getFirestore(app);

/* ====================== VARIÁVEIS ====================== */
const $ = (id)=>document.getElementById(id);
const DIARIA_VALOR = 4.28;

let uid = null;
let perfil = null;
let gastos = [];
let vales  = [];
let editGastoId = null;
let editValeId  = null;
let totalDiarias = 0;
let chart = null;

/* ====================== PERFIL ====================== */
async function carregarPerfil(){
  const snap = await getDoc(doc(db,"usuarios",uid));
  if(!snap.exists()) return;
  perfil = snap.data();

  $("dadosUsuario").innerHTML = `
    <div><b>Motorista:</b> ${perfil.nome}</div>
    <div><b>Cavalo:</b> ${perfil.placaCavalo}</div>
    <div><b>Reboque:</b> ${perfil.placaReboque}</div>
    <div><b>Email:</b> ${perfil.email}</div>
    <div><b>Telefone:</b> ${perfil.telefone}</div>
  `;
}

/* ====================== STREAM EM TEMPO REAL ====================== */
function iniciarStreams(){

  // GASTOS
  const qG = query(collection(db,"usuarios",uid,"gastos"), orderBy("criadoEm","desc"));
  onSnapshot(qG, snap=>{
    gastos = snap.docs.map(d=> {
      const x = d.data();
      return {
        id: d.id,
        date: x.date,
        motivo: x.motivo,
        local:  x.local,
        valor:  Number(x.valor),
        aut:    x.aut
      };
    });
    renderGastos();
    atualizarResumo();
  });

  // VALES
  const qV = query(collection(db,"usuarios",uid,"vales"), orderBy("criadoEm","desc"));
  onSnapshot(qV, snap=>{
    vales = snap.docs.map(d=>{
      const x = d.data();
      return {
        id: d.id,
        date: x.date,
        motivo: x.motivo,
        valor: Number(x.valor)
      };
    });
    renderVales();
    atualizarResumo();
  });

}

/* ====================== LISTA DE GASTOS ====================== */
function renderGastos(){
  const ul = $("listaGastos");
  if(gastos.length === 0){
    ul.innerHTML = '<li class="tag">(nenhum gasto registrado)</li>';
    return;
  }

  ul.innerHTML = gastos.map(g=>`
    <li>
      <div style="flex:1">
        <div><b>${g.motivo}</b> — ${g.local}</div>
        <div class="tag">${g.date} — Aut.: ${g.aut}</div>
      </div>
      <div style="font-weight:700">R$ ${g.valor.toFixed(2)}</div>

      <div class="row-actions">
        <button class="btn" data-edit-gasto="${g.id}">Editar</button>
        <button class="btn-red" data-del-gasto="${g.id}">Remover</button>
      </div>
    </li>
  `).join("");

  // Eventos
  ul.querySelectorAll("[data-edit-gasto]").forEach(btn=>{
    btn.onclick = ()=>{
      const g = gastos.find(x=>x.id === btn.dataset.editGasto);
      if(!g) return;

      $("gastoDate").value   = g.date;
      $("gastoMotivo").value = g.motivo;
      $("gastoLocal").value  = g.local;
      $("gastoValor").value  = g.valor;
      $("gastoAut").value    = g.aut;

      editGastoId = g.id;
      $("cancelarEditGasto").style.display = "inline-block";
    };
  });

  ul.querySelectorAll("[data-del-gasto]").forEach(btn=>{
    btn.onclick = async ()=>{
      if(!confirm("Remover gasto?")) return;
      await deleteDoc(doc(db,"usuarios",uid,"gastos",btn.dataset.delGasto));
    };
  });
}

/* ====================== LISTA DE VALES ====================== */
function renderVales(){
  const ul = $("listaVales");
  if(vales.length === 0){
    ul.innerHTML = '<li class="tag">(nenhum vale registrado)</li>';
    return;
  }

  ul.innerHTML = vales.map(v=>`
    <li>
      <div style="flex:1">
        <div><b>${v.motivo || "-"}</b></div>
        <div class="tag">${v.date}</div>
      </div>
      <div style="font-weight:700">R$ ${v.valor.toFixed(2)}</div>

      <div class="row-actions">
        <button class="btn" data-edit-vale="${v.id}">Editar</button>
        <button class="btn-red" data-del-vale="${v.id}">Remover</button>
      </div>
    </li>
  `).join("");

  ul.querySelectorAll("[data-edit-vale]").forEach(btn=>{
    btn.onclick = ()=>{
      const v = vales.find(x=>x.id === btn.dataset.editVale);
      if(!v) return;

      $("valeDate").value   = v.date;
      $("valeMotivo").value = v.motivo;
      $("valeValor").value  = v.valor;

      editValeId = v.id;
      $("cancelarEditVale").style.display = "inline-block";
    };
  });

  ul.querySelectorAll("[data-del-vale]").forEach(btn=>{
    btn.onclick = async ()=>{
      if(!confirm("Remover vale?")) return;
      await deleteDoc(doc(db,"usuarios",uid,"vales",btn.dataset.delVale));
    };
  });
}

/* ====================== ADICIONAR / EDITAR GASTO ====================== */
$("addGasto").onclick = async ()=>{
  const d = $("gastoDate").value;
  const m = $("gastoMotivo").value.trim();
  const l = $("gastoLocal").value.trim();
  const v = Number($("gastoValor").value);
  const a = $("gastoAut").value;

  if(!d || !m || !l || v<=0){
    alert("Preencha todos os campos."); 
    return;
  }

  const payload = { date:d, motivo:m, local:l, valor:v, aut:a, criadoEm: serverTimestamp() };

  if(editGastoId){
    await updateDoc(doc(db,"usuarios",uid,"gastos",editGastoId), payload);
    editGastoId = null;
    $("cancelarEditGasto").style.display = "none";
  }else{
    await addDoc(collection(db,"usuarios",uid,"gastos"), payload);
  }

  $("gastoDate").value = "";
  $("gastoMotivo").value = "";
  $("gastoLocal").value  = "";
  $("gastoValor").value  = "";
  $("gastoAut").value    = "Francisco";
};

$("cancelarEditGasto").onclick = ()=>{
  editGastoId = null;
  $("cancelarEditGasto").style.display = "none";
};

/* ====================== ADICIONAR / EDITAR VALE ====================== */
$("addVale").onclick = async ()=>{
  const d = $("valeDate").value;
  const m = $("valeMotivo").value.trim();
  const v = Number($("valeValor").value);

  if(!d || v<=0){
    alert("Preencha todos os campos."); 
    return;
  }

  const payload = { date:d, motivo:m, valor:v, criadoEm: serverTimestamp() };

  if(editValeId){
    await updateDoc(doc(db,"usuarios",uid,"vales",editValeId), payload);
    editValeId = null;
    $("cancelarEditVale").style.display = "none";
  }else{
    await addDoc(collection(db,"usuarios",uid,"vales"), payload);
  }

  $("valeDate").value = "";
  $("valeMotivo").value = "";
  $("valeValor").value = "";
};

$("cancelarEditVale").onclick = ()=>{
  editValeId = null;
  $("cancelarEditVale").style.display = "none";
};

/* ====================== CALCULAR DIÁRIAS ====================== */
$("calcDiarias").onclick = ()=>{
  const s = $("tripStart").value;
  const e = $("tripEnd").value;
  if(!s || !e || new Date(e) < new Date(s)){
    alert("Datas inválidas.");
    return;
  }
  totalDiarias = Math.floor((new Date(e) - new Date(s)) / 86400000) + 1;
  atualizarResumo();
};

$("clearDiarias").onclick = ()=>{
  totalDiarias = 0;
  $("tripStart").value = "";
  $("tripEnd").value = "";
  atualizarResumo();
};

/* ====================== RESUMO + SALDO ====================== */
function atualizarResumo(){
  const bonus = totalDiarias * DIARIA_VALOR;
  const totalG = gastos.reduce((s,g)=> s + Number(g.valor), 0);
  const totalV = vales.reduce((s,v)=> s + Number(v.valor), 0);
  const base   = bonus + totalG;

  const empresaDeve = base > totalV;
  const diff = Math.abs(base - totalV).toFixed(2);

  $("totalDiariasText").textContent =
    `Total de diárias: ${totalDiarias} — Valor total: R$ ${bonus.toFixed(2)}`;

  $("saldoTexto").textContent = empresaDeve
    ? `A empresa deve ao motorista R$ ${diff}`
    : `O motorista deve à empresa R$ ${diff}`;

  const ctx = $("chartResumo").getContext("2d");
  if(chart) chart.destroy();

  chart = new Chart(ctx, {
    type:"pie",
    data:{
      labels:["Bônus","Gastos","Vales"],
      datasets:[{ data:[bonus,totalG,totalV] }]
    }
  });
}

/* ====================== PDF ====================== */
$("gerarPDF").onclick = ()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"pt", format:"a4" });

  let y = 40;

  doc.setFontSize(16);
  doc.text("Relatório Financeiro — Motorista Plus", 40, y); 
  y+=30;

  doc.setFontSize(11);
  doc.text(`Motorista: ${perfil.nome}`, 40, y); y+=18;
  doc.text(`Cavalo: ${perfil.placaCavalo}`, 40, y); y+=18;
  doc.text(`Reboque: ${perfil.placaReboque}`, 40, y); y+=18;
  doc.text(`Email: ${perfil.email}`, 40, y); y+=25;

  const bonus = totalDiarias * DIARIA_VALOR;
  const totalG = gastos.reduce((s,g)=> s + Number(g.valor), 0);
  const totalV = vales.reduce((s,v)=> s + Number(v.valor), 0);
  const base   = bonus + totalG;
  const diff   = Math.abs(base-totalV).toFixed(2);
  const empresaDeve = base > totalV;

  doc.text(`Total de diárias: ${totalDiarias} — R$ ${bonus.toFixed(2)}`, 40, y);
  y+=25;

  doc.setFontSize(13);
  doc.text("Gastos:", 40, y); 
  y+=15;
  doc.setFontSize(11);

  if(gastos.length === 0){
    doc.text("Nenhum gasto registrado.", 40, y);
    y+=20;
  }else{
    gastos.forEach(g=>{
      doc.text(`${g.date} — ${g.motivo} (${g.local}) — R$ ${g.valor.toFixed(2)} — Aut.: ${g.aut}`, 40, y);
      y+=18;
    });
  }

  y+=20;
  doc.setFontSize(13);
  doc.text("Vales:", 40, y); 
  y+=15;
  doc.setFontSize(11);

  if(vales.length === 0){
    doc.text("Nenhum vale registrado.", 40, y);
    y+=20;
  }else{
    vales.forEach(v=>{
      doc.text(`${v.date} — ${v.motivo} — R$ ${v.valor.toFixed(2)}`, 40, y);
      y+=18;
    });
  }

  y+=30;
  doc.setFontSize(14);
  doc.text(
    empresaDeve
      ? `A EMPRESA DEVE AO MOTORISTA: R$ ${diff}`
      : `O MOTORISTA DEVE À EMPRESA: R$ ${diff}`,
    40, y
  );

  doc.save("financas_motorista.pdf");
};

/* ====================== EXCEL ====================== */
$("exportExcel").onclick = ()=>{
  const bonus = totalDiarias * DIARIA_VALOR;
  const totalG = gastos.reduce((s,g)=> s + Number(g.valor), 0);
  const totalV = vales.reduce((s,v)=> s + Number(v.valor), 0);
  const base   = bonus + totalG;
  const diff   = Math.abs(base - totalV).toFixed(2);

  const empresaDeve = base > totalV;

  const data = [
    ["Relatório Financeiro — Motorista Plus"],
    [],
    ["Motorista", perfil.nome],
    ["Cavalo", perfil.placaCavalo],
    ["Reboque", perfil.placaReboque],
    ["Email", perfil.email],
    [],
    ["Tipo","Data","Descrição","Valor (R$)"],
    ["Bônus", "", `${totalDiarias} diárias`, bonus.toFixed(2)],
    ...gastos.map(g=>["Gasto", g.date, `${g.motivo} / ${g.local}`, g.valor.toFixed(2)]),
    ...vales.map(v=>["Vale",  v.date, v.motivo, v.valor.toFixed(2)]),
    [],
    ["Saldo Final:", "", empresaDeve ? "Empresa deve ao motorista" : "Motorista deve à empresa", diff]
  ];

  const ws = XLSX.utils.aoa_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Resumo");

  XLSX.writeFile(wb, "financas_motorista.xlsx");
};

/* ====================== APAGAR TUDO ====================== */
$("clearAll").onclick = async ()=>{
  if(!confirm("Excluir TODOS os dados?")) return;

  const gs = await getDocs(collection(db,"usuarios",uid,"gastos"));
  const vs = await getDocs(collection(db,"usuarios",uid,"vales"));

  const jobs = [];
  gs.forEach(d=> jobs.push(deleteDoc(d.ref)));
  vs.forEach(d=> jobs.push(deleteDoc(d.ref)));

  await Promise.all(jobs);
};

/* ====================== AUTH ====================== */
onAuthStateChanged(auth, async(user)=>{
  if(!user){
    window.location.href = "login.html";
    return;
  }
  uid = user.uid;
  await carregarPerfil();
  iniciarStreams();
  atualizarResumo();
});
</script>
</body>
</html>