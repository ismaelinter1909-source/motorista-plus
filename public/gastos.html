<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gastos & Diárias — Motorista Plus</title>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root{
  --bg:#0b0f14; --bg2:#10161d; --card:#161c23;
  --primary:#f39220; --primary-700:#d47e16;
  --outline:#2b3a49; --text:#fff; --muted:#b5bcc7;
  --green:#2b9348; --red:#dc3545; --info:#0077b6;
}

*{
  box-sizing:border-box;
  margin:0;
  padding:0;
  font-family:system-ui,Arial,sans-serif
}

body{
  background:var(--bg);
  color:var(--text);
  min-height:100vh;
  display:flex;
  flex-direction:column;
  overflow-x:hidden;
}

/* BOTÃO VOLTAR */
#voltarPainelTopo{
  position:fixed; top:12px; left:12px; z-index:9999;
  padding:8px 14px;
  width: auto;
  background:rgba(255,255,255,.08);
  color:#fff;
  border-radius:8px;
  border:1px solid rgba(255,255,255,.25);
  cursor:pointer;
  font-size:14px;
  backdrop-filter:blur(4px);
  transition:.3s ease;
}
#voltarPainelTopo:hover{
  background:rgba(255,255,255,.16)
}

/* HEADER */
header{
  background:linear-gradient(180deg,rgba(0,0,0,.3),rgba(0,0,0,.6));
  padding:28px 16px;
  text-align:center;
  border-bottom:1px solid var(--outline)
}
header h1{
  font-weight:800;
  font-size:clamp(20px,4vw,30px)
}
header .plus{ color:var(--primary); }

/* CONTEÚDO */
.wrap{
  width:94%;
  max-width:1100px;
  margin:18px auto;
  flex:1;
  display:grid;
  gap:14px;
}

/* CARD */
.card{
  background:var(--card);
  border:1px solid var(--outline);
  padding:16px;
  border-radius:12px;
  backdrop-filter:blur(6px);
}

/* DADOS DO MOTORISTA */
.dados{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
}
.dados div{
  min-width:160px;
  flex:1;
  background:rgba(255,255,255,.05);
  border:1px solid var(--outline);
  padding:10px;
  border-radius:10px;
}
.dados div b{
  color:var(--primary);
  display:block;
  margin-bottom:2px;
}

/* LABELS */
label{
  display:block;
  color:#e8e8e8;
  margin:6px 0 4px;
  font-size:13px;
}

/* INPUTS / SELECT / TEXTAREA / BUTTONS */
input,select,textarea,button{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid var(--outline);
  background:rgba(255,255,255,.08);
  color:#fff;
  font-size:15px;
  outline:none;
  transition:.25s;
}
input:focus,select:focus,textarea:focus{
  box-shadow:0 0 0 3px rgba(243,146,32,.15);
  border-color:var(--primary)
}

select{
  -webkit-appearance:none;
  -moz-appearance:none;
  appearance:none;
  background-image:
    linear-gradient(45deg,transparent 50%, #fff 50%),
    linear-gradient(135deg, #fff 50%, transparent 50%),
    linear-gradient(to right, transparent, transparent);
  background-position:
    calc(100% - 18px) calc(50% - 3px),
    calc(100% - 13px) calc(50% - 3px),
    calc(100% - 2.2em) 0.6em;
  background-size:5px 5px, 5px 5px, 1px 1.6em;
  background-repeat:no-repeat;
}

/* BOTÕES */
.btn{
  background:var(--primary);
  border:none;
  font-weight:700;
  cursor:pointer;
  color:#fff;
  transition:.25s;
}
.btn:hover{ background:var(--primary-700); transform:translateY(-1px); }
.btn:active{ transform:translateY(0) }

.btn-green{ background:var(--green); }
.btn-green:hover{ filter:brightness(1.05); }

.btn-red{ background:var(--red); }
.btn-red:hover{ filter:brightness(1.05); }

.btn-ghost{
  background:transparent;
  border:1px solid var(--outline);
  color:var(--muted);
}

/* GRID 2 (Gastos / Vales) */
.grid2{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:14px;
}

/* MOBILE — quebra para 1 coluna */
@media(max-width:900px){
  .grid2{
    grid-template-columns:1fr;
  }
}

/* LISTAS */
ul{
  list-style:none;
  padding-left:0;
  margin-top:8px;
  max-height:260px;
  overflow-y:auto;
}
li{
  background:rgba(255,255,255,.05);
  border:1px solid var(--outline);
  padding:12px;
  border-radius:10px;
  margin:6px 0;
  display:flex;
  flex-wrap:wrap;
  justify-content:space-between;
  align-items:center;
  gap:12px;
}
.tag{
  font-size:12px;
  color:var(--muted)
}
.row-actions{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
}

/* GRÁFICO */
canvas{
  display:block;
  margin:10px auto;
  max-width:100%;
}

/* FOOTER */
footer{
  padding:12px;
  text-align:center;
  color:var(--muted);
  border-top:1px solid var(--outline);
}

/* MELHORIA EXTRA PARA TELAS MENORES QUE 420px */
@media(max-width:420px){
  input,select,textarea{
    font-size:16px; /* evita zoom automático no iOS/Android */
  }
  li{
    flex-direction:column;
    align-items:flex-start;
  }
  .row-actions{
    width:100%;
    justify-content:space-between;
  }
  button{
    padding:14px;
  }
}
  </style>
</head>
<body>

  <button id="voltarPainelTopo" onclick="window.location.href='painel.html'">← Voltar</button>

  <header>
    <h1>Gastos & Diárias — Motorista<span class="plus">Plus</span></h1>
  </header>

  <main class="wrap">
    <!-- Dados do Motorista -->
    <section class="card">
      <h2>Dados do Motorista</h2>
      <div class="dados" id="dadosUsuario"></div>
    </section>

    <!-- Diárias -->
    <section class="card">
      <h2>Período da Viagem (diárias automáticas)</h2>
      <div class="row" style="margin-top:6px">
        <div style="flex:1 1 220px">
          <label for="tripStart">Data Início</label>
          <input type="date" id="tripStart">
        </div>
        <div style="flex:1 1 220px">
          <label for="tripEnd">Data Fim</label>
          <input type="date" id="tripEnd">
        </div>
        <div style="flex:0 0 180px;align-self:end">
          <button class="btn btn-green" id="calcDiarias">Calcular Diárias</button>
        </div>
        <div style="flex:0 0 180px;align-self:end">
          <button class="btn btn-ghost" id="clearDiarias">Limpar Diárias</button>
        </div>
      </div>
      <p id="totalDiariasText" class="tag" style="margin-top:8px">Total de diárias: 0 — Valor total: R$ 0,00</p>
    </section>

    <!-- GASTOS + VALES -->
    <div class="grid2">
      <!-- Gastos -->
      <section class="card">
        <h2>Registrar Gasto</h2>
        <label for="gastoDate">Data</label>
        <input type="date" id="gastoDate">

        <label for="gastoMotivo">Motivo</label>
        <input id="gastoMotivo" placeholder="Ex: Almoço, Pedágio">

        <label for="gastoLocal">Local</label>
        <input id="gastoLocal" placeholder="Ex: Posto X">

        <label for="gastoValor">Valor (R$)</label>
        <input id="gastoValor" type="number" step="0.01" min="0">

        <label for="gastoAut">Autorização</label>
        <select id="gastoAut">
          <option value="Francisco">Francisco</option>
          <option value="Vinicios">Vinicios</option>
          <option value="Jeferson">Jeferson</option>
          <option value="Daniel">Daniel</option>
          <option value="William">William</option>
          <option value="Douglas">Douglas</option>
          <option value="Valdir">Valdir</option>
          <option value="Outro">Outro</option>
        </select>

        <div class="row" style="margin-top:10px">
          <button class="btn btn-green" id="addGasto" style="flex:1 1 160px">Salvar</button>
          <button class="btn btn-ghost" id="cancelarEditGasto" style="flex:1 1 160px;display:none">Cancelar edição</button>
          <button class="btn btn-ghost" id="clearGasto" style="flex:1 1 160px">Limpar</button>
        </div>

        <h3 style="margin-top:12px;font-size:1rem;color:var(--primary)">Lista de Gastos</h3>
        <ul id="listaGastos"></ul>
      </section>

      <!-- Vales -->
      <section class="card">
        <h2>Retirada de Vales</h2>

        <label for="valeDate">Data</label>
        <input id="valeDate" type="date">

        <label for="valeMotivo">Descrição</label>
        <input id="valeMotivo" placeholder="Ex: Vale refeição, adiantamento...">

        <label for="valeValor">Valor (R$)</label>
        <input id="valeValor" type="number" step="0.01" min="0">

        <div class="row" style="margin-top:10px">
          <button class="btn btn-green" id="addVale" style="flex:1 1 160px">Salvar</button>
          <button class="btn btn-ghost" id="cancelarEditVale" style="flex:1 1 160px;display:none">Cancelar edição</button>
          <button class="btn btn-ghost" id="clearVale" style="flex:1 1 160px">Limpar</button>
        </div>

        <h3 style="margin-top:12px;font-size:1rem;color:var(--primary)">Lista de Vales</h3>
        <ul id="listaVales"></ul>
      </section>
    </div>

    <!-- Resumo -->
    <section class="card" style="text-align:center">
      <h2>Resumo Visual</h2>
      <canvas id="chartResumo" width="420" height="280"></canvas>
      <p id="saldoTexto" style="margin-top:6px;font-weight:700"></p>
    </section>

    <!-- Ações -->
    <section class="card" style="text-align:center">
      <div class="row" style="justify-content:center">
        <button class="btn btn-green" id="gerarPDF" style="flex:0 0 200px">Gerar PDF</button>
        <button class="btn btn-ghost" id="exportExcel" style="flex:0 0 200px">Exportar Excel</button>
        <button class="btn btn-red" id="clearAll" style="flex:0 0 200px">Apagar TODOS</button>
      </div>
    </section>

  </main>

  <footer>© 2025 Motorista Plus</footer>
<!-- SCRIPT COMPLETO -->
<script type="module">
  /* ================= Firebase (motorista-plus-c53f4) ================= */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getFirestore, doc, getDoc,
    collection, addDoc, updateDoc, deleteDoc,
    query, orderBy, onSnapshot, getDocs, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const app = initializeApp({
    apiKey: "AIzaSyCnlpnTTJvJPZxuZdmpKQWbbHtvH72nMUU",
    authDomain: "motorista-plus-c53f4.firebaseapp.com",
    projectId: "motorista-plus-c53f4",
    storageBucket: "motorista-plus-c53f4.firebasestorage.app",
    messagingSenderId: "766097061342",
    appId: "1:766097061342:web:36d999bec6d9fe8c46994f",
    measurementId: "G-CBT2D0CXPN"
  });

  const auth = getAuth(app);
  const db   = getFirestore(app);

  /* ================= Constantes/UI ================= */
  const $ = (id)=>document.getElementById(id);
  const DIARIA_VALOR = 4.28; // mantém seu valor atual nessa página
  let totalDiarias = 0;      // persiste via localStorage

  let uid = null;
  let perfil = null;
  let gastos = [];
  let vales  = [];
  let editGastoId = null;
  let editValeId  = null;
  let chart = null;

  const fmtBR = (isoLike)=>{
    const d = new Date(isoLike);
    if(isNaN(d)) return "";
    return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()}`;
  };
  const onlyISO = (d)=> new Date(d).toISOString().slice(0,10);
  const inRange = (dateStr, startISO, endISO)=>{
    if(!dateStr) return false;
    const x = dateStr;
    const s = startISO || "0000-01-01";
    const e = endISO   || "9999-12-31";
    return (x >= s && x <= e);
  };

  const lsKey = (suffix)=> `mp:${uid}:${suffix}`;
  const saveLocal = (k,v)=> localStorage.setItem(k, JSON.stringify(v));
  const loadLocal = (k, def=null)=>{
    try{ const v = JSON.parse(localStorage.getItem(k)); return v ?? def; }catch{ return def; }
  };
  const removeLocal = (k)=> localStorage.removeItem(k);

  /* ================= Cria inputs de resumo (Bônus+Gastos / Vales) ================= */
  function ensureResumoInputs(){
    const host = document.querySelector('#chartResumo')?.parentElement;
    if(!host) return;
    if(!document.getElementById('inpTotalBonusGastos')){
      const i1 = document.createElement('input');
      i1.id = 'inpTotalBonusGastos';
      i1.readOnly = true;
      i1.style.margin = '8px auto';
      i1.style.maxWidth = '360px';
      i1.placeholder = 'Bônus + Gastos';
      host.appendChild(i1);
    }
    if(!document.getElementById('inpTotalVales')){
      const i2 = document.createElement('input');
      i2.id = 'inpTotalVales';
      i2.readOnly = true;
      i2.style.margin = '8px auto';
      i2.style.maxWidth = '360px';
      i2.placeholder = 'Total de Vales';
      host.appendChild(i2);
    }
  }

  /* ================= Perfil ================= */
  async function carregarPerfil(){
    const snap = await getDoc(doc(db,"usuarios", uid));
    if(!snap.exists()) return;
    perfil = snap.data();
    $('dadosUsuario').innerHTML = `
      <div><b>Motorista:</b> ${perfil.nome || '—'}</div>
      <div><b>Cavalo:</b> ${perfil.placaCavalo || '—'}</div>
      <div><b>Reboque:</b> ${perfil.placaReboque || '—'}</div>
      <div><b>Email:</b> ${perfil.email || '—'}</div>
      <div><b>Telefone:</b> ${perfil.telefone || '—'}</div>
    `;
  }

  /* ================= Streams (tempo real) ================= */
  function iniciarStreams(){
    // gastos
    const qG = query(collection(db,"usuarios",uid,"gastos"), orderBy("criadoEm","desc"));
    onSnapshot(qG, (snap)=>{
      gastos = snap.docs.map(d=>{
        const x = d.data();
        return {
          id:d.id,
          date: (typeof x.date==='string')? x.date : (x.date?.toDate?.()? x.date.toDate().toISOString().slice(0,10):""),
          motivo: x.motivo||"",
          local:  x.local||"",
          valor:  Number(x.valor||0),
          aut:    x.aut||""
        };
      });
      renderGastos();
      atualizarResumo();
    });

    // vales
    const qV = query(collection(db,"usuarios",uid,"vales"), orderBy("criadoEm","desc"));
    onSnapshot(qV, (snap)=>{
      vales = snap.docs.map(d=>{
        const x = d.data();
        return {
          id:d.id,
          date: (typeof x.date==='string')? x.date : (x.date?.toDate?.()? x.date.toDate().toISOString().slice(0,10):""),
          motivo: x.motivo||"",
          valor:  Number(x.valor||0)
        };
      });
      renderVales();
      atualizarResumo();
    });
  }

  /* ================= Render Listas ================= */
  function bindRowButtons(listElem, tipo){
    listElem.querySelectorAll('button').forEach(b=>{
      b.onclick = async ()=>{
        const id  = b.dataset.id;
        const act = b.dataset.act;
        if(tipo==='g'){
          if(act==='edit'){
            const g = gastos.find(x=>x.id===id);
            if(!g) return;
            $('gastoDate').value   = g.date;
            $('gastoMotivo').value = g.motivo;
            $('gastoLocal').value  = g.local;
            $('gastoValor').value  = g.valor;
            $('gastoAut').value    = g.aut || 'Francisco';
            editGastoId = id;
            $('cancelarEditGasto').style.display = 'inline-block';
          }else if(act==='del'){
            if(!confirm('Remover este gasto?')) return;
            await deleteDoc(doc(db,"usuarios",uid,"gastos",id));
          }
        }else if(tipo==='v'){
          if(act==='edit'){
            const v = vales.find(x=>x.id===id);
            if(!v) return;
            $('valeDate').value   = v.date;
            $('valeMotivo').value = v.motivo || '';
            $('valeValor').value  = v.valor;
            editValeId = id;
            $('cancelarEditVale').style.display = 'inline-block';
          }else if(act==='del'){
            if(!confirm('Remover este vale?')) return;
            await deleteDoc(doc(db,"usuarios",uid,"vales",id));
          }
        }
      };
    });
  }

  function renderGastos(){
    const ul = $('listaGastos');
    if(!gastos.length){ ul.innerHTML = '<li class="tag">(nenhum)</li>'; return; }
    ul.innerHTML = gastos.map(g=>`
      <li>
        <div style="flex:1;min-width:240px">
          <div style="font-weight:700">Gasto — ${fmtBR(g.date)}</div>
          <div class="tag">${g.motivo} / ${g.local} — Aut.: ${g.aut}</div>
        </div>
        <div style="display:flex;align-items:center;gap:10px">
          <div style="font-weight:700">R$ ${g.valor.toFixed(2)}</div>
          <div class="row-actions">
            <button class="btn" data-type="g" data-act="edit" data-id="${g.id}">Editar</button>
            <button class="btn-red" data-type="g" data-act="del" data-id="${g.id}">Remover</button>
          </div>
        </div>
      </li>
    `).join('');
    bindRowButtons(ul, 'g');
  }

  function renderVales(){
    const ul = $('listaVales');
    if(!vales.length){ ul.innerHTML = '<li class="tag">(nenhum)</li>'; return; }
    ul.innerHTML = vales.map(v=>`
      <li>
        <div style="flex:1;min-width:240px">
          <div style="font-weight:700">Vale — ${fmtBR(v.date)}</div>
          <div class="tag">${v.motivo || '—'}</div>
        </div>
        <div style="display:flex;align-items:center;gap:10px">
          <div style="font-weight:700">R$ ${v.valor.toFixed(2)}</div>
          <div class="row-actions">
            <button class="btn" data-type="v" data-act="edit" data-id="${v.id}">Editar</button>
            <button class="btn-red" data-type="v" data-act="del" data-id="${v.id}">Remover</button>
          </div>
        </div>
      </li>
    `).join('');
    bindRowButtons(ul, 'v');
  }

  /* ================= Resumo / Gráfico (mantendo sua lógica) ================= */
  function atualizarResumo(){
    ensureResumoInputs();

    const bonus = +(totalDiarias * DIARIA_VALOR).toFixed(2);
    const totalG = +gastos.reduce((s,g)=>s + (Number(g.valor)||0), 0).toFixed(2);
    const totalV = +vales.reduce((s,v)=>s + (Number(v.valor)||0), 0).toFixed(2);

    $('totalDiariasText').textContent =
      `Total de diárias: ${totalDiarias} — Valor total: R$ ${bonus.toFixed(2)}`;

    const somaBG = bonus + totalG;
    const diff   = Math.abs(somaBG - totalV).toFixed(2);
    const valesMaior = totalV > somaBG;

    $('saldoTexto').textContent = valesMaior
      ? `Saldo: O motorista deve à empresa R$ ${diff}`
      : `Saldo: A empresa deve ao motorista R$ ${diff}`;

    // atualiza inputs extras
    const iBG = document.getElementById('inpTotalBonusGastos');
    const iV  = document.getElementById('inpTotalVales');
    if(iBG) iBG.value = `Bônus + Gastos: R$ ${(somaBG).toFixed(2)}`;
    if(iV)  iV.value  = `Vales: R$ ${totalV.toFixed(2)}`;

    // gráfico
    const ctx = $('chartResumo').getContext('2d');
    if(chart) chart.destroy();
    chart = new Chart(ctx, {
      type:'pie',
      data:{ labels:['Bônus','Gastos','Vales'], datasets:[{ data:[bonus,totalG,totalV] }] },
      options:{ plugins:{ legend:{ position:'bottom' } } }
    });
  }

  /* ================= Diárias (persistentes) ================= */
  function loadDiariasFromLocal(){
    const t = loadLocal(lsKey('totalDiarias'), 0);
    const s = loadLocal(lsKey('tripStart'), '');
    const e = loadLocal(lsKey('tripEnd'), '');
    totalDiarias = Number(t)||0;
    if(s) $('tripStart').value = s;
    if(e) $('tripEnd').value   = e;
  }
  function saveDiariasToLocal(){
    saveLocal(lsKey('totalDiarias'), totalDiarias);
    saveLocal(lsKey('tripStart'), $('tripStart').value || '');
    saveLocal(lsKey('tripEnd'),   $('tripEnd').value   || '');
  }
  function clearDiariasLocal(){
    totalDiarias = 0;
    removeLocal(lsKey('totalDiarias'));
    removeLocal(lsKey('tripStart'));
    removeLocal(lsKey('tripEnd'));
  }

  $('calcDiarias').onclick = ()=>{
    const s = $('tripStart').value;
    const e = $('tripEnd').value;
    if(!s || !e || new Date(e) < new Date(s)){
      alert('Selecione datas válidas.'); return;
    }
    totalDiarias = Math.floor((new Date(e)-new Date(s))/(1000*60*60*24)) + 1;
    saveDiariasToLocal();
    atualizarResumo();
  };

  $('clearDiarias').onclick = ()=>{
    $('tripStart').value = '';
    $('tripEnd').value   = '';
    clearDiariasLocal();
    $('totalDiariasText').textContent = 'Total de diárias: 0 — Valor total: R$ 0,00';
    atualizarResumo();
  };

  /* ================= CRUD GASTOS ================= */
  $('addGasto').onclick = async ()=>{
    const d = $('gastoDate').value;
    const m = $('gastoMotivo').value.trim();
    const l = $('gastoLocal').value.trim();
    const v = parseFloat($('gastoValor').value || 0);
    const a = $('gastoAut').value;

    if(!d || !m || !l || !(v>0)){
      alert('Preencha todos os campos e valor > 0'); return;
    }

    const payload = { date:d, motivo:m, local:l, valor:v, aut:a, criadoEm:serverTimestamp() };

    if(editGastoId){
      await updateDoc(doc(db,"usuarios",uid,"gastos",editGastoId), payload);
      editGastoId = null;
      $('cancelarEditGasto').style.display = 'none';
    }else{
      await addDoc(collection(db,"usuarios",uid,"gastos"), payload);
    }

    $('gastoDate').value = '';
    $('gastoMotivo').value = '';
    $('gastoLocal').value = '';
    $('gastoValor').value = '';
    $('gastoAut').value   = 'Francisco';
  };

  $('cancelarEditGasto').onclick = ()=>{
    editGastoId = null;
    $('cancelarEditGasto').style.display = 'none';
    $('gastoDate').value = $('gastoMotivo').value = $('gastoLocal').value = $('gastoValor').value = '';
    $('gastoAut').value = 'Francisco';
  };

  $('clearGasto').onclick = ()=>{
    $('gastoDate').value = $('gastoMotivo').value = $('gastoLocal').value = $('gastoValor').value = '';
    $('gastoAut').value = 'Francisco';
  };

  /* ================= CRUD VALES ================= */
  $('addVale').onclick = async ()=>{
    const d = $('valeDate').value;
    const v = parseFloat($('valeValor').value || 0);
    const m = $('valeMotivo').value.trim();

    if(!d || !(v>0)){
      alert('Preencha data e valor > 0'); return;
    }

    const payload = { date:d, motivo:m, valor:v, criadoEm:serverTimestamp() };

    if(editValeId){
      await updateDoc(doc(db,"usuarios",uid,"vales",editValeId), payload);
      editValeId = null;
      $('cancelarEditVale').style.display = 'none';
    }else{
      await addDoc(collection(db,"usuarios",uid,"vales"), payload);
    }

    $('valeDate').value = '';
    $('valeValor').value = '';
    $('valeMotivo').value = '';
  };

  $('cancelarEditVale').onclick = ()=>{
    editValeId = null;
    $('cancelarEditVale').style.display = 'none';
    $('valeDate').value = $('valeValor').value = $('valeMotivo').value = '';
  };

  $('clearVale').onclick = ()=>{
    $('valeDate').value = $('valeValor').value = $('valeMotivo').value = '';
  };

  /* ================= PDF (sem logo) ================= */
  $('gerarPDF').onclick = ()=>{
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:'pt', format:'a4' });

    const startX = 40;
    let y = 44;

    // Cabeçalho
    doc.setFontSize(16);
    doc.text('Relatório — Gastos & Diárias', startX, y);
    y += 22;

    // Período (usa as datas das diárias)
    const s = $('tripStart').value ? onlyISO($('tripStart').value) : '';
    const e = $('tripEnd').value   ? onlyISO($('tripEnd').value)   : '';
    const periodoTxt = (s && e) ? `${fmtBR(s)} a ${fmtBR(e)}` : 'Sem período definido';
    doc.setFontSize(11);
    doc.text(`Período: ${periodoTxt}`, startX, y); y += 16;

    // Dados do motorista
    doc.text(`Motorista: ${perfil?.nome || '—'}`, startX, y);
    doc.text(`Placas: ${perfil?.placaCavalo || '—'} / ${perfil?.placaReboque || '—'}`, startX+260, y); y += 16;
    doc.text(`E-mail: ${perfil?.email || '—'}`, startX, y);
    doc.text(`Telefone: ${perfil?.telefone || '—'}`, startX+260, y); y += 22;

    // Totais
    const bonus = +(totalDiarias * DIARIA_VALOR).toFixed(2);
    const totalG = +gastos.reduce((s2,g)=>s2 + (Number(g.valor)||0), 0).toFixed(2);
    const totalV = +vales.reduce((s2,v)=>s2 + (Number(v.valor)||0), 0).toFixed(2);
    const somaBG = bonus + totalG;
    const diff   = Math.abs(somaBG - totalV).toFixed(2);
    const valesMaior = totalV > somaBG;

    doc.text(`Diárias: ${totalDiarias} × R$ ${DIARIA_VALOR.toFixed(2)} = R$ ${bonus.toFixed(2)}`, startX, y); y += 16;
    doc.text(`Total Gastos: R$ ${totalG.toFixed(2)}`, startX, y); y += 16;
    doc.text(`Total Vales: R$ ${totalV.toFixed(2)}`, startX, y); y += 16;
    doc.text(valesMaior
      ? `Saldo: O motorista deve à empresa R$ ${diff}`
      : `Saldo: A empresa deve ao motorista R$ ${diff}`, startX, y); y += 22;

    // Listas (filtradas pelo período, se houver)
    const sISO = s || "0000-01-01";
    const eISO = e || "9999-12-31";

    // Gastos
    doc.setFontSize(12); doc.text('Gastos', startX, y); y += 14;
    doc.setFontSize(10);
    const gFiltrados = gastos.filter(g=> inRange(g.date, sISO, eISO));
    if(!gFiltrados.length){ doc.text('(nenhum)', startX, y); y += 14; }
    else{
      gFiltrados.forEach(g=>{
        const linha = `${fmtBR(g.date)} — ${g.motivo} / ${g.local} — Aut.: ${g.aut} — R$ ${g.valor.toFixed(2)}`;
        doc.text(linha, startX, y); y += 14;
      });
    }
    y += 10;

    // Vales
    doc.setFontSize(12); doc.text('Vales', startX, y); y += 14;
    doc.setFontSize(10);
    const vFiltrados = vales.filter(v=> inRange(v.date, sISO, eISO));
    if(!vFiltrados.length){ doc.text('(nenhum)', startX, y); y += 14; }
    else{
      vFiltrados.forEach(v=>{
        const linha = `${fmtBR(v.date)} — ${v.motivo || '—'} — R$ ${v.valor.toFixed(2)}`;
        doc.text(linha, startX, y); y += 14;
      });
    }

    doc.save('gastos_diarias.pdf');
  };

  /* ================= Apagar TODOS ================= */
  $('clearAll').onclick = async ()=>{
    if(!confirm('Excluir TODOS os gastos e vales?')) return;
    const gs = await getDocs(collection(db,"usuarios",uid,"gastos"));
    const vs = await getDocs(collection(db,"usuarios",uid,"vales"));
    const jobs = [];
    gs.forEach(d=> jobs.push(deleteDoc(d.ref)));
    vs.forEach(d=> jobs.push(deleteDoc(d.ref)));
    await Promise.all(jobs);
  };

  /* ================= Auth ================= */
  onAuthStateChanged(auth, async (user)=>{
    if(!user){ window.location.href='login.html'; return; }
    uid = user.uid;

    loadDiariasFromLocal();     // restaura diárias e período
    ensureResumoInputs();       // garante inputs extras

    await carregarPerfil();
    iniciarStreams();           // popula gastos/vales em tempo real
    atualizarResumo();          // calcula com o que já tem carregado
  });
</script>
</body>
</html>