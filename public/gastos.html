<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gastos & Diárias — Motorista Plus</title>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#0b0f14; --bg2:#10161d; --card:#161c23;
      --primary:#f39220; --primary-700:#d47e16;
      --outline:#2b3a49; --text:#fff; --muted:#b5bcc7;
      --green:#2b9348; --red:#dc3545; --info:#0077b6;
    }
    *{ box-sizing:border-box; margin:0; padding:0; font-family:system-ui,Arial,sans-serif }

    body{
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      flex-direction:column;
      overflow-x:hidden;
    }

    #voltarPainelTopo{
      position:fixed; top:12px; left:12px; z-index:9999;
      padding:8px 14px; width:auto;
      background:rgba(255,255,255,.08);
      color:#fff; border-radius:8px;
      border:1px solid rgba(255,255,255,.25);
      cursor:pointer; font-size:14px;
      backdrop-filter:blur(4px);
      transition:.3s ease;
    }
    #voltarPainelTopo:hover{ background:rgba(255,255,255,.16) }

    header{
      background:linear-gradient(180deg,rgba(0,0,0,.3),rgba(0,0,0,.6));
      padding:28px 16px;
      text-align:center;
      border-bottom:1px solid var(--outline)
    }
    header h1{ font-weight:800; font-size:clamp(20px,4vw,30px) }
    header .plus{ color:var(--primary); }

    .wrap{
      width:94%; max-width:1100px;
      margin:18px auto; flex:1;
      display:grid; gap:14px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--outline);
      padding:16px;
      border-radius:12px;
      backdrop-filter:blur(6px);
    }

    .dados{
      display:flex; flex-wrap:wrap;
      gap:12px;
    }
    .dados div{
      min-width:160px; flex:1;
      background:rgba(255,255,255,.05);
      border:1px solid var(--outline);
      padding:10px;
      border-radius:10px;
    }
    .dados div b{
      color:var(--primary);
      display:block; margin-bottom:2px;
    }

    label{
      display:block;
      color:#e8e8e8;
      margin:6px 0 4px;
      font-size:13px;
    }

    input,select,textarea,button{
      width:100%; padding:12px;
      border-radius:10px;
      border:1px solid var(--outline);
      background:rgba(255,255,255,.08);
      color:#fff; font-size:15px;
      outline:none;
      transition:.25s;
    }

    .btn{
      background:var(--primary); border:none;
      font-weight:700; cursor:pointer;
      color:#fff; transition:.25s;
    }
    .btn:hover{ background:var(--primary-700); transform:translateY(-1px); }

    .btn-green{ background:var(--green); }
    .btn-red{ background:var(--red); }
    .btn-ghost{ background:transparent; border:1px solid var(--outline); color:var(--muted); }

    .grid2{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:14px;
    }

    @media(max-width:900px){ .grid2{ grid-template-columns:1fr; } }

    ul{
      list-style:none;
      padding-left:0;
      margin-top:8px;
      max-height:260px;
      overflow-y:auto;
    }
    li{
      background:rgba(255,255,255,.05);
      border:1px solid var(--outline);
      padding:12px;
      border-radius:10px;
      margin:6px 0;
      display:flex; flex-wrap:wrap;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }

    footer{
      padding:12px; text-align:center;
      color:var(--muted);
      border-top:1px solid var(--outline);
    }
  </style>
</head>
<body>

<button id="voltarPainelTopo" onclick="window.location.href='painel.html'">← Voltar</button>

<header>
  <h1>Gastos & Bônus — Motorista<span class="plus">Plus</span></h1>
</header>

<main class="wrap">

  <!-- DADOS MOTORISTA -->
  <section class="card">
    <h2>Dados do Motorista</h2>
    <div class="dados" id="dadosUsuario"></div>
  </section>

  <!-- DIÁRIAS -->
  <section class="card">
    <h2>Período da Viagem (diárias automáticas)</h2>
    <div class="row" style="margin-top:6px">
      <div style="flex:1 1 220px">
        <label>Data Início</label>
        <input type="date" id="tripStart">
      </div>
      <div style="flex:1 1 220px">
        <label>Data Fim</label>
        <input type="date" id="tripEnd">
      </div>
      <div style="flex:0 0 180px;align-self:end">
        <button class="btn btn-green" id="calcDiarias">Calcular Bônus</button>
      </div>
      <div style="flex:0 0 180px;align-self:end">
        <button class="btn btn-ghost" id="clearDiarias">Limpar Bônus</button>
      </div>
    </div>

    <p id="totalDiariasText" class="tag" style="margin-top:8px">
      Total de Bônus: 0 — Valor total: R$ 0,00
    </p>
  </section>

  <!-- GRID GASTOS/VALES -->
  <div class="grid2">

    <!-- GASTOS -->
    <section class="card">
      <h2>Registrar Gastos</h2>

      <label>Data</label>
      <input type="date" id="gastoDate">

      <label>Motivo</label>
      <input id="gastoMotivo">

      <label>Local</label>
      <input id="gastoLocal">

      <label>Valor (R$)</label>
      <input type="number" id="gastoValor" step="0.01">

      <label>Autorização</label>
      <select id="gastoAut">
        <option>Francisco</option>
        <option>Vinicios</option>
        <option>Douglas</option>
        <option>Daniel</option>
        <option>Jeferson</option>
        <option>Valdir</option>
        <option>William</option>
        <option>Outro</option>
      </select>

      <div class="row" style="margin-top:10px">
        <button class="btn btn-green" id="addGasto">Salvar</button>
        <button class="btn btn-ghost" id="cancelarEditGasto" style="display:none">Cancelar edição</button>
      </div>

      <h3 style="margin-top:12px;font-size:1rem;color:var(--primary)">Lista de Gastos</h3>
      <ul id="listaGastos"></ul>
    </section>

    <!-- VALES -->
    <section class="card">
      <h2>Retirada de Vales</h2>

      <label>Data</label>
      <input type="date" id="valeDate">

      <label>Descrição</label>
      <input id="valeMotivo">

      <label>Valor (R$)</label>
      <input type="number" id="valeValor" step="0.01">

      <div class="row" style="margin-top:10px">
        <button class="btn btn-green" id="addVale">Salvar</button>
        <button class="btn btn-ghost" id="cancelarEditVale" style="display:none">Cancelar edição</button>
      </div>

      <h3 style="margin-top:12px;font-size:1rem;color:var(--primary)">Lista de Vales</h3>
      <ul id="listaVales"></ul>
    </section>

  </div>

  <!-- RESUMO -->
  <section class="card" style="text-align:center">
    <h2>Resumo Visual</h2>
    <canvas id="chartResumo"></canvas>
    <p id="saldoTexto"></p>
  </section>

  <!-- AÇÕES -->
  <section class="card" style="text-align:center">
    <button class="btn btn-green" id="gerarPDF">Gerar PDF</button>
    <button class="btn btn-red" id="clearAll">Apagar TODOS</button>
  </section>

</main>

<footer>© 2025 Motorista Plus</footer>

<!-- SCRIPT COMPLETO -->
<script type="module">

/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import {
  getFirestore, doc, getDoc, collection, addDoc, updateDoc,
  deleteDoc, query, orderBy, onSnapshot, getDocs, serverTimestamp
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyCnlpnTTJvJPZxuZdmpKQWbbHtvH72nMUU",
  authDomain:"motorista-plus-c53f4.firebaseapp.com",
  projectId:"motorista-plus-c53f4",
  storageBucket:"motorista-plus-c53f4.appspot.com",
  messagingSenderId:"766097061342",
  appId:"1:766097061342:web:36d999bec6d9fe8c46994f"
});

const auth = getAuth(app);
const db   = getFirestore(app);

const $ = (id)=>document.getElementById(id);

let uid = null;
let perfil = null;
let gastos = [];
let vales = [];
let editGastoId = null;
let editValeId  = null;

// Valor da diária
const DIARIA_VALOR = 4.28;
let totalDiarias = 0;

/* ===== FORMATAÇÃO ===== */
const fmtBR = (iso)=> iso ? iso.split("-").reverse().join("/") : "—";

/* ================= PERFIL ================= */
async function carregarPerfil(){
  const snap = await getDoc(doc(db,"usuarios",uid));
  if(!snap.exists()) return;
  perfil = snap.data();

  $('dadosUsuario').innerHTML = `
    <div><b>Motorista:</b> ${perfil.nome}</div>
    <div><b>Cavalo:</b> ${perfil.placaCavalo}</div>
    <div><b>Reboque:</b> ${perfil.placaReboque}</div>
    <div><b>Email:</b> ${perfil.email}</div>
    <div><b>Telefone:</b> ${perfil.telefone}</div>
  `;
}

/* ================== STREAM REALTIME ================== */
function iniciarStream(){

  const qG = query(collection(db,"usuarios",uid,"gastos"), orderBy("criadoEm","desc"));
  onSnapshot(qG, snap=>{
    gastos = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    renderGastos();
    atualizarResumo();
  });

  const qV = query(collection(db,"usuarios",uid,"vales"), orderBy("criadoEm","desc"));
  onSnapshot(qV, snap=>{
    vales = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    renderVales();
    atualizarResumo();
  });
}

/* ================== LISTAS ================== */
function renderGastos(){
  if(gastos.length === 0){
    listaGastos.innerHTML = "<li class='tag'>(nenhum)</li>";
    return;
  }
  listaGastos.innerHTML = gastos.map(g=>`
    <li>
      <div style="flex:1">
        <b>${fmtBR(g.date)} — R$ ${g.valor.toFixed(2)}</b>
        <div class="tag">${g.motivo} — ${g.local} — Aut.: ${g.aut}</div>
      </div>
      <button class="btn" data-id="${g.id}" data-act="edit">Editar</button>
      <button class="btn-red" data-id="${g.id}" data-act="del">Remover</button>
    </li>
  `).join("");

  document.querySelectorAll("#listaGastos button").forEach(b=>{
    b.onclick = async ()=>{
      const id = b.dataset.id;
      const act = b.dataset.act;
      if(act==="edit"){
        const g = gastos.find(x=>x.id===id);
        gastoDate.value = g.date;
        gastoMotivo.value = g.motivo;
        gastoLocal.value = g.local;
        gastoValor.value = g.valor;
        gastoAut.value = g.aut;
        editGastoId = id;
        cancelarEditGasto.style.display="block";
      }
      else{
        if(confirm("Excluir gasto?")){
          await deleteDoc(doc(db,"usuarios",uid,"gastos",id));
        }
      }
    };
  });
}

function renderVales(){
  if(vales.length === 0){
    listaVales.innerHTML = "<li class='tag'>(nenhum)</li>";
    return;
  }
  listaVales.innerHTML = vales.map(v=>`
    <li>
      <div style="flex:1">
        <b>${fmtBR(v.date)} — R$ ${v.valor.toFixed(2)}</b>
        <div class="tag">${v.motivo || "—"}</div>
      </div>
      <button class="btn" data-id="${v.id}" data-act="edit">Editar</button>
      <button class="btn-red" data-id="${v.id}" data-act="del">Remover</button>
    </li>
  `).join("");

  document.querySelectorAll("#listaVales button").forEach(b=>{
    b.onclick = async ()=>{
      const id = b.dataset.id;
      const act = b.dataset.act;
      if(act==="edit"){
        const v = vales.find(x=>x.id===id);
        valeDate.value = v.date;
        valeMotivo.value = v.motivo;
        valeValor.value = v.valor;
        editValeId = id;
        cancelarEditVale.style.display="block";
      }
      else{
        if(confirm("Excluir vale?")){
          await deleteDoc(doc(db,"usuarios",uid,"vales",id));
        }
      }
    };
  });
}

/* ================== DIÁRIAS ================== */
calcDiarias.onclick = ()=>{
  const s = tripStart.value;
  const e = tripEnd.value;

  if(!s || !e || s > e){
    alert("Selecione datas válidas.");
    return;
  }

  const sd = new Date(s+"T00:00:00");
  const ed = new Date(e+"T00:00:00");
  const days = Math.floor((ed - sd) / 86400000) + 1;

  totalDiarias = days;

  localStorage.setItem(`mp:${uid}:start`, s);
  localStorage.setItem(`mp:${uid}:end`, e);
  localStorage.setItem(`mp:${uid}:dias`, days);

  atualizarResumo();
};

clearDiarias.onclick = ()=>{
  tripStart.value = "";
  tripEnd.value = "";
  totalDiarias = 0;
  localStorage.removeItem(`mp:${uid}:start`);
  localStorage.removeItem(`mp:${uid}:end`);
  localStorage.removeItem(`mp:${uid}:dias`);
  atualizarResumo();
};

/* ================== CRUD GASTOS ================== */
addGasto.onclick = async ()=>{
  const d = gastoDate.value;
  const m = gastoMotivo.value.trim();
  const l = gastoLocal.value.trim();
  const v = parseFloat(gastoValor.value);
  const a = gastoAut.value;

  if(!d||!m||!l||!v){
    alert("Preencha todos os campos.");
    return;
  }

  const item = { date:d, motivo:m, local:l, valor:v, aut:a, criadoEm:serverTimestamp() };

  if(editGastoId){
    await updateDoc(doc(db,"usuarios",uid,"gastos",editGastoId), item);
    editGastoId = null;
    cancelarEditGasto.style.display="none";
  }else{
    await addDoc(collection(db,"usuarios",uid,"gastos"), item);
  }

  gastoDate.value="";
  gastoMotivo.value="";
  gastoLocal.value="";
  gastoValor.value="";
};

/* ================== CRUD VALES ================== */
addVale.onclick = async ()=>{
  const d = valeDate.value;
  const m = valeMotivo.value.trim();
  const v = parseFloat(valeValor.value);

  if(!d || !v){
    alert("Preencha data e valor.");
    return;
  }

  const item = { date:d, motivo:m, valor:v, criadoEm:serverTimestamp() };

  if(editValeId){
    await updateDoc(doc(db,"usuarios",uid,"vales",editValeId), item);
    editValeId = null;
    cancelarEditVale.style.display="none";
  }else{
    await addDoc(collection(db,"usuarios",uid,"vales"), item);
  }

  valeDate.value="";
  valeMotivo.value="";
  valeValor.value="";
};

/* ================== RESUMO ================== */
function atualizarResumo(){
  const bonusTotal = totalDiarias * DIARIA_VALOR;
  const totalG = gastos.reduce((s,g)=> s+g.valor, 0);
  const totalV = vales.reduce((s,v)=> s+v.valor, 0);
  const diferenca = Math.abs((bonusTotal + totalG) - totalV).toFixed(2);

  saldoTexto.textContent =
    totalV > (bonusTotal+totalG)
    ? `Saldo: Motorista deve R$ ${diferenca}`
    : `Saldo: Empresa deve R$ ${diferenca}`;

  if(window.chartResumoObj){
    window.chartResumoObj.destroy();
  }

  const ctx = chartResumo.getContext("2d");
  window.chartResumoObj = new Chart(ctx, {
    type:"pie",
    data:{
      labels:["Bônus","Gastos","Vales"],
      datasets:[{ data:[bonusTotal,totalG,totalV] }]
    }
  });

  totalDiariasText.textContent =
    `Total de Bônus: ${totalDiarias} — Valor total: R$ ${bonusTotal.toFixed(2)}`;
}

/* ================== PDF ================== */
gerarPDF.onclick = ()=>{
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();

  let y = 20;

  pdf.setFontSize(16);
  pdf.text("Relatório — Gastos & Bônus", 20, y);
  y+=20;

  pdf.setFontSize(12);
  pdf.text(`Motorista: ${perfil.nome}`,20,y); y+=14;
  pdf.text(`Placas: ${perfil.placaCavalo} / ${perfil.placaReboque}`,20,y); y+=14;

  pdf.text(`Período: ${tripStart.value ? fmtBR(tripStart.value) : "—"} a ${tripEnd.value ? fmtBR(tripEnd.value) : "—"}`,20,y);
  y+=14;

  pdf.text(`Diárias: ${totalDiarias} × R$ ${DIARIA_VALOR.toFixed(2)}`,20,y);
  y+=14;

  pdf.text("Gastos:",20,y); y+=14;

  gastos.forEach(g=>{
    pdf.text(`${fmtBR(g.date)} — ${g.motivo} — ${g.local} — R$ ${g.valor.toFixed(2)}`,20,y);
    y+=12;
  });

  y+=10;
  pdf.text("Vales:",20,y); y+=14;

  vales.forEach(v=>{
    pdf.text(`${fmtBR(v.date)} — ${v.motivo || "—"} — R$ ${v.valor.toFixed(2)}`,20,y);
    y+=12;
  });

  pdf.save("gastos_diarias.pdf");
};

/* ================== LIMPAR TUDO ================== */
clearAll.onclick = async ()=>{
  if(!confirm("Excluir TODOS os registros?")) return;

  const g = await getDocs(collection(db,"usuarios",uid,"gastos"));
  const v = await getDocs(collection(db,"usuarios",uid,"vales"));

  const jobs=[];
  g.forEach(d=> jobs.push(deleteDoc(d.ref)));
  v.forEach(d=> jobs.push(deleteDoc(d.ref)));

  await Promise.all(jobs);
};

/* ================= AUTH ================= */
onAuthStateChanged(auth, async user=>{
  if(!user){ location.href="login.html"; return; }
  uid = user.uid;

  // Restaurar diárias salvas
  tripStart.value = localStorage.getItem(`mp:${uid}:start`) || "";
  tripEnd.value   = localStorage.getItem(`mp:${uid}:end`)   || "";
  totalDiarias    = Number(localStorage.getItem(`mp:${uid}:dias`) || 0);

  await carregarPerfil();
  iniciarStream();
  atualizarResumo();
});

</script>

</body>
</html>