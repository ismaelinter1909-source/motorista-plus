<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Média — Motorista Plus</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- jsPDF + autoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --bg:#0b0f14;
      --card:#12171e;
      --primary:#f39220;
      --outline:#2b3a49;
      --text:white;
      --muted:#b5bcc7;
    }

    *{ margin:0; padding:0; box-sizing:border-box; font-family:system-ui,Arial; }

    body{
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
    }

    .container{
      width:94%;
      margin:12px auto 50px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--outline);
      border-radius:12px;
      padding:14px;
    }

    .card h2{
      text-align:center;
      font-size:1.1rem;
      color:var(--primary);
      margin-bottom:10px;
    }

    input,button,textarea{
      width:100%;
      padding:12px;
      border-radius:10px;
      border:1px solid var(--outline);
      background:#0f141a;
      color:white;
      margin-top:8px;
      font-size:14px;
    }

    button{ background:var(--primary); font-weight:700; }
    button:hover{ filter:brightness(.92); }

    #backBtn{
      position:fixed; top:10px; left:10px; z-index:999;
      width:auto; padding:6px 14px;
      background:#ffffff20; border:1px solid #ffffff30;
      border-radius:10px; color:white; cursor:pointer;
    }

    textarea{ height:90px; resize:none; }

    /* Dados do motorista */
    #dadosUsuarioCard{ display:flex; flex-direction:column; gap:8px; }
    #dadosUsuarioCard .item{
      background:rgba(255,255,255,.05);
      padding:10px; border-radius:10px; border:1px solid var(--outline);
      font-size:14px;
    }
    #dadosUsuarioCard b{ color:var(--primary); display:block; font-size:13px; margin-bottom:2px; }

    /* Tabela */
    table{ width:100%; border-collapse:collapse; font-size:14px; }
    th{ background:var(--primary); padding:6px; color:white; font-size:13px; }
    td{ padding:6px; border-bottom:1px solid var(--outline); text-align:center; }

    /* Gráfico menor/leve */
    canvas{
      max-height:180px !important;
      height:180px !important;
      background:#0f141a;
      padding:8px; border-radius:10px; margin-top:8px;
    }

    #limparPagina{ background:#333; }

    footer{
      text-align:center; padding:14px; margin-top:26px;
      color:var(--muted); border-top:1px solid var(--outline);
    }
  </style>
</head>
<body>

<button id="backBtn" onclick="window.location.href='painel.html'">← Voltar</button>

<header style="text-align:center; padding:32px 10px; background:#0004;">
  <h1 style="font-size:1.8rem; font-weight:800;">
    Média — Motorista <span style="color:var(--primary)">Plus</span>
  </h1>
</header>

<main class="container">

  <!-- Dados do Motorista -->
  <section class="card">
    <h2>Dados do Motorista</h2>
    <div id="dadosUsuarioCard">Carregando...</div>
  </section>

  <!-- Registrar abastecimento (sempre Diesel nesta tela) -->
  <section class="card">
    <h2>Cadastrar Abastecimento (Diesel)</h2>

    <label>Data</label>
    <input type="date" id="data">

    <label>Local</label>
    <input id="local" placeholder="Posto / Cidade">

    <label>KM</label>
    <input type="number" id="quilometragem" inputmode="numeric" placeholder="Ex: 120000">

    <label>Litros</label>
    <input type="number" id="litros" step="0.01" placeholder="Ex: 150.00">

    <label>Observação</label>
    <textarea id="obs" placeholder="Opcional"></textarea>

    <button id="addBtn">Salvar</button>
    <button id="cancelarEdicao" style="display:none;background:#444">Cancelar Edição</button>
  </section>

  <!-- Filtro e PDF -->
  <section class="card">
    <h2>Período & PDF (apenas Diesel)</h2>

    <label>Início</label>
    <input type="date" id="filterInicio">

    <label>Fim</label>
    <input type="date" id="filterFim">

    <label>Aprovado por</label>
    <input id="aprovadoPor" placeholder="Nome de quem aprovou (opcional)">

    <button id="exportPdfBtn" style="margin-top:10px;">Gerar PDF</button>
    <button id="limparPagina" style="margin-top:10px;">Limpar Página</button>
  </section>

  <!-- Histórico -->
  <section class="card">
    <h2>Histórico (Somente Diesel)</h2>

    <div style="overflow-x:auto">
      <table id="tableRegistros">
        <thead>
          <tr>
            <th>Data</th>
            <th>Local</th>
            <th>KM</th>
            <th>Litros</th>
            <th>Média por Abastecimento</th>
            <th>Obs</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <p id="resultado" style="margin-top:12px;font-weight:700;"></p>
  </section>

  <!-- Gráfico -->
  <section class="card">
    <h2>Gráfico</h2>
    <canvas id="chart"></canvas>
  </section>

</main>

<footer>© 2025 Motorista Plus</footer>

<!-- ===== SCRIPT COMPLETO ===== -->
<script type="module">
  /* ===== Firebase ===== */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, addDoc, collection, getDocs, query, orderBy, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  // Projeto: motorista-plus-c53f4
  const app = initializeApp({
    apiKey: "AIzaSyCnlpnTTJvJPZxuZdmpKQWbbHtvH72nMUU",
    authDomain: "motorista-plus-c53f4.firebaseapp.com",
    projectId: "motorista-plus-c53f4",
    storageBucket: "motorista-plus-c53f4.firebasestorage.app",
    messagingSenderId: "766097061342",
    appId: "1:766097061342:web:36d999bec6d9fe8c46994f",
    measurementId: "G-CBT2D0CXPN"
  });

  const auth = getAuth(app);
  const db   = getFirestore(app);

  const $ = (id)=> document.getElementById(id);

  let uid = null;
  let perfil = null;
  let abastecimentos = [];
  let chart;

  /* ===== Util de data (sem fuso) ===== */
  const dateKey = (isoStr)=> Number((isoStr || '').replaceAll('-', ''));
  const between = (iso, start, end) => {
    const n = dateKey(iso);
    if (start && n < dateKey(start)) return false;
    if (end   && n > dateKey(end))   return false;
    return true;
  };

  /* ===== Perfil ===== */
  async function carregarPerfil(){
    const snap = await getDoc(doc(db, "usuarios", uid));
    if (snap.exists()) perfil = snap.data();

    $("dadosUsuarioCard").innerHTML = `
      <div class="item"><b>Motorista</b>${perfil?.nome ?? "—"}</div>
      <div class="item"><b>E-mail</b>${perfil?.email ?? "—"}</div>
      <div class="item"><b>Telefone</b>${perfil?.telefone ?? "—"}</div>
      <div class="item"><b>Placa Cavalo</b>${perfil?.placaCavalo ?? "—"}</div>
      <div class="item"><b>Placa Reboque</b>${perfil?.placaReboque ?? "—"}</div>
    `;
  }

  /* ===== Carregar abastecimentos (todos) ===== */
  async function carregarAbastecimentos(){
    const qy = query(
      collection(db, "usuarios", uid, "abastecimentos"),
      orderBy("data", "asc")
    );
    const snaps = await getDocs(qy);
    abastecimentos = [];
    snaps.forEach(s=>{
      const d = s.data();
      abastecimentos.push({
        id: s.id,
        data: String(d.data || ''),
        local: String(d.local || ''),
        quilometragem: Number(d.quilometragem || 0),
        litros: Number(d.litros || 0),
        tipo: String(d.tipo || '').toLowerCase() === 'arla' ? 'arla' : 'diesel',
        obs: String(d.obs || '')
      });
    });
  }

  /* ===== Filtrar apenas Diesel + período ===== */
  function dieselPorPeriodo(inicioISO, fimISO){
    return abastecimentos
      .filter(r => r.tipo === 'diesel')
      .filter(r => between(r.data, inicioISO || null, fimISO || null));
  }

  /* ===== Médias por abastecimento (entre registros consecutivos) ===== */
  function mediasPorAbastecimento(arr){
    const out = [];
    for (let i=0;i<arr.length;i++){
      if (i===0){ out.push('--'); continue; }
      const kmDif = Number(arr[i].quilometragem) - Number(arr[i-1].quilometragem);
      const litros = Number(arr[i].litros);
      const m = (kmDif > 0 && litros > 0) ? (kmDif / litros) : 0;
      out.push(m ? m.toFixed(2) : '--');
    }
    return out;
  }

  /* ===== Média do período ===== */
  function mediaPeriodo(arr){
    if (arr.length < 2) return '--';
    const kmIni = Number(arr[0].quilometragem);
    const kmFim = Number(arr[arr.length - 1].quilometragem);
    const litrosTot = arr.reduce((s,r)=> s + Number(r.litros||0), 0);
    if (litrosTot <= 0) return '--';
    return ((kmFim - kmIni) / litrosTot).toFixed(2);
  }

  /* ===== Render tabela + gráfico + resumo ===== */
  function atualizarTabelaEGrafico(){
    const inicio = $('filterInicio')?.value || null;
    const fim    = $('filterFim')?.value || null;

    const diesel = dieselPorPeriodo(inicio, fim);
    const medias = mediasPorAbastecimento(diesel);

    // Tabela
    const tbody = document.querySelector('#tableRegistros tbody');
    tbody.innerHTML = '';
    diesel.forEach((r,idx)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.data}</td>
        <td>${r.local}</td>
        <td>${r.quilometragem}</td>
        <td>${r.litros.toFixed(2)}</td>
        <td>${medias[idx]}</td>
        <td>${r.obs || '—'}</td>
      `;
      tbody.appendChild(tr);
    });

    // Gráfico
    const ctx = $('chart').getContext('2d');
    const labels = diesel.map(r=> r.data);
    const dataVals = medias.map((m,i)=> i===0 ? null : (m==='--' ? null : Number(m)));
    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label:'Média (km/L) — Diesel',
          data: dataVals,
          fill: true
        }]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });

    // Resumo com -5%
    const mp = mediaPeriodo(diesel);
    $('resultado').textContent =
      (mp==='--')
        ? 'Sem dados suficientes (Diesel).'
        : `Média do período (Diesel): ${mp} km/L — Regra da empresa (-5%): ${(Number(mp)*0.95).toFixed(2)} km/L`;
  }

  /* ===== PDF (somente Diesel e período filtrado) ===== */
  function gerarPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:'pt', format:'a4' });

    const startX = 40; let y = 40;

    // Título
    doc.setFontSize(16).setFont(undefined,'bold');
    doc.text('Relatório de Média (Diesel) — Motorista Plus', startX, y);
    y += 22;

    // Dados do motorista
    doc.setFontSize(11).setFont(undefined,'normal');
    [
      `Motorista: ${perfil?.nome ?? '—'}`,
      `E-mail: ${perfil?.email ?? '—'}`,
      `Telefone: ${perfil?.telefone ?? '—'}`,
      `Placas: ${perfil?.placaCavalo ?? '—'} / ${perfil?.placaReboque ?? '—'}`
    ].forEach((t,i)=>{ doc.text(t, startX, y + i*16); });
    y += 16*4 + 8;

    // Período
    const inicio = $('filterInicio')?.value || null;
    const fim    = $('filterFim')?.value || null;
    doc.text(`Período: ${inicio || '—'} a ${fim || '—'}`, startX, y);
    y += 16;

    const diesel = dieselPorPeriodo(inicio, fim);
    const medias = mediasPorAbastecimento(diesel);

    // Tabela
    doc.autoTable({
      startY: y,
      head: [['Data','Local','KM','Litros','Média (km/L)']],
      body: diesel.map((r,i)=>[
        r.data, r.local, String(r.quilometragem), r.litros.toFixed(2), String(medias[i])
      ]),
      headStyles:{ fillColor:[243,146,32] },
      styles:{ fontSize:10, halign:'center' },
      margin:{ left:startX, right:startX }
    });

    y = doc.autoTable.previous.finalY + 16;

    // Resumo
    const mp = mediaPeriodo(diesel);
    if (mp !== '--'){
      doc.setFont(undefined,'bold');
      doc.text(`Média do período (Diesel): ${mp} km/L`, startX, y); y += 16;
      doc.text(`Regra da empresa (-5%): ${(Number(mp)*0.95).toFixed(2)} km/L`, startX, y); y += 16;
    }else{
      doc.text('Sem dados suficientes para média (Diesel).', startX, y); y += 16;
    }

    // Aprovado por (opcional)
    const aprov = ($('aprovadoPor').value || '').trim();
    if(aprov){
      const today = new Date();
      const dd = String(today.getDate()).padStart(2,'0');
      const mm = String(today.getMonth()+1).padStart(2,'0');
      const yyyy = today.getFullYear();
      doc.setFont(undefined,'normal');
      doc.text(`Aprovado por: ${aprov} — Data: ${dd}/${mm}/${yyyy}`, startX, y);
      y += 16;
    }

    // Assinatura
    const w = doc.internal.pageSize.getWidth();
    doc.line(w/2 - 120, y + 36, w/2 + 120, y + 36);
    doc.text('Assinatura do Motorista', w/2, y + 52, { align:'center' });

    doc.save(`media_diesel_${new Date().toISOString().slice(0,10)}.pdf`);
  }

  /* ===== Salvar abastecimento (sempre Diesel aqui) ===== */
  $('addBtn').addEventListener('click', async ()=>{
    const data  = $('data').value.trim();
    const local = $('local').value.trim();
    const km    = Number(($('quilometragem').value || '').trim());
    const litros= Number(($('litros').value || '').trim());
    const obs   = ($('obs').value || '').trim();

    if(!data || !local || km<=0 || litros<=0){
      alert('Preencha todos os campos corretamente.');
      return;
    }
    if(!uid){
      alert('Sessão expirada. Faça login novamente.');
      return;
    }

    await addDoc(collection(db, "usuarios", uid, "abastecimentos"), {
      data, local, quilometragem: km, litros,
      tipo: 'diesel',
      obs,
      criadoEm: serverTimestamp()
    });

    // limpar
    $('data').value = '';
    $('local').value = '';
    $('quilometragem').value = '';
    $('litros').value = '';
    $('obs').value = '';

    await carregarAbastecimentos();
    atualizarTabelaEGrafico();
    alert('Abastecimento (Diesel) adicionado!');
  });

  /* ===== Filtro / PDF / Limpar ===== */
  $('filterInicio').addEventListener('change', atualizarTabelaEGrafico);
  $('filterFim').addEventListener('change', atualizarTabelaEGrafico);
  $('exportPdfBtn').addEventListener('click', gerarPDF);
  $('limparPagina').addEventListener('click', ()=>{
    // limpa apenas a UI da página (não apaga dados do banco)
    ['data','local','quilometragem','litros','obs','filterInicio','filterFim','aprovadoPor'].forEach(id=>{
      if($(id)) $(id).value = '';
    });
    atualizarTabelaEGrafico();
  });

  /* ===== Auth ===== */
  onAuthStateChanged(auth, async (u)=>{
    if(!u){ window.location.href = 'login.html'; return; }
    uid = u.uid;
    await carregarPerfil();
    await carregarAbastecimentos();
    atualizarTabelaEGrafico();
  });
</script>

</body>
</html>