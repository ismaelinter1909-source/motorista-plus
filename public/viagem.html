<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Viagem — Motorista Plus</title>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root {
      --bg: #0b0f14;
      --bg2: #10161d;
      --card: #161c23;
      --primary: #f39220;
      --primary-700: #d47e16;
      --outline: #2b3a49;
      --text: #fff;
      --muted: #b5bcc7;
      --green: #2b9348;
      --red: #dc3545;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, Arial, sans-serif
    }

    body {
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column
    }

    #voltarPainel {
      position: fixed;
      top: 12px;
      left: 12px;
      z-index: 9999;
      width: auto;
      padding: 8px 14px;
      background: rgba(255, 255, 255, .08);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, .25);
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      backdrop-filter: blur(4px)
    }

    header {
      background: linear-gradient(180deg, rgba(0, 0, 0, .3), rgba(0, 0, 0, .6)), url("img/Logo.Motorista-Plus.png") center/cover no-repeat;
      padding: 30px 15px;
      text-align: center;
      border-bottom: 1px solid var(--outline)
    }

    header h1 {
      font-size: clamp(20px, 4vw, 30px);
      font-weight: 800
    }

    header .plus {
      color: var(--primary)
    }

    main {
      width: 94%;
      max-width: 1100px;
      margin: 18px auto 40px;
      display: grid;
      gap: 14px;
      flex: 1
    }

    .card {
      background: var(--card);
      border: 1px solid var(--outline);
      padding: 16px;
      border-radius: 12px;
      backdrop-filter: blur(6px)
    }

    h2 {
      color: var(--primary);
      margin-bottom: 8px;
      font-size: 1.2rem
    }

    label {
      font-size: 13px;
      margin-bottom: 4px;
      color: #e8e8e8;
      display: block
    }

    input,
    textarea,
    button,
    select {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--outline);
      background: rgba(255, 255, 255, .08);
      color: #fff;
      font-size: 14px;
      outline: none;
      transition: box-shadow .2s, border-color .2s;
    }

    .btn {
      background: var(--primary);
      border: none;
      font-weight: 700;
      color: #fff;
      cursor: pointer
    }

    .btn:hover {
      background: var(--primary-700)
    }

    .btn-red {
      background: var(--red)
    }

    .grid2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 10px
    }

    #dadosUsuarioCard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px
    }

    .table-wrap {
      overflow-x: auto
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      margin-top: 10px
    }

    thead th {
      background: var(--primary);
      color: #fff;
      padding: 8px;
      text-align: center
    }

    td,
    th {
      border: 1px solid var(--outline);
      padding: 8px;
      text-align: center
    }

    .edit-input {
      width: 70px;
      background: rgba(255, 255, 255, .06);
      color: #fff;
      border-radius: 8px
    }

    .row-actions {
      display: flex;
      gap: 6px;
      justify-content: center;
      flex-wrap: wrap
    }

    .resumo-box {
      background: rgba(255, 255, 255, .06);
      border: 1px solid var(--outline);
      padding: 10px;
      border-radius: 10px;
      margin-top: 10px;
      text-align: center
    }

    footer {
      padding: 12px;
      text-align: center;
      color: var(--muted);
      border-top: 1px solid var(--outline)
    }
  </style>
</head>

<body>

  <button id="voltarPainel" onclick="window.location.href='painel.html'">← Voltar</button>

  <header>
    <h1>Planilha de Viagem — Motorista<span class="plus">Plus</span></h1>
  </header>

  <main>

    <!-- Dados Motorista -->
    <section class="card">
      <h2>Dados do Motorista</h2>
      <div id="dadosUsuarioCard">Carregando...</div>
    </section>

    <!-- Viagem -->
    <section class="card">
      <h2>Viagem</h2>

      <div class="grid2">
        <div><label>Início</label><input type="date" id="viagemInicio"></div>
        <div><label>Fim</label><input type="date" id="viagemFim"></div>
        <div><label>KM Inicial</label><input type="number" id="kmInicio"></div>
        <div><label>KM Final</label><input type="number" id="kmFim"></div>
      </div>

      <div class="grid2" style="margin-top:10px">
        <div><label>Dias Viajados</label><input readonly id="diasViajados"></div>
        <div><label>Folgas</label><input readonly id="diasFolga"></div>
        <div><label>Retorno</label><input readonly id="retornoFolga"></div>
        <div><label>KM Rodados</label><input readonly id="kmRodados"></div>
      </div>

      <div class="resumo-box" id="resumoDiarias"></div>

      <div style="display:flex;gap:10px;margin-top:12px">
        <button id="editarViagemBtn" class="btn" style="display:none">Editar viagem</button>
        <button id="salvarViagemBtn" class="btn btn-green">Salvar</button>
      </div>
    </section>
    <!-- Parte 2/2 - continua... -->

    <!-- Diárias -->
    <section class="card">
      <h2>Diárias</h2>

      <div class="grid2">
        <div><label>Data</label><input type="date" id="diariaData"></div>
        <div><label>Qtd</label><input type="number" id="diariaQtd" min="1" value="1"></div>
      </div>

      <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
        <button id="addDiariaBtn" class="btn">Adicionar</button>
        <button id="exportCsvBtn" class="btn btn-ghost">Exportar CSV</button>
        <span style="align-self:center;color:var(--muted)">Valor por diária: <b>R$ 100,00</b></span>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Tipo</th>
              <th>Qtd</th>
              <th>Valor (R$)</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="tbodyDiarias"></tbody>
        </table>
      </div>
    </section>

    <!-- PDF -->
    <section class="card" style="text-align:center">
      <div style="display:flex;justify-content:center;gap:10px;flex-wrap:wrap">
        <button id="gerarPDFButton" class="btn" style="width:200px">Gerar PDF</button>
        <button id="limparTudoBtn" class="btn btn-red" style="width:200px">Limpar</button>
      </div>
    </section>

  </main>

  <footer>© 2025 Motorista Plus</footer>
<script type="module">
/* ========================= Firebase ========================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc,
  collection, addDoc, getDocs, deleteDoc, orderBy, query, serverTimestamp
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyCnlpnTTJvJPZxuZdmpKQWbbHtvH72nMUU",
  authDomain: "motorista-plus-c53f4.firebaseapp.com",
  projectId: "motorista-plus-c53f4",
  storageBucket: "motorista-plus-c53f4.firebasestorage.app",
  messagingSenderId: "766097061342",
  appId: "1:766097061342:web:36d999bec6d9fe8c46994f",
  measurementId: "G-CBT2D0CXPN"
});

const auth = getAuth(app);
const db = getFirestore(app);

const $ = id => document.getElementById(id);
const DIARIA_VALOR = 100;

let uid = null;
let perfil = null;
let diarias = [];
let viagemAtual = null;

/* ========================= Funções de Data ========================= */

// transforma Date → YYYY-MM-DD SEM fuso (seguro)
const toISO = (date) => {
  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, "0");
  const d = String(date.getDate()).padStart(2, "0");
  return `${y}-${m}-${d}`;
};

// transforma YYYY-MM-DD → Date local (seguro, não usa UTC)
const parseISO = iso => {
  if (!iso) return null;
  const [y, m, d] = iso.split("-").map(Number);
  return new Date(y, m - 1, d);
};

const fmtBR = iso => {
  if (!iso) return "";
  const [y, m, d] = iso.split("-");
  return `${d}/${m}/${y}`;
};

const diasEntreInclusive = (iniISO, fimISO) => {
  const ini = parseISO(iniISO);
  const fim = parseISO(fimISO);
  ini.setHours(0,0,0,0);
  fim.setHours(0,0,0,0);
  return Math.round((fim - ini) / 86400000) + 1;
};

const calcularFolgasPelasFaixas = dias => {
  if (dias <= 7) return 1;
  if (dias <= 14) return 2;
  if (dias <= 21) return 3;
  if (dias <= 30) return 4;
  if (dias <= 37) return 5;
  if (dias <= 44) return 6;
  if (dias <= 52) return 7;
  if (dias <= 60) return 8;
  return Math.ceil(dias / 7);
};

/* ========================= Cálculo Final CORRIGIDO ========================= */

const calcularRetorno = (iniISO, fimISO) => {
  const dias = diasEntreInclusive(iniISO, fimISO);
  const folgas = calcularFolgasPelasFaixas(dias);

  const fim = parseISO(fimISO);

  const primeiro = new Date(fim);
  primeiro.setDate(primeiro.getDate() + 1);

  const ultimo = new Date(fim);
  ultimo.setDate(ultimo.getDate() + folgas);

  const retorno = new Date(fim);
  retorno.setDate(retorno.getDate() + folgas + 1);

  return {
    dias,
    folgas,
    primeiroFolgaISO: toISO(primeiro),
    ultimoFolgaISO: toISO(ultimo),
    retornoISO: toISO(retorno)
  };
};

/* ========================= Bloqueio de inputs ========================= */
function setFieldsReadonly(readonly) {
  ['viagemInicio','viagemFim','kmInicio','kmFim'].forEach(id => {
    const el = $(id);
    if (!el) return;
    if (readonly) {
      el.setAttribute('readonly','readonly');
      el.setAttribute('disabled','disabled');
    } else {
      el.removeAttribute('readonly');
      el.removeAttribute('disabled');
    }
  });
}

/* ========================= Preencher UI ========================= */
function preencherDerivadosUI() {
  const ini = $('viagemInicio').value;
  const fim = $('viagemFim').value;
  const kmI = Number($('kmInicio').value || 0);
  const kmF = Number($('kmFim').value || 0);

  if (!ini || !fim) {
    $('diasViajados').value = "";
    $('diasFolga').value = "";
    $('retornoFolga').value = "";
    $('kmRodados').value = "";
    return;
  }

  const info = calcularRetorno(ini, fim);

  $('diasViajados').value = `${info.dias} dia(s)`;
  $('diasFolga').value = `${info.folgas} dia(s)`;
  $('retornoFolga').value = fmtBR(info.retornoISO);
  $('kmRodados').value = kmI && kmF ? kmF - kmI : "";
}

["viagemInicio", "viagemFim", "kmInicio", "kmFim"].forEach(id => {
  $(id).addEventListener("change", preencherDerivadosUI);
});

/* ========================= Carregar Perfil ========================= */
async function carregarPerfil() {
  const snap = await getDoc(doc(db, "usuarios", uid));
  if (!snap.exists()) return;

  perfil = snap.data();

  $('dadosUsuarioCard').innerHTML = `
    <div class="item"><strong>Motorista</strong>${perfil.nome}</div>
    <div class="item"><strong>Telefone</strong>${perfil.telefone}</div>
    <div class="item"><strong>Cavalo</strong>${perfil.placaCavalo}</div>
    <div class="item"><strong>Reboque</strong>${perfil.placaReboque}</div>
    <div class="item"><strong>Email</strong>${perfil.email}</div>
  `;
}

/* ========================= Carregar Viagem ========================= */
async function carregarViagemAtual() {
  const snap = await getDoc(doc(db, "usuarios", uid, "viagemAtual", "dados"));

  if (snap.exists()) {
    viagemAtual = snap.data();

    $('viagemInicio').value = viagemAtual.inicio || "";
    $('viagemFim').value = viagemAtual.fim || "";
    $('kmInicio').value = viagemAtual.kmInicio ?? "";
    $('kmFim').value = viagemAtual.kmFim ?? "";

    setFieldsReadonly(true);
    $('editarViagemBtn').style.display = "inline-block";
    $('salvarViagemBtn').style.display = "none";

    preencherDerivadosUI();
  } else {
    setFieldsReadonly(false);
    $('editarViagemBtn').style.display = "none";
    $('salvarViagemBtn').style.display = "inline-block";
  }
}

/* ========================= Diárias ========================= */
async function carregarDiarias() {
  const q = query(collection(db, "usuarios", uid, "diarias"), orderBy("data", "asc"));
  const snap = await getDocs(q);
  diarias = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  renderDiarias();
}

function renderDiarias() {
  const tbody = $('tbodyDiarias');
  tbody.innerHTML = "";

  diarias.forEach(d => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${fmtBR(d.data)}</td>
      <td>Diária</td>
      <td><input data-id="${d.id}" class="edit-input" type="number" min="1" value="${d.qtd}"></td>
      <td>${(d.qtd * DIARIA_VALOR).toFixed(2)}</td>
      <td>
        <button class="btn" data-act="save" data-id="${d.id}">Salvar</button>
        <button class="btn btn-red" data-act="del" data-id="${d.id}">Excluir</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll("button").forEach(btn => {
    btn.onclick = async () => {
      const id = btn.dataset.id;

      if (btn.dataset.act === "del") {
        await deleteDoc(doc(db, "usuarios", uid, "diarias", id));
      } else {
        const qtd = Number(document.querySelector(`input[data-id="${id}"]`).value);
        await updateDoc(doc(db, "usuarios", uid, "diarias", id), { qtd });
      }
      await carregarDiarias();
    };
  });
}

/* ========================= Editar Viagem ========================= */
$('editarViagemBtn').onclick = () => {
  setFieldsReadonly(false);
  $('editarViagemBtn').style.display = "none";
  $('salvarViagemBtn').style.display = "inline-block";
};

/* ========================= Salvar Viagem ========================= */
$('salvarViagemBtn').onclick = async () => {
  const ini = $('viagemInicio').value;
  const fim = $('viagemFim').value;

  const kmI = Number($('kmInicio').value);
  const kmF = $('kmFim').value ? Number($('kmFim').value) : null;

  const dados = {
    inicio: ini,
    kmInicio: kmI,
    updatedAt: serverTimestamp()
  };

  if (fim) dados.fim = fim;
  if (kmF !== null) dados.kmFim = kmF;

  await setDoc(doc(db, "usuarios", uid, "viagemAtual", "dados"), dados, { merge: true });

  setFieldsReadonly(true);
  $('editarViagemBtn').style.display = "inline-block";
  $('salvarViagemBtn').style.display = "none";

  alert("Viagem salva!");
  carregarViagemAtual();
};

/* ========================= Adicionar Diária ========================= */
$('addDiariaBtn').onclick = async () => {
  const data = $('diariaData').value;
  const qtd = Number($('diariaQtd').value);

  await addDoc(collection(db, "usuarios", uid, "diarias"), {
    data,
    qtd,
    createdAt: serverTimestamp()
  });

  $('diariaQtd').value = 1;
  carregarDiarias();
};

/* ========================= PDF COMPLETO ========================= */
$('gerarPDFButton').onclick = async () => {
  await carregarDiarias();

  const ini = $('viagemInicio').value;
  const fim = $('viagemFim').value;

  const info = calcularRetorno(ini, fim);

  const kmInicial = Number($('kmInicio').value) || 0;
  const kmFinal = Number($('kmFim').value) || 0;
  const kmRodado = kmFinal && kmInicial ? kmFinal - kmInicial : 0;

  const { jsPDF } = window.jspdf;
  const docpdf = new jsPDF({ unit:"pt", format:"a4" });

  let y = 40;
  const x = 40;

  docpdf.setFontSize(16).text("Planilha de Viagem — Motorista Plus", x, y);
  y += 30;

  docpdf.setFontSize(12);
  docpdf.text(`Motorista: ${perfil.nome}`, x, y); y += 18;
  docpdf.text(`Placas: ${perfil.placaCavalo} / ${perfil.placaReboque}`, x, y); y += 18;

  /* === TABELA COMPLETA DA VIAGEM === */
  docpdf.autoTable({
    startY: y,
    head: [["Data início","Data final","1º Folga","Último Folga","Retorno","KM Inicial","KM Final","KM Rodado"]],
    body: [[
      fmtBR(ini),
      fmtBR(fim),
      fmtBR(info.primeiroFolgaISO),
      fmtBR(info.ultimoFolgaISO),
      fmtBR(info.retornoISO),
      kmInicial,
      kmFinal || "-",
      kmRodado || "-"
    ]],
    margin:{ left:x, right:x },
    headStyles:{ fillColor:[243,146,32] }
  });

  y = docpdf.lastAutoTable.finalY + 20;

  /* === TABELA DE FOLGAS === */
  const tabelaFolgas = [];
  let d = parseISO(info.primeiroFolgaISO);
  const fimFolga = parseISO(info.ultimoFolgaISO);

  while (d <= fimFolga) {
    tabelaFolgas.push([fmtBR(toISO(d)), "Folga"]);
    d.setDate(d.getDate() + 1);
  }

  docpdf.autoTable({
    startY: y,
    head: [["Data","Tipo"]],
    body: tabelaFolgas,
    margin:{ left:x, right:x },
    headStyles:{ fillColor:[243,146,32] }
  });

  y = docpdf.lastAutoTable.finalY + 20;

  /* === TABELA DE DIÁRIAS === */
  docpdf.autoTable({
    startY:y,
    head:[["Data","Tipo","Qtd","Valor (R$)"]],
    body: diarias.map(d => [
      fmtBR(d.data),
      "Diária",
      d.qtd,
      (d.qtd * DIARIA_VALOR).toFixed(2)
    ]),
    margin:{ left:x, right:x },
    headStyles:{ fillColor:[243,146,32] }
  });

  /* === ASSINATURA === */
  const yAss = docpdf.lastAutoTable.finalY + 40;
  docpdf.text("_____________________________________________", x, yAss);
  docpdf.text("Assinatura do Motorista", x, yAss + 14);

  docpdf.save("planilha_viagem.pdf");
};

/* ========================= Limpar Tudo ========================= */
$('limparTudoBtn').onclick = async () => {
  if (!confirm("Realmente limpar tudo?")) return;

  await setDoc(doc(db, "usuarios", uid, "viagemAtual", "dados"), {}, { merge:false });

  const snap = await getDocs(collection(db, "usuarios", uid, "diarias"));
  await Promise.all(snap.docs.map(d => deleteDoc(d.ref)));

  location.reload();
};

/* ========================= Login ========================= */
onAuthStateChanged(auth, async user => {
  if (!user) return window.location.href = "index.html";
  uid = user.uid;

  await carregarPerfil();
  await carregarViagemAtual();
  await carregarDiarias();
});
</script>
 

</body>

</html>