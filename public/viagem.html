<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Viagem — Motorista Plus</title>

<!-- jsPDF + AutoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
:root{
  --bg:#0b0f14; --card:#16191d; --outline:#22303a;
  --primary:#f39220; --primary-700:#d47e16;
  --text:#fff; --muted:#b5bcc7; --danger:#dc3545;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,Arial,sans-serif}
body{background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column}
header{background:linear-gradient(180deg,rgba(0,0,0,.25),rgba(0,0,0,.6));padding:20px;text-align:center;border-bottom:1px solid var(--outline)}
header h1{font-size:clamp(18px,3vw,28px);font-weight:800}
header .plus{color:var(--primary)}

main{width:94%;max-width:1100px;margin:18px auto 40px;display:grid;gap:12px}

/* card */
.card{background:var(--card);border:1px solid var(--outline);padding:16px;border-radius:12px;backdrop-filter:blur(6px)}
h2{color:var(--primary);margin-bottom:8px}

/* grid */
.grid4{display:grid;grid-template-columns:repeat(2,minmax(120px,1fr));gap:12px}
@media(min-width:980px){ .grid4{grid-template-columns:repeat(4,minmax(120px,1fr))} }

/* form controls */
label{display:block;color:#e8e8e8;font-size:13px;margin-bottom:6px}
input,select,textarea,button{width:100%;padding:10px;border-radius:10px;border:1px solid var(--outline);background:rgba(255,255,255,.04);color:var(--text);font-size:14px}
input[readonly]{background:rgba(255,255,255,.02);color:var(--muted)}
.btn{background:var(--primary);border:none;color:#fff;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700}
.btn:hover{background:var(--primary-700)}
.btn-ghost{background:transparent;border:1px solid var(--outline);color:var(--muted)}
.btn-red{background:var(--danger)}
.small-muted{color:var(--muted);font-size:13px;margin-top:6px}
.resumo-box{background:rgba(255,255,255,.03);border:1px solid var(--outline);padding:10px;border-radius:8px;margin-top:8px;color:var(--muted)}

.table-wrap{overflow:auto;margin-top:12px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border:1px solid var(--outline);text-align:center}
thead th{background:var(--primary);color:#fff}

/* mobile hiding voltar botão */
#btnVoltar{display:block}
@media(max-width:600px){ #btnVoltar{display:none} }

/* small tweaks */
.actions{display:flex;gap:8px;flex-wrap:wrap}
.note{font-size:13px;color:var(--muted);margin-top:8px}
.signature-line{margin-top:28px}
</style>
</head>
<body>

<header>
  <h1>Planilha de Viagem — Motorista<span class="plus">Plus</span></h1>
</header>

<main>
  <!-- Dados do motorista -->
  <section class="card">
    <h2>Dados do Motorista</h2>
    <div id="dadosUsuarioCard" class="small-muted">Carregando...</div>
  </section>

  <!-- Viagem -->
  <section class="card">
    <h2>Viagem</h2>

    <div class="grid4">
      <div><label>Início</label><input type="date" id="viagemInicio"/></div>
      <div><label>Fim</label><input type="date" id="viagemFim"/></div>
      <div><label>KM Inicial</label><input type="number" id="kmInicio" min="0"/></div>
      <div><label>KM Final</label><input type="number" id="kmFim" min="0"/></div>
    </div>

    <div style="height:12px"></div>

    <div class="grid4">
      <div><label>Dias Viajados</label><input readonly id="diasViajados"/></div>
      <div><label>Folgas</label><input readonly id="diasFolga"/></div>
      <div><label>Retorno</label><input readonly id="retornoFolga"/></div>
      <div><label>KM Rodados</label><input readonly id="kmRodados"/></div>
    </div>

    <div class="resumo-box" id="resumoViagem">Resumo: —</div>

    <div style="margin-top:12px" class="actions">
      <button id="salvarViagemBtn" class="btn">Salvar Viagem</button>
      <button id="limparViagemBtn" class="btn btn-red">Limpar Viagem</button>
    </div>
    <div class="note">Os dados de viagem e resumo ficam salvos no documento <code>usuarios/{uid}/viagemAtual/dados</code>.</div>
  </section>

  <!-- Dívidas anteriores & resumo de diárias -->
  <section class="card">
    <h2>Dívidas Anteriores & Resumo de Diárias</h2>

    <div class="grid4">
      <div><label>Empresa devia (diárias)</label><input type="number" id="empresaDevia" min="0" value="0"/></div>
      <div><label>Motorista devia (diárias)</label><input type="number" id="motoristaDevia" min="0" value="0"/></div>
      <div><label>Diárias recebidas (total)</label><input type="number" id="diariasRecebidas" min="0" value="0"/></div>
      <div><label>Valor por diária (R$)</label><input type="number" id="valorDiaria" min="0" step="0.01" value="100.00"/></div>
    </div>

    <div class="resumo-box" id="resumoDiariasUI">Resumo diárias: —</div>

    <div style="margin-top:12px" class="actions">
      <button id="recalcularResumoBtn" class="btn">Recalcular Resumo</button>
      <button id="salvarResumoBtn" class="btn btn-ghost">Salvar Resumo</button>
      <button id="limparResumoBtn" class="btn btn-red">Limpar Resumo</button>
    </div>

    <div class="note">Resumo separado da viagem. Só é apagado quando clicar em "Limpar Resumo".</div>
  </section>

  <!-- Diárias (coleção usuarios/{uid}/diarias) -->
  <section class="card">
    <h2>Diárias (detalhes)</h2>

    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <div style="flex:1 1 220px"><label>Data</label><input type="date" id="diariaData"/></div>
      <div style="flex:0 0 120px"><label>Qtd</label><input type="number" id="diariaQtd" min="1" value="1"/></div>
      <div style="flex:0 0 160px;align-self:end"><button id="addDiariaBtn" class="btn">Adicionar Diária</button></div>
    </div>

    <div class="table-wrap">
      <table>
        <thead><tr><th>Data</th><th>Qtd</th><th>Valor (R$)</th><th>Ações</th></tr></thead>
        <tbody id="tbodyDiarias"></tbody>
      </table>
    </div>
  </section>

  <!-- PDF e ações finais -->
  <section class="card" style="text-align:center">
    <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
      <button id="gerarPDFBtn" class="btn">Gerar PDF Completo</button>
      <button id="exportCsvBtn" class="btn btn-ghost">Exportar CSV (Diárias)</button>
    </div>
    <div class="note">O PDF inclui resumo, folgas, tabela de folgas, diárias, tabela de compensação e uma linha para assinatura manual.</div>
  </section>

</main>

<footer style="text-align:center;padding:12px;color:var(--muted)">© 2025 Motorista Plus</footer>
<script type="module">
/* =============== Firebase Setup =============== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import {
  getFirestore, doc, getDoc, setDoc, collection,
  addDoc, getDocs, deleteDoc, query, orderBy, serverTimestamp
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCnlpnTTJvJPZxuZdmpKQWbbHtvH72nMUU",
  authDomain: "motorista-plus-c53f4.firebaseapp.com",
  projectId: "motorista-plus-c53f4",
  storageBucket: "motorista-plus-c53f4.firebasestorage.app",
  messagingSenderId: "766097061342",
  appId: "1:766097061342:web:36d999bec6d9fe8c46994f"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ========= Helpers ========= */
const $ = id => document.getElementById(id);
let uid = null;
let perfil = null;
let diarias = [];

/* ========= Datas ========= */
const toISO = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
const parseISO = iso => { const [y,m,d] = iso.split("-").map(Number); return new Date(y,m-1,d); };
const fmtBR = iso => iso ? iso.split("-").reverse().join("/") : "";

/* ========= Folgas ========= */
function calcularFolgas(dias){
  if(dias<=7) return 1;
  if(dias<=14) return 2;
  if(dias<=21) return 3;
  if(dias<=30) return 4;
  if(dias<=37) return 5;
  if(dias<=44) return 6;
  if(dias<=52) return 7;
  if(dias<=60) return 8;
  return Math.ceil(dias/7);
}

function calcularRetorno(iniISO,fimISO){
  const ini = parseISO(iniISO);
  const fim = parseISO(fimISO);

  const dias = Math.floor((fim - ini) / 86400000) + 1;
  const folgas = calcularFolgas(dias);

  const primeiro = new Date(fim); primeiro.setDate(primeiro.getDate()+1);
  const ultimo = new Date(fim); ultimo.setDate(ultimo.getDate()+folgas);
  const retorno = new Date(fim); retorno.setDate(retorno.getDate()+folgas+1);

  return {
    dias, folgas,
    primeiroFolgaISO: toISO(primeiro),
    ultimoFolgaISO: toISO(ultimo),
    retornoISO: toISO(retorno)
  };
}

/* ========= UI Viagem ========= */
function preencherDerivadosUI(){
  const ini = $('viagemInicio').value;
  const fim = $('viagemFim').value;

  if(!ini || !fim){ $('resumoViagem').textContent="Resumo: —"; return; }

  const info = calcularRetorno(ini,fim);

  $('diasViajados').value = info.dias;
  $('diasFolga').value = info.folgas;
  $('retornoFolga').value = fmtBR(info.retornoISO);

  const kmI = Number($('kmInicio').value||0);
  const kmF = Number($('kmFim').value||0);
  $('kmRodados').value = kmI && kmF ? kmF-kmI : "";

  $('resumoViagem').textContent =
    `Dias viajados: ${info.dias} | Folgas: ${info.folgas} | Retorno: ${fmtBR(info.retornoISO)}`;
}

["viagemInicio","viagemFim","kmInicio","kmFim"].forEach(id=>{
  $(id).addEventListener("change", preencherDerivadosUI);
});

/* ========= Firestore caminhos ========= */
const viagemRef = () => doc(db,"usuarios",uid,"viagemAtual","dados");

/* ========= Carregar Perfil ========= */
async function carregarPerfil(){
  const snap = await getDoc(doc(db,"usuarios",uid));
  if(!snap.exists()) return;

  perfil = snap.data();
  $('dadosUsuarioCard').innerHTML = `
    <div><strong>Motorista:</strong> ${perfil.nome}</div>
    <div><strong>Telefone:</strong> ${perfil.telefone}</div>
    <div><strong>Cavalo:</strong> ${perfil.placaCavalo}</div>
    <div><strong>Reboque:</strong> ${perfil.placaReboque}</div>
  `;
}

/* ========= Carregar Viagem ========= */
async function carregarViagem(){
  const snap = await getDoc(viagemRef());
  if(!snap.exists()) return;

  const d = snap.data();
  $('viagemInicio').value = d.inicio || "";
  $('viagemFim').value = d.fim || "";
  $('kmInicio').value = d.kmInicio ?? "";
  $('kmFim').value = d.kmFim ?? "";
  $('empresaDevia').value = d.empresaDevia ?? 0;
  $('motoristaDevia').value = d.motoristaDevia ?? 0;
  $('diariasRecebidas').value = d.diariasRecebidas ?? 0;
  $('valorDiaria').value = d.valorDiaria ?? 100;

  preencherDerivadosUI();
  recalcularResumo();
}

/* ========= Salvar viagem ========= */
$('salvarViagemBtn').onclick = async ()=>{
  await setDoc(viagemRef(),{
    inicio:$('viagemInicio').value,
    fim:$('viagemFim').value,
    kmInicio:Number($('kmInicio').value||0),
    kmFim:Number($('kmFim').value||0),
    atualizadoEm: serverTimestamp()
  },{merge:true});
  alert("Viagem salva!");
};

/* ========= Limpar Viagem ========= */
$('limparViagemBtn').onclick = async ()=>{
  if(!confirm("Limpar?"))return;
  await setDoc(viagemRef(),{
    inicio:"",fim:"",kmInicio:null,kmFim:null
  });
  location.reload();
};

/* ========= SOMAR AUTOMATICAMENTE TODAS AS DIÁRIAS ========= */
async function carregarDiarias(){
  const q = query(collection(db,"usuarios",uid,"diarias"), orderBy("data","asc"));
  const snap = await getDocs(q);

  diarias = snap.docs.map(d=>({id:d.id,...d.data()}));
  renderDiarias();

  // SOMA AUTOMÁTICA DAS DIÁRIAS
  const totalRecebidas = diarias.reduce((s,d)=>s + Number(d.qtd||0), 0);
  $('diariasRecebidas').value = totalRecebidas;

  // recalcular resumo automaticamente
  recalcularResumo();

  // salvar automaticamente no servidor
  await setDoc(viagemRef(),{
    diariasRecebidas: totalRecebidas,
    atualizadoResumoEm: serverTimestamp()
  },{merge:true});
}

/* ========= Render tabela ========= */
function renderDiarias(){
  const tbody = $('tbodyDiarias');
  tbody.innerHTML = "";

  if(!diarias.length){
    tbody.innerHTML = `<tr><td colspan="4">Nenhuma diária</td></tr>`;
    return;
  }

  diarias.forEach(d=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${fmtBR(d.data)}</td>
      <td>${d.qtd}</td>
      <td>R$ ${(d.qtd * Number($('valorDiaria').value)).toFixed(2)}</td>
      <td><button data-id="${d.id}" class="btn-red btn">Excluir</button></td>
    `;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll("button").forEach(btn=>{
    btn.onclick = async ()=>{
      await deleteDoc(doc(db,"usuarios",uid,"diarias",btn.dataset.id));
      carregarDiarias();
    };
  });
}

/* ========= Adicionar diária ========= */
$('addDiariaBtn').onclick = async ()=>{
  const data = $('diariaData').value;
  const qtd = Number($('diariaQtd').value);

  if(!data){alert("Escolha a data.");return;}

  await addDoc(collection(db,"usuarios",uid,"diarias"),{
    data,qtd,createdAt:serverTimestamp()
  });

  $('diariaData').value="";
  $('diariaQtd').value=1;

  carregarDiarias();
};

/* ========= Resumo de Diárias ========= */
function recalcularResumo(){
  const anteriorEmpresa = Number($('empresaDevia').value||0);
  const anteriorMotorista = Number($('motoristaDevia').value||0);
  const recebidas = Number($('diariasRecebidas').value||0);

  const ini = $('viagemInicio').value;
  const fim = $('viagemFim').value;

  let viajados = 0;
  if(ini && fim){
    viajados = Math.floor((parseISO(fim) - parseISO(ini))/86400000) + 1;
  }

  const prevNet = anteriorEmpresa - anteriorMotorista;
  const travelNet = viajados - recebidas;
  const totalNet = prevNet + travelNet;

  const empresaFinal = totalNet > 0 ? totalNet : 0;
  const motoristaFinal = totalNet < 0 ? Math.abs(totalNet) : 0;

  let texto = "";
  if(empresaFinal>0) texto = `A empresa deve ${empresaFinal} diárias.`;
  else if(motoristaFinal>0) texto = `O motorista deve ${motoristaFinal} diárias.`;
  else texto = "Sem pendências.";

  $('resumoDiariasUI').textContent = texto;

  return {empresaFinal,motoristaFinal,viajados,recebidas};
}

/* ========= Salvar resumo ========= */
$('salvarResumoBtn').onclick = async ()=>{
  await setDoc(viagemRef(),{
    empresaDevia:Number($('empresaDevia').value||0),
    motoristaDevia:Number($('motoristaDevia').value||0),
    diariasRecebidas:Number($('diariasRecebidas').value||0),
    valorDiaria:Number($('valorDiaria').value||100),
    resumoDiarias:recalcularResumo(),
    atualizadoEm:serverTimestamp()
  },{merge:true});
  alert("Resumo salvo!");
};

/* ========= Limpar resumo ========= */
$('limparResumoBtn').onclick = async ()=>{
  if(!confirm("Limpar resumo?"))return;
  $('empresaDevia').value=0;
  $('motoristaDevia').value=0;
  $('diariasRecebidas').value=0;
  $('valorDiaria').value=100;
  $('resumoDiariasUI').textContent="—";
  await setDoc(viagemRef(),{
    empresaDevia:0,motoristaDevia:0,diariasRecebidas:0
  },{merge:true});
};

/* ========= PDF ========= */
$('gerarPDFBtn').onclick = async ()=>{
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({unit:"pt",format:"a4"});
  let y = 40;

  pdf.setFontSize(16).text("Planilha de Viagem — Motorista Plus",40,y); y+=25;

  pdf.setFontSize(12);
  pdf.text(`Motorista: ${perfil?.nome||"-"}`,40,y); y+=16;
  pdf.text(`Placas: ${perfil?.placaCavalo||"-"} / ${perfil?.placaReboque||"-"}`,40,y); y+=20;

  pdf.autoTable({
    startY:y,
    head:[["Início","Fim","Folgas","Retorno","KM Início","KM Fim","Rodado"]],
    body:[[
      fmtBR($('viagemInicio').value),
      fmtBR($('viagemFim').value),
      $('diasFolga').value,
      $('retornoFolga').value,
      $('kmInicio').value,
      $('kmFim').value,
      $('kmRodados').value
    ]],
    margin:{left:40,right:40}
  });

  y = pdf.lastAutoTable.finalY + 20;

  pdf.text("Diárias:",40,y); y+=10;

  pdf.autoTable({
    startY:y,
    head:[["Data","Qtd","Valor"]],
    body:diarias.map(d=>[
      fmtBR(d.data),
      d.qtd,
      `R$ ${(d.qtd * Number($('valorDiaria').value)).toFixed(2)}`
    ]),
    margin:{left:40,right:40}
  });

  y = pdf.lastAutoTable.finalY + 30;

  pdf.text("Resumo Final:",40,y); y+=20;
  pdf.text($('resumoDiariasUI').textContent,40,y);

  pdf.save("planilha_viagem.pdf");
};

/* ========= Export CSV ========= */
$('exportCsvBtn').onclick = ()=>{
  let csv = "data;qtd;valor\n";
  diarias.forEach(d=>{
    csv += `${d.data};${d.qtd};${(d.qtd * $('valorDiaria').value).toFixed(2)}\n`;
  });

  const blob = new Blob([csv],{type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download="diarias.csv"; a.click();
  URL.revokeObjectURL(url);
};

/* ========= Início ========= */
onAuthStateChanged(auth, async user=>{
  if(!user){location.href="login.html";return;}
  uid = user.uid;
  await carregarPerfil();
  await carregarViagem();
  await carregarDiarias();
});
</script>
</body>
</html