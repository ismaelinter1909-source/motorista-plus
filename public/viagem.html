<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Viagem — Motorista Plus</title>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root {
      --bg: #0b0f14;
      --card: #161c23;
      --primary: #f39220;
      --outline: #2b3a49;
      --text: #fff;
      --muted: #b5bcc7;
      --green: #2b9348;
      --red: #dc3545;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,Arial,sans-serif}
    body{background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column}
    header{background:linear-gradient(180deg,rgba(0,0,0,.3),rgba(0,0,0,.6));padding:28px 16px;text-align:center;border-bottom:1px solid var(--outline)}
    header h1{font-weight:800;font-size:clamp(20px,4vw,30px)}
    main{width:94%;max-width:1100px;margin:18px auto 40px;display:grid;gap:14px;flex:1}
    .card{background:var(--card);border:1px solid var(--outline);padding:16px;border-radius:12px;backdrop-filter:blur(6px)}
    h2{color:var(--primary);margin-bottom:8px}
    label{display:block;margin-bottom:6px;color:#e8e8e8;font-size:13px}
    input,textarea,button,select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--outline);background:rgba(255,255,255,.06);color:#fff;font-size:14px;outline:none}
    .grid2{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px}
    .resumo-box{background:rgba(255,255,255,.04);border:1px solid var(--outline);padding:10px;border-radius:8px;margin-top:10px;text-align:center}
    .row{display:flex;gap:10px;align-items:center}
    .btn{background:var(--primary);border:none;color:#fff;padding:10px;border-radius:8px;cursor:pointer}
    .btn-ghost{background:transparent;border:1px solid var(--outline);color:var(--muted)}
    .btn-red{background:var(--red)}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    thead th{background:var(--primary);color:#fff;padding:8px}
    td,th{border:1px solid var(--outline);padding:8px;text-align:center}
    .edit-input{width:70px;background:rgba(255,255,255,.04);border-radius:6px;padding:6px}
    footer{padding:12px;text-align:center;color:var(--muted);border-top:1px solid var(--outline)}
    @media(max-width:520px){ .row{flex-direction:column;align-items:stretch} }
  </style>
</head>
<body>
  <header>
    <h1>Planilha de Viagem — Motorista <span style="color:var(--primary)">Plus</span></h1>
  </header>

  <main>
    <!-- Dados do Motorista -->
    <section class="card">
      <h2>Dados do Motorista</h2>
      <div id="dadosUsuarioCard">Carregando...</div>
    </section>

    <!-- Viagem -->
    <section class="card">
      <h2>Viagem</h2>
      <div class="grid2">
        <div><label>Início</label><input type="date" id="viagemInicio"></div>
        <div><label>Fim</label><input type="date" id="viagemFim"></div>
        <div><label>KM Inicial</label><input type="number" id="kmInicio" placeholder="0"></div>
        <div><label>KM Final</label><input type="number" id="kmFim" placeholder="0"></div>
      </div>

      <div class="grid2" style="margin-top:10px">
        <div><label>Dias Viajados</label><input type="text" id="diasViajados" readonly></div>
        <div><label>Folgas</label><input type="text" id="diasFolga" readonly></div>
        <div><label>Retorno</label><input type="text" id="retornoFolga" readonly></div>
        <div><label>KM Rodados</label><input type="text" id="kmRodados" readonly></div>
      </div>

      <!-- Dívidas anteriores -->
      <div style="margin-top:12px">
        <h3 style="margin-bottom:8px;color:var(--primary)">Dívidas Anteriores</h3>
        <div class="grid2">
          <div>
            <label>Empresa devia (diárias)</label>
            <input type="number" id="empresaDeviaAntes" min="0" value="0">
          </div>
          <div>
            <label>Motorista devia (diárias)</label>
            <input type="number" id="motoristaDeviaAntes" min="0" value="0">
          </div>
        </div>
        <div class="resumo-box" id="resumoDiarias"></div>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="editarViagemBtn" class="btn" style="display:none">Editar viagem</button>
        <button id="salvarViagemBtn" class="btn" style="background:#2b9348">Salvar</button>
      </div>
    </section>

    <!-- Diárias -->
    <section class="card">
      <h2>Diárias</h2>
      <div class="grid2">
        <div><label>Data</label><input type="date" id="diariaData"></div>
        <div><label>Qtd</label><input type="number" id="diariaQtd" min="1" value="1"></div>
      </div>

      <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
        <button id="addDiariaBtn" class="btn">Adicionar</button>
        <button id="exportCsvBtn" class="btn btn-ghost">Exportar CSV</button>
        <span style="align-self:center;color:var(--muted)">Valor por diária: <b>R$ 100,00</b></span>
      </div>

      <div style="overflow-x:auto;margin-top:10px">
        <table>
          <thead>
            <tr><th>Data</th><th>Tipo</th><th>Qtd</th><th>Valor (R$)</th><th>Ações</th></tr>
          </thead>
          <tbody id="tbodyDiarias"></tbody>
        </table>
      </div>
    </section>

    <!-- PDF -->
    <section class="card" style="text-align:center">
      <div style="display:flex;justify-content:center;gap:10px;flex-wrap:wrap">
        <button id="gerarPDFButton" class="btn" style="width:220px">Gerar PDF</button>
        <button id="limparTudoBtn" class="btn btn-red" style="width:220px">Limpar</button>
      </div>
    </section>
  </main>

  <footer>© 2025 Motorista Plus</footer>
  <script type="module">
/* ========================= Firebase ========================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc,
  collection, addDoc, getDocs, deleteDoc, orderBy, query, serverTimestamp
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyCnlpnTTJvJPZxuZdmpKQWbbHtvH72nMUU",
  authDomain: "motorista-plus-c53f4.firebaseapp.com",
  projectId: "motorista-plus-c53f4",
  storageBucket: "motorista-plus-c53f4.firebasestorage.app",
  messagingSenderId: "766097061342",
  appId: "1:766097061342:web:36d999bec6d9fe8c46994f",
  measurementId: "G-CBT2D0CXPN"
});

const auth = getAuth(app);
const db = getFirestore(app);

const $ = id => document.getElementById(id);
const DIARIA_VALOR = 100;

let uid = null;
let perfil = null;
let diarias = [];
let viagemAtual = null;

/* ========================= Helpers data (no timezone issues) ========================= */
const toISO = (date) => {
  const y = date.getFullYear();
  const m = String(date.getMonth()+1).padStart(2,"0");
  const d = String(date.getDate()).padStart(2,"0");
  return `${y}-${m}-${d}`;
};
const parseISO = iso => {
  if(!iso) return null;
  const [y,m,d] = iso.split("-").map(Number);
  return new Date(y, m-1, d);
};
const fmtBR = iso => {
  if(!iso) return "";
  const [y,m,d] = iso.split("-");
  return `${d}/${m}/${y}`;
};
const diasEntreInclusive = (iniISO, fimISO) => {
  const ini = parseISO(iniISO);
  const fim = parseISO(fimISO);
  ini.setHours(0,0,0,0); fim.setHours(0,0,0,0);
  return Math.round((fim - ini) / 86400000) + 1;
};
const calcularFolgasPelasFaixas = dias => {
  if (dias <= 7) return 1;
  if (dias <= 14) return 2;
  if (dias <= 21) return 3;
  if (dias <= 30) return 4;
  if (dias <= 37) return 5;
  if (dias <= 44) return 6;
  if (dias <= 52) return 7;
  if (dias <= 60) return 8;
  return Math.ceil(dias/7);
};

/* ========================= cálculo retorno (correto) ========================= */
const calcularRetorno = (iniISO, fimISO) => {
  if(!iniISO || !fimISO) return null;
  const dias = diasEntreInclusive(iniISO, fimISO);
  const folgas = calcularFolgasPelasFaixas(dias);
  const fim = parseISO(fimISO);
  const primeiro = new Date(fim); primeiro.setDate(primeiro.getDate() + 1);
  const ultimo = new Date(fim); ultimo.setDate(ultimo.getDate() + folgas);
  const retorno = new Date(fim); retorno.setDate(retorno.getDate() + folgas + 1);
  return {
    dias,
    folgas,
    primeiroFolgaISO: toISO(primeiro),
    ultimoFolgaISO: toISO(ultimo),
    retornoISO: toISO(retorno)
  };
};

/* ========================= preencher UI derivado ========================= */
function preencherDerivadosUI(){
  const ini = $('viagemInicio').value;
  const fim = $('viagemFim').value;
  const kmI = Number($('kmInicio').value || 0);
  const kmF = Number($('kmFim').value || 0);

  if(!ini || !fim){
    $('diasViajados').value = '';
    $('diasFolga').value = '';
    $('retornoFolga').value = '';
    $('kmRodados').value = '';
    return;
  }
  const info = calcularRetorno(ini, fim);
  $('diasViajados').value = `${info.dias} dia(s)`;
  $('diasFolga').value = `${info.folgas} dia(s)`;
  $('retornoFolga').value = fmtBR(info.retornoISO);
  $('kmRodados').value = (kmI && kmF) ? (kmF - kmI) : '';
  atualizarResumoDiarias(); // atualiza o resumo sempre que datas/kms mudam
}
["viagemInicio","viagemFim","kmInicio","kmFim","empresaDeviaAntes","motoristaDeviaAntes"].forEach(id=>{
  const el = $(id);
  if(el) el.addEventListener('change', preencherDerivadosUI);
});

/* ========================= carregar perfil ========================= */
async function carregarPerfil(){
  const snap = await getDoc(doc(db,"usuarios",uid));
  if(!snap.exists()) return;
  perfil = snap.data();
  $('dadosUsuarioCard').innerHTML = `
    <div class="item"><strong>Motorista</strong>${perfil.nome||''}</div>
    <div class="item"><strong>Telefone</strong>${perfil.telefone||''}</div>
    <div class="item"><strong>Cavalo</strong>${perfil.placaCavalo||''}</div>
    <div class="item"><strong>Reboque</strong>${perfil.placaReboque||''}</div>
    <div class="item"><strong>Email</strong>${perfil.email||''}</div>
  `;
}

/* ========================= carregar viagem atual (inclui dívidas antigas) ========================= */
async function carregarViagemAtual(){
  const snap = await getDoc(doc(db,"usuarios",uid,"viagemAtual","dados"));
  if(snap.exists()){
    viagemAtual = snap.data();
    if(viagemAtual.inicio) $('viagemInicio').value = viagemAtual.inicio;
    if(viagemAtual.fim) $('viagemFim').value = viagemAtual.fim;
    $('kmInicio').value = viagemAtual.kmInicio ?? '';
    $('kmFim').value = viagemAtual.kmFim ?? '';
    $('empresaDeviaAntes').value = viagemAtual.empresaDeviaAntes ?? 0;
    $('motoristaDeviaAntes').value = viagemAtual.motoristaDeviaAntes ?? 0;

    setFieldsReadonly(true);
    $('editarViagemBtn').style.display = 'inline-block';
    $('salvarViagemBtn').style.display = 'none';
  } else {
    setFieldsReadonly(false);
    $('editarViagemBtn').style.display = 'none';
    $('salvarViagemBtn').style.display = 'inline-block';
  }
  preencherDerivadosUI();
}

/* ========================= bloquear/desbloquear campos ========================= */
function setFieldsReadonly(readonly){
  ['viagemInicio','viagemFim','kmInicio','kmFim','empresaDeviaAntes','motoristaDeviaAntes'].forEach(id=>{
    const el = $(id);
    if(!el) return;
    if(readonly){ el.setAttribute('readonly','readonly'); el.setAttribute('disabled','disabled'); }
    else { el.removeAttribute('readonly'); el.removeAttribute('disabled'); }
  });
}

/* ========================= Diárias (CRUD) ========================= */
async function carregarDiarias(){
  const q = query(collection(db,"usuarios",uid,"diarias"), orderBy("data","asc"));
  const snap = await getDocs(q);
  diarias = snap.docs.map(d=>({ id:d.id, ...d.data() }));
  renderDiarias();
  atualizarResumoDiarias();
}

function renderDiarias(){
  const tbody = $('tbodyDiarias');
  tbody.innerHTML = '';
  if(!diarias.length){ tbody.innerHTML = '<tr><td colspan="5">(nenhuma)</td></tr>'; return; }
  diarias.forEach(d=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${fmtBR(d.data)}</td>
      <td>Diária</td>
      <td><input data-id="${d.id}" class="edit-input" type="number" min="1" value="${d.qtd}"></td>
      <td>${(Number(d.qtd)*DIARIA_VALOR).toFixed(2)}</td>
      <td>
        <button class="btn" data-act="save" data-id="${d.id}">Salvar</button>
        <button class="btn btn-red" data-act="del" data-id="${d.id}">Excluir</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('button').forEach(btn=>{
    btn.onclick = async ()=>{
      const id = btn.dataset.id;
      if(btn.dataset.act === 'del'){
        await deleteDoc(doc(db,"usuarios",uid,"diarias",id));
      } else {
        const qtd = Number(document.querySelector(`input[data-id="${id}"]`).value) || 0;
        await updateDoc(doc(db,"usuarios",uid,"diarias",id), { qtd });
      }
      await carregarDiarias();
    };
  });
}

/* ========================= atualizar resumo de diárias (tela) ========================= */
function atualizarResumoDiarias(){
  const ini = $('viagemInicio').value;
  const fim = $('viagemFim').value;
  if(!ini || !fim){ $('resumoDiarias').textContent = 'Preencha período para ver resumo.'; return; }

  const info = calcularRetorno(ini,fim);
  const diasViajados = info.dias;
  const recebidas = diarias.reduce((s,d)=>s + Number(d.qtd||0), 0);

  const empresaAntes = Number($('empresaDeviaAntes').value || 0);
  const motoristaAntes = Number($('motoristaDeviaAntes').value || 0);

  // net diárias após considerar anteriores: positivo => empresa deve ao motorista
  const netDiarias = (recebidas - diasViajados) + (empresaAntes - motoristaAntes);
  const netValor = Math.abs(netDiarias) * DIARIA_VALOR;

  let msg = `Diárias recebidas: ${recebidas}. Dias viajados: ${diasViajados}.`;
  if(empresaAntes || motoristaAntes) msg += ` (anteriores — empresa: ${empresaAntes}, motorista: ${motoristaAntes})`;

  if(netDiarias === 0) {
    msg += ` Situação: Tudo quites (0 diárias pendentes).`;
  } else if(netDiarias > 0) {
    msg += ` Situação: A EMPRESA DEVE ${netDiarias} diária(s) (R$ ${netValor.toFixed(2)}).`;
  } else {
    msg += ` Situação: O MOTORISTA DEVE ${Math.abs(netDiarias)} diária(s) (R$ ${netValor.toFixed(2)}).`;
  }

  $('resumoDiarias').textContent = msg;
}

/* ========================= salvar/atualizar viagem ========================= */
$('editarViagemBtn').onclick = ()=>{
  setFieldsReadonly(false);
  $('editarViagemBtn').style.display = 'none';
  $('salvarViagemBtn').style.display = 'inline-block';
};

$('salvarViagemBtn').onclick = async ()=>{
  const ini = $('viagemInicio').value;
  const fim = $('viagemFim').value;
  const kmI = $('kmInicio').value ? Number($('kmInicio').value) : null;
  const kmF = $('kmFim').value ? Number($('kmFim').value) : null;
  const empresaAntes = Number($('empresaDeviaAntes').value || 0);
  const motoristaAntes = Number($('motoristaDeviaAntes').value || 0);

  if(!ini){ alert("Preencha pelo menos a data inicial."); return; }

  const dados = {
    inicio: ini,
    kmInicio: kmI,
    updatedAt: serverTimestamp(),
    empresaDeviaAntes,
    motoristaDeviaAntes
  };
  if(fim) dados.fim = fim;
  if(kmF !== null) dados.kmFim = kmF;

  await setDoc(doc(db,"usuarios",uid,"viagemAtual","dados"), dados, { merge:true });

  setFieldsReadonly(true);
  $('editarViagemBtn').style.display = 'inline-block';
  $('salvarViagemBtn').style.display = 'none';
  await carregarViagemAtual();
};

/* ========================= adicionar diária ========================= */
$('addDiariaBtn').onclick = async ()=>{
  const data = $('diariaData').value;
  const qtd = Number($('diariaQtd').value || 0);
  if(!data || qtd <= 0){ alert("Selecione data e quantidade >= 1"); return; }
  await addDoc(collection(db,"usuarios",uid,"diarias"), { data, qtd, createdAt: serverTimestamp() });
  $('diariaQtd').value = 1;
  $('diariaData').value = '';
  await carregarDiarias();
};

/* ========================= export CSV ========================= */
$('exportCsvBtn').onclick = ()=>{
  if(!diarias.length){ alert("Nenhuma diária para exportar."); return; }
  let csv = "Data,Tipo,Qtd,Valor\n";
  diarias.forEach(d => csv += `${d.data},Diária,${d.qtd},${(d.qtd*DIARIA_VALOR).toFixed(2)}\n`);
  const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'diarias.csv'; a.click();
  URL.revokeObjectURL(url);
};

/* ========================= limpar tudo ========================= */
$('limparTudoBtn').onclick = async ()=>{
  if(!confirm("Realmente limpar toda a viagem e diárias?")) return;
  await setDoc(doc(db,"usuarios",uid,"viagemAtual","dados"), {}, { merge:false });
  const snap = await getDocs(collection(db,"usuarios",uid,"diarias"));
  await Promise.all(snap.docs.map(d=> deleteDoc(d.ref)));
  location.reload();
};

/* ========================= gerar PDF ========================= */
$('gerarPDFButton').onclick = async ()=>{
  await carregarDiarias();

  const ini = $('viagemInicio').value;
  const fim = $('viagemFim').value;
  if(!ini || !fim){ alert("Preencha período de viagem."); return; }

  const info = calcularRetorno(ini,fim);
  const kmInicial = $('kmInicio').value ? Number($('kmInicio').value) : null;
  const kmFinal = $('kmFim').value ? Number($('kmFim').value) : null;

  const recebidas = diarias.reduce((s,d)=>s + Number(d.qtd||0), 0);
  const empresaAntes = Number($('empresaDeviaAntes').value || 0);
  const motoristaAntes = Number($('motoristaDeviaAntes').value || 0);
  const diasViajados = info.dias;
  const netDiarias = (recebidas - diasViajados) + (empresaAntes - motoristaAntes);
  const netValor = Math.abs(netDiarias) * DIARIA_VALOR;

  const { jsPDF } = window.jspdf;
  const docpdf = new jsPDF({ unit:"pt", format:"a4" });
  const x = 40;
  let y = 40;

  docpdf.setFontSize(16).text("Planilha de Viagem — Motorista Plus", x, y); y += 26;
  docpdf.setFontSize(12);
  docpdf.text(`Motorista: ${perfil?.nome || ''}`, x, y); y += 16;
  docpdf.text(`Placas: ${(perfil?.placaCavalo || '')} / ${(perfil?.placaReboque || '')}`, x, y); y += 16;
  docpdf.text(`Período: ${fmtBR(ini)}  —  ${fmtBR(fim)}`, x, y); y += 18;

  // tabela resumo viagem (uma linha)
  docpdf.autoTable({
    startY: y,
    head: [["Data Início","Data Final","1º Folga","Últ Dia Folga","Retorno","KM Início","KM Final","KM Rodado"]],
    body: [[
      fmtBR(ini),
      fmtBR(fim),
      fmtBR(info.primeiroFolgaISO),
      fmtBR(info.ultimoFolgaISO),
      fmtBR(info.retornoISO),
      kmInicial ?? "-",
      kmFinal ?? "-",
      (kmInicial && kmFinal) ? (kmFinal - kmInicial) : "-"
    ]],
    margin:{ left:x, right:x },
    headStyles:{ fillColor:[243,146,32] },
    styles:{ fontSize:10 }
  });
  y = docpdf.lastAutoTable.finalY + 14;

  // tabela folgas (linhas)
  const folgasBody = [];
  let d = parseISO(info.primeiroFolgaISO);
  const ultimo = parseISO(info.ultimoFolgaISO);
  while(d <= ultimo){
    folgasBody.push([ fmtBR(toISO(d)), "Folga" ]);
    d.setDate(d.getDate() + 1);
  }
  docpdf.autoTable({
    startY: y,
    head: [["Data","Tipo"]],
    body: folgasBody,
    margin:{ left:x, right:x },
    headStyles:{ fillColor:[243,146,32] },
    styles:{ fontSize:10 }
  });
  y = docpdf.lastAutoTable.finalY + 14;

  // tabela diárias
  docpdf.autoTable({
    startY: y,
    head: [["Data","Tipo","Qtd","Valor (R$)"]],
    body: diarias.map(d=>[ fmtBR(d.data), "Diária", d.qtd, (Number(d.qtd)*DIARIA_VALOR).toFixed(2) ]),
    margin:{ left:x, right:x },
    headStyles:{ fillColor:[243,146,32] },
    styles:{ fontSize:10 }
  });
  y = docpdf.lastAutoTable.finalY + 14;

  // resumo financeiro das diárias (com dívidas anteriores)
  docpdf.setFontSize(12).text("Resumo de Diárias e Situação", x, y); y += 16;
  docpdf.setFontSize(10);
  docpdf.text(`Diárias recebidas: ${recebidas} (R$ ${(recebidas*DIARIA_VALOR).toFixed(2)})`, x, y); y += 14;
  docpdf.text(`Dias viajados: ${diasViajados}`, x, y); y += 14;
  docpdf.text(`Empresa devia antes: ${empresaAntes} diária(s)`, x, y); y += 14;
  docpdf.text(`Motorista devia antes: ${motoristaAntes} diária(s)`, x, y); y += 14;

  if(netDiarias === 0){
    docpdf.text(`Situação final: Tudo quites (0 diárias pendentes).`, x, y); y += 14;
  } else if(netDiarias > 0){
    docpdf.text(`Situação final: A EMPRESA DEVE ${netDiarias} diária(s) — R$ ${netValor.toFixed(2)}`, x, y); y += 14;
  } else {
    docpdf.text(`Situação final: O MOTORISTA DEVE ${Math.abs(netDiarias)} diária(s) — R$ ${netValor.toFixed(2)}`, x, y); y += 14;
  }
  y += 18;

  // assinatura
  const pageWidth = docpdf.internal.pageSize.getWidth();
  docpdf.line(pageWidth/2 - 140, y, pageWidth/2 + 140, y);
  docpdf.setFontSize(11);
  docpdf.text("Assinatura do Motorista", pageWidth/2, y + 16, { align: "center" });

  docpdf.save("planilha_viagem.pdf");
};

/* ========================= Login (inicia) ========================= */
onAuthStateChanged(auth, async user=>{
  if(!user) return window.location.href = "index.html";
  uid = user.uid;
  await carregarPerfil();
  await carregarViagemAtual();
  await carregarDiarias();
});

</script>
</body>
</html>