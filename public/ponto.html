<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Registro de Ponto — Motorista Plus</title>

<!-- jsPDF + AutoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
  :root {
    --bg:#0b0f14; --bg2:#10161d; --card:#161c23;
    --primary:#f39220; --primary-700:#d47e16;
    --outline:#2b3a49; --text:#fff; --muted:#b5bcc7;
  }
  *{margin:0;padding:0;box-sizing:border-box;font-family:system-ui,Arial,sans-serif}
  body{background:var(--bg);color:var(--text);min-height:100vh}

  #btnVoltar{position:fixed;top:12px;left:12px;z-index:9999;padding:8px 14px;background:rgba(255,255,255,.08);
    color:#fff;border:1px solid rgba(255,255,255,.25);border-radius:8px;cursor:pointer;font-size:14px}
  #btnVoltar:hover{background:rgba(255,255,255,.16)}

  header{text-align:center;padding:30px 16px;border-bottom:1px solid var(--outline);
    background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.85))}
  header h1{font-size:clamp(22px,5vw,34px);font-weight:800}
  header .plus{color:var(--primary)}

  main{width:95%;max-width:1000px;margin:18px auto 36px}
  .card{background:var(--card);border:1px solid var(--outline);padding:16px;border-radius:12px;backdrop-filter:blur(6px);margin-bottom:14px}
  h2{color:var(--primary);margin-bottom:8px}

  label{display:block;font-size:13px;margin:6px 0 4px}
  input,select,button{width:100%;padding:12px;border-radius:10px;border:1px solid var(--outline);background:#0f141a;color:#fff}
  select option{background:#0f141a;color:#fff}

  .btn{background:var(--primary);border:none;font-weight:700;cursor:pointer}
  .btn:hover{background:var(--primary-700)}

  .btn-ghost{background:transparent;color:var(--muted)}
  .btn-ghost:hover{background:rgba(255,255,255,.06)}

  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px}
  .buttons{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}

  #dadosUsuarioCard{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
  #dadosUsuarioCard .item{background:rgba(255,255,255,.06);border:1px solid var(--outline);padding:10px;border-radius:10px;text-align:center}
  #dadosUsuarioCard .item strong{color:var(--primary);display:block;margin-bottom:4px}

  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
  th,td{border:1px solid var(--outline);padding:8px;text-align:center}
  th{background:var(--primary);color:#fff}

  .edit{background:#ffa500;color:#000;border:none;padding:6px 10px;border-radius:8px;font-weight:700;cursor:pointer}

  footer{text-align:center;padding:12px;color:var(--muted);border-top:1px solid var(--outline)}
</style>
</head>
<body>

<button id="btnVoltar" onclick="window.location.href='painel.html'">← Voltar</button>

<header>
  <h1>Registro de Ponto — Motorista<span class="plus">Plus</span></h1>
</header>

<main>
  <section class="card">
    <h2>Dados do Motorista</h2>
    <div id="dadosUsuarioCard" class="muted">Carregando...</div>
  </section>

  <section class="card">
    <h2>Registrar Ponto (Hoje)</h2>
    <div class="buttons">
      <button class="btn" data-tipo="inicio">Início</button>
      <button class="btn" data-tipo="intervalo">Intervalo</button>
      <button class="btn" data-tipo="reinicio">Reinício</button>
      <button class="btn" data-tipo="fim">Fim</button>
    </div>
    <p id="status" class="muted" style="margin-top:6px"></p>
  </section>

  <section class="card">
    <h2>Selecionar Mês</h2>
    <div class="grid">
      <div>
        <label for="mesSelect">Mês</label>
        <select id="mesSelect">
          <option value="0">Janeiro</option><option value="1">Fevereiro</option>
          <option value="2">Março</option><option value="3">Abril</option>
          <option value="4">Maio</option><option value="5">Junho</option>
          <option value="6">Julho</option><option value="7">Agosto</option>
          <option value="8">Setembro</option><option value="9">Outubro</option>
          <option value="10">Novembro</option><option value="11">Dezembro</option>
        </select>
      </div>
    </div>
    <button id="exportPdfBtn" class="btn" style="margin-top:10px;background:#2b9348">Gerar PDF</button>
  </section>

  <section class="card">
    <h2>Histórico de Registros</h2>
    <button id="toggleHistorico" class="btn-ghost" style="width:auto">Mostrar Histórico</button>
    <table id="tableRegistros" style="display:none">
      <thead>
        <tr>
          <th>Data</th><th>Início</th><th>Intervalo</th><th>Reinício</th><th>Fim</th><th>Extras</th><th>Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<footer>© 2025 Motorista Plus</footer>

<script type="module">
  /* ======================= FIREBASE ======================= */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc,
    collection, getDocs, query, orderBy, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const app = initializeApp({
    apiKey:"AIzaSyCnlpnTTJvJPZxuZdmpKQWbbHtvH72nMUU",
    authDomain:"motorista-plus-c53f4.firebaseapp.com",
    projectId:"motorista-plus-c53f4"
  });

  const auth = getAuth(app);
  const db = getFirestore(app);

  const $ = id => document.getElementById(id);
  const pad2 = n => String(n).padStart(2,"0");

  /* =========== FORMATOS =========== */

  const fromISOtoBR = iso => {
    if (!iso) return "";
    const [y,m,d] = iso.split("-");
    return `${d}/${m}/${y}`;
  };

  const hojeISO = () => {
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  };

  const diasNoMes = (ano,mes)=>{
    const padrao=[31,28,31,30,31,30,31,31,30,31,30,31];
    const biss = (ano%4===0 && ano%100!==0) || ano%400===0;
    return mes===1 ? padrao[1] + (biss?1:0) : padrao[mes];
  };

  const timeNow = ()=>new Date().toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit",second:"2-digit"});

  let uid=null;
  let perfil=null;

  /* ========== PERFIL ========== */

  async function carregarPerfil(){
    const snap = await getDoc(doc(db,"usuarios",uid));
    if(!snap.exists()){ $('dadosUsuarioCard').textContent="Perfil não encontrado."; return; }

    perfil = snap.data();
    $('dadosUsuarioCard').innerHTML = `
      <div class="item"><strong>Motorista</strong>${perfil.nome}</div>
      <div class="item"><strong>Telefone</strong>${perfil.telefone}</div>
      <div class="item"><strong>Email</strong>${perfil.email}</div>
      <div class="item"><strong>Cavalo</strong>${perfil.placaCavalo}</div>
      <div class="item"><strong>Reboque</strong>${perfil.placaReboque}</div>
    `;
  }

  /* ========== CRUD ========== */

  async function getDocDia(iso){
    const ref = doc(db,"usuarios",uid,"pontos",iso);
    const snap = await getDoc(ref);
    return snap.exists() ? snap.data() : null;
  }

  async function marcar(tipo){
    const iso = hojeISO();
    const ref = doc(db,"usuarios",uid,"pontos",iso);
    const atual = await getDocDia(iso);
    const agora = timeNow();

    const base = { data: iso };

    if(atual){
      await updateDoc(ref,{...base,[tipo]:agora,updatedAt:serverTimestamp()});
    } else {
      await setDoc(ref,{
        ...base,inicio:null,intervalo:null,reinicio:null,fim:null,
        [tipo]:agora,createdAt:serverTimestamp()
      });
    }

    $('status').textContent = `Registrado ${tipo} às ${agora}`;
    renderTabela();
  }

  /* ========== FILTRO PRECISO (YYYY-MM-) ========== */

  async function carregarMes(mes,ano){
    const col = collection(db,"usuarios",uid,"pontos");
    const qy = query(col,orderBy("data","asc"));
    const snaps = await getDocs(qy);

    const prefix = `${ano}-${pad2(mes+1)}-`;

    const lista=[];
    snaps.forEach(s=>{
      const d=s.data().data;
      if(d.startsWith(prefix)) lista.push(s.data());
    });

    return lista;
  }

  /* ========== CÁLCULO HORAS EXTRAS ========== */

  function horasExtras(reg){
    if(!reg.inicio || !reg.fim) return "Folga";
    const [ih,im,is] = reg.inicio.split(":").map(Number);
    const [fh,fm,fs] = reg.fim.split(":").map(Number);

    const start = new Date(0,0,0,ih,im,is||0);
    const end   = new Date(0,0,0,fh,fm,fs||0);

    const h = (end-start)/3600000;
    if(h<=0 || isNaN(h)) return "Folga";

    return Math.max(0,h-8).toFixed(2);
  }

  /* ========== TABELA ========== */

  async function renderTabela(){
    const mes = parseInt($('mesSelect').value);
    const ano = new Date().getFullYear();
    const dias = diasNoMes(ano,mes);

    const registros = await carregarMes(mes,ano);

    const map={};
    registros.forEach(r=> map[r.data] = r);

    const tbody = $('tableRegistros').querySelector('tbody');
    tbody.innerHTML="";

    for(let d=1; d<=dias; d++){
      const iso = `${ano}-${pad2(mes+1)}-${pad2(d)}`;
      const r = map[iso] || {};

      const inicio    = r.inicio    || "Folga";
      const intervalo = r.intervalo || "Folga";
      const reinicio  = r.reinicio  || "Folga";
      const fim       = r.fim       || "Folga";
      const extras    = horasExtras(r);

      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${fromISOtoBR(iso)}</td>
        <td>${inicio}</td>
        <td>${intervalo}</td>
        <td>${reinicio}</td>
        <td>${fim}</td>
        <td>${extras}</td>
        <td><button class="edit" data-iso="${iso}">Editar</button></td>
      `;
      tbody.appendChild(tr);
    }

    /* editar */
    tbody.querySelectorAll(".edit").forEach(btn=>{
      btn.onclick = async ()=>{
        const iso = btn.dataset.iso;
        const reg = map[iso] || {};

        const campos=["inicio","intervalo","reinicio","fim"];
        const novos={};

        for(const c of campos){
          const v = prompt(`Editar ${c} (${fromISOtoBR(iso)}):`, reg[c] || "");
          if(v===null) continue;
          novos[c] = v.trim()==="" ? null : v.trim();
        }

        const ref = doc(db,"usuarios",uid,"pontos",iso);
        const existe = await getDocDia(iso);

        if(existe){
          await updateDoc(ref,{...novos,updatedAt:serverTimestamp()});
        } else {
          await setDoc(ref,{
            data:iso,inicio:null,intervalo:null,reinicio:null,fim:null,
            ...novos,createdAt:serverTimestamp()
          });
        }

        renderTabela();
      };
    });

  }

  /* ========== PDF ========== */

  $('exportPdfBtn').onclick = async ()=>{
    const {jsPDF}=window.jspdf;
    const pdf = new jsPDF({unit:"pt",format:"a4",orientation:"landscape"});

    const mes = parseInt($('mesSelect').value);
    const ano = new Date().getFullYear();
    const meses = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto",
                   "Setembro","Outubro","Novembro","Dezembro"];

    const dias = diasNoMes(ano,mes);

    const lista = await carregarMes(mes,ano);
    const map={}; lista.forEach(r=> map[r.data]=r);

    const rows=[];
    for(let d=1; d<=dias; d++){
      const iso = `${ano}-${pad2(mes+1)}-${pad2(d)}`;
      const r = map[iso] || {};

      rows.push([
        fromISOtoBR(iso),
        r.inicio    || "Folga",
        r.intervalo || "Folga",
        r.reinicio  || "Folga",
        r.fim       || "Folga",
        horasExtras(r)
      ]);
    }

    const w = pdf.internal.pageSize.getWidth();

    pdf.setFontSize(18);
    pdf.text("Motorista Plus — Registro de Ponto", w/2, 32, {align:"center"});

    pdf.setFontSize(10);
    pdf.text(`Motorista: ${perfil.nome}`,40,55);
    pdf.text(`Telefone: ${perfil.telefone}`,250,55);
    pdf.text(`Mês: ${meses[mes]} / ${ano}`, w-140,55);

    pdf.autoTable({
      startY:65,
      head:[["Data","Início","Intervalo","Reinício","Fim","Extras"]],
      body:rows,
      theme:"grid",
      styles:{fontSize:7,halign:"center"},
      headStyles:{fillColor:[243,146,32]}
    });

    pdf.save(`ponto_${meses[mes]}_${ano}.pdf`);
  };

  /* ========== EVENTOS ========== */

  $('toggleHistorico').onclick = ()=>{
    const t = $('tableRegistros');
    t.style.display = t.style.display==="none" ? "table" : "none";
  };

  $('mesSelect').addEventListener("change",renderTabela);

  /* ========== AUTH ========== */

  onAuthStateChanged(auth, async (user)=>{
    if(!user){ window.location.href="login.html"; return; }

    uid = user.uid;
    await carregarPerfil();
    $('mesSelect').value = new Date().getMonth();
    await renderTabela();
  });

</script>

</body>
</html>