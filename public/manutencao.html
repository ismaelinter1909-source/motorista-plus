<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Manutenção — Motorista Plus</title>

  <!-- jsPDF + autoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --bg:#0b0f14; 
      --bg2:#10161d; 
      --card:#161c23;
      --primary:#f39220; 
      --primary-700:#d47e16;
      --outline:#2b3a49; 
      --text:#fff; 
      --muted:#b5bcc7;
      --green:#2b9348; 
      --red:#dc3545; 
      --info:#0077b6;
    }

    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family:system-ui,Arial,sans-serif
    }

    body{
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      flex-direction:column
    }

    #voltarPainel{
      position:fixed;
      top:12px;
      left:12px;
      z-index:9999;
      padding:8px 14px;
      border-radius:8px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.25);
      color:#fff;
      cursor:pointer;
      backdrop-filter:blur(4px);
      width:auto;
    }

    header{
      background:linear-gradient(180deg,rgba(0,0,0,.3),rgba(0,0,0,.6));
      padding:30px 16px;
      text-align:center;
      border-bottom:1px solid var(--outline)
    }

    header h1{
      font-size:clamp(20px,4vw,30px);
      font-weight:800
    }

    .plus{color:var(--primary)}

    main{
      width:94%;
      max-width:1100px;
      margin:18px auto;
      flex:1;
      display:grid;
      gap:14px
    }

    .card{
      background:var(--card);
      padding:16px;
      border-radius:12px;
      border:1px solid var(--outline);
      backdrop-filter:blur(6px)
    }

    h2{
      color:var(--primary);
      margin-bottom:8px;
      font-size:1.15rem
    }

    label{
      display:block;
      font-size:13px;
      margin-top:8px;
      color:#e8e8e8
    }

    input,textarea,button{
      width:100%;
      padding:12px;
      border-radius:10px;
      background:rgba(255,255,255,.08);
      border:1px solid var(--outline);
      color:#fff;
      font-size:14px;
    }

    textarea{min-height:90px;resize:vertical}

    .btn{
      background:var(--primary);
      border:none;
      font-weight:700;
      cursor:pointer
    }

    .btn:hover{
      background:var(--primary-700)
    }

    .btn-red{
      background:var(--red);
      color:white;
    }

    .btn-red:hover{filter:brightness(1.05)}

    .btn-ghost{
      background:transparent;
      border:1px solid var(--outline);
      color:var(--muted)
    }

    ul{list-style:none;margin-top:8px;padding:0}

    li{
      background:rgba(255,255,255,.05);
      border:1px solid var(--outline);
      padding:10px;
      border-radius:10px;
      margin-bottom:8px;
      display:flex;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:10px
    }

    footer{
      text-align:center;
      color:var(--muted);
      padding:12px;
      margin-top:20px
    }

    /* preview fotos */
    #previewFotos img{
      width:120px;
      height:auto;
      margin:6px;
      border-radius:8px;
      border:1px solid var(--outline);
    }
  </style>
</head>

<body>

<button id="voltarPainel" onclick="location.href='painel.html'">← Voltar</button>

<header>
  <h1>Manutenção — Motorista<span class="plus">Plus</span></h1>
</header>

<main>

  <!-- Perfil -->
  <section class="card">
    <h2>Dados do Motorista</h2>
    <div id="dadosUsuarioCard">Carregando...</div>
  </section>

  <!-- Folga -->
  <section class="card">
    <h2>Folga (cálculo automático)</h2>

    <label>Data de Início</label>
    <input type="date" id="inicioFolga">

    <label>Data de Fim</label>
    <input type="date" id="fimFolga">

    <label>Dias de Folga Calculados</label>
    <input type="text" id="diasFolga" readonly>

    <label>Retorno da Folga</label>
    <input type="text" id="retornoFolga" readonly>

    <button class="btn" id="calcFolga">Calcular</button>
    <button class="btn-ghost" id="limparFolga">Limpar</button>
  </section>

  <!-- Registrar manutenção -->
  <section class="card">
    <h2>Registrar Manutenção</h2>

    <label>Data</label>
    <input type="date" id="dataManutencao">

    <label>Descrição Cavalo</label>
    <textarea id="descCavalo"></textarea>

    <label>Descrição Reboque</label>
    <textarea id="descReboque"></textarea>

    <label>Fotos (opcional)</label>
    <input type="file" id="fotoManutencao" accept="image/*" capture="environment" multiple>
    <div id="previewFotos"></div>

    <button class="btn" id="salvar">Salvar</button>
    <button class="btn-ghost" id="cancelarEdicao" style="display:none">Cancelar Edição</button>
    <button class="btn-red" id="apagarTodos">Apagar TODOS</button>

    <p id="status" style="color:#ccc;margin-top:6px"></p>
  </section>

  <!-- Lista -->
  <section class="card">
    <h2>Lista de Manutenções</h2>
    <ul id="lista"></ul>
  </section>

  <!-- Export -->
  <section class="card" style="text-align:center">
    <button class="btn" id="pdfCompleto">Gerar PDF Completo</button>
  </section>

</main>

<footer>© 2025 Motorista Plus</footer>

<!-- SCRIPT -->
<script type="module">
  /* ========================= Firebase ========================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import {
  getFirestore, doc, getDoc, addDoc, updateDoc, deleteDoc,
  collection, getDocs, query, orderBy, onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import {
  getStorage, ref as storageRef, uploadBytes, getDownloadURL
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

const app = initializeApp({
  apiKey: "AIzaSyCnlpnTTJvJPZxuZdmpKQWbbHtvH72nMUU",
  authDomain: "motorista-plus-c53f4.firebaseapp.com",
  projectId: "motorista-plus-c53f4",
  storageBucket: "motorista-plus-c53f4.firebasestorage.app",
  messagingSenderId: "766097061342",
  appId: "1:766097061342:web:36d999bec6d9fe8c46994f",
  measurementId: "G-CBT2D0CXPN"
});

const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const $ = id => document.getElementById(id);

let uid = null;
let manutencoes = [];
let editId = null;

let fotosParaUpload = [];
let fotosPreview = [];

/* ========================= Helpers ========================= */
const parseISO = iso => {
  const [y,m,d] = iso.split("-").map(Number);
  return new Date(y, m-1, d);
};

const toISO = (date) => {
  const y = date.getFullYear();
  const m = String(date.getMonth()+1).padStart(2,"0");
  const d = String(date.getDate()).padStart(2,"0");
  return `${y}-${m}-${d}`;
};

const fmtBR = iso => {
  if(!iso) return "";
  const [y,m,d] = iso.split("-");
  return `${d}/${m}/${y}`;
};

/* ========================= Folga (igual página viagem) ========================= */
function calcularFolgasPelasFaixas(dias){
  if (dias <= 7) return 1;
  if (dias <= 14) return 2;
  if (dias <= 21) return 3;
  if (dias <= 30) return 4;
  if (dias <= 37) return 5;
  if (dias <= 44) return 6;
  if (dias <= 52) return 7;
  if (dias <= 60) return 8;
  return Math.ceil(dias/7);
}

function calcularRetornoFolga(iniISO, fimISO){
  const ini = parseISO(iniISO);
  const fim = parseISO(fimISO);

  const dias = Math.round((fim - ini)/86400000) + 1;
  const folgas = calcularFolgasPelasFaixas(dias);

  const primeiro = new Date(fim);
  primeiro.setDate(primeiro.getDate()+1);

  const ultimo = new Date(fim);
  ultimo.setDate(ultimo.getDate()+folgas);

  const retorno = new Date(fim);
  retorno.setDate(retorno.getDate()+folgas+1);

  return {
    dias,
    folgas,
    primeiroFolgaISO: toISO(primeiro),
    ultimoFolgaISO: toISO(ultimo),
    retornoISO: toISO(retorno)
  };
}

/* ========================= Visualizar fotos ========================= */
const inputFotos = $("fotoManutencao");
const previewDiv = $("previewFotos");

if (inputFotos) {
  inputFotos.addEventListener("change", async e => {
    fotosParaUpload = Array.from(e.target.files);
    fotosPreview = [];
    previewDiv.innerHTML = "";

    for (const file of fotosParaUpload) {
      const reader = new FileReader();
      reader.onload = () => {
        fotosPreview.push(reader.result);
        const img = document.createElement("img");
        img.src = reader.result;
        previewDiv.appendChild(img);
      };
      reader.readAsDataURL(file);
    }
  });
}

/* ========================= Perfil ========================= */
async function carregarPerfil(){
  const snap = await getDoc(doc(db, "usuarios", uid));
  if (!snap.exists()) return;

  const p = snap.data();
  $("dadosUsuarioCard").innerHTML = `
    <div class="item"><strong>Motorista</strong>${p.nome}</div>
    <div class="item"><strong>Telefone</strong>${p.telefone}</div>
    <div class="item"><strong>Cavalo</strong>${p.placaCavalo}</div>
    <div class="item"><strong>Reboque</strong>${p.placaReboque}</div>
    <div class="item"><strong>Email</strong>${p.email}</div>
  `;
}

/* ========================= Stream da lista ========================= */
function iniciarStream(){
  const qRef = query(
    collection(db,"usuarios",uid,"manutencoes"),
    orderBy("criadoEm","desc")
  );
  onSnapshot(qRef, snap => {
    manutencoes = snap.docs.map(d => ({ id:d.id, ...d.data() }));
    renderLista();
  });
}

/* ========================= Render lista ========================= */
function renderLista(){
  const lista = $("lista");

  if (manutencoes.length === 0){
    lista.innerHTML = `<li>(nenhuma manutenção)</li>`;
    return;
  }

  lista.innerHTML = manutencoes.map(m => `
    <li>
      <div style="flex:1">
        <div style="font-weight:700">Manutenção — ${fmtBR(m.data)}</div>
        <div style="color:#bbb">Cavalo: ${m.cavalo || "—"} • Reboque: ${m.reboque || "—"}</div>
        ${m.fotos?.length ? `
          <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
            ${m.fotos.slice(0,4).map(f=>`<img src="${f}" style="width:70px;border-radius:6px;border:1px solid #333">`).join("")}
          </div>
        ` : ""}
      </div>

      <div style="display:flex;gap:8px">
        <button class="btn" data-act="edit" data-id="${m.id}">Editar</button>
        <button class="btn-red" data-act="del" data-id="${m.id}">Remover</button>
      </div>
    </li>
  `).join("");

  document.querySelectorAll("button[data-act]").forEach(btn=>{
    btn.onclick = async () => {
      const id = btn.dataset.id;
      const act = btn.dataset.act;

      if (act === "edit") {
        const m = manutencoes.find(x => x.id === id);

        $("dataManutencao").value = m.data;
        $("descCavalo").value = m.cavalo || "";
        $("descReboque").value = m.reboque || "";

        previewDiv.innerHTML = "";
        fotosParaUpload = [];
        fotosPreview = [];

        if (m.fotos) {
          m.fotos.forEach(url=>{
            const img = document.createElement("img");
            img.src = url;
            previewDiv.appendChild(img);
          });
        }

        editId = id;
        $("cancelarEdicao").style.display = "block";
      }

      if (act === "del") {
        if (confirm("Excluir este registro?")) {
          await deleteDoc(doc(db,"usuarios",uid,"manutencoes",id));
        }
      }
    };
  });
}

/* ========================= Cancelar edição ========================= */
$("cancelarEdicao").onclick = () => {
  editId = null;
  $("cancelarEdicao").style.display = "none";
  $("dataManutencao").value = "";
  $("descCavalo").value = "";
  $("descReboque").value = "";
  fotosParaUpload = [];
  fotosPreview = [];
  previewDiv.innerHTML = "";
};

/* ========================= Apagar TODOS ========================= */
$("apagarTodos").onclick = async () => {
  if (!confirm("Excluir todas as manutenções?")) return;

  const all = await getDocs(collection(db,"usuarios",uid,"manutencoes"));
  for (const d of all.docs) await deleteDoc(d.ref);
};

/* ========================= REDUZIR FOTO ANTES DO UPLOAD ========================= */
async function resizeImage(file, maxWidth = 1200) {
  return new Promise(resolve => {
    const img = new Image();
    const reader = new FileReader();

    reader.onload = () => {
      img.onload = () => {
        const canvas = document.createElement("canvas");
        const ratio = img.width / img.height;
        canvas.width = maxWidth;
        canvas.height = maxWidth / ratio;

        canvas.getContext("2d").drawImage(img, 0, 0, canvas.width, canvas.height);

        canvas.toBlob(blob => {
          resolve(new File([blob], file.name, { type:"image/jpeg" }));
        }, "image/jpeg", 0.8);
      };
      img.src = reader.result;
    };
    reader.readAsDataURL(file);
  });
}

/* ========================= UPLOAD DE FOTOS ========================= */
async function enviarFotos(files){
  if (!files.length) return [];

  const urls = [];

  for (const file of files){
    const reduced = await resizeImage(file);
    const name = Date.now() + "_" + file.name.replace(/\s+/g,"_");
    const path = `manutencoes/${uid}/${name}`;
    const refFile = storageRef(storage, path);

    const upload = await uploadBytes(refFile, reduced);
    const url = await getDownloadURL(upload.ref);

    urls.push(url);
  }

  return urls;
}

/* ========================= SALVAR MANUTENÇÃO ========================= */
$("salvar").onclick = async () => {
  const data = $("dataManutencao").value;
  const cavalo = $("descCavalo").value.trim();
  const reboque = $("descReboque").value.trim();

  const status = $("status");

  if (!data || (!cavalo && !reboque)){
    alert("Preencha a data e pelo menos um campo (Cavalo ou Reboque).");
    return;
  }

  status.textContent = "Enviando fotos...";
  status.style.color = "#ccc";

  let fotos = [];
  try {
    fotos = await enviarFotos(fotosParaUpload);
  } catch (e) {
    status.textContent = "ERRO AO ENVIAR FOTO: " + e.message;
    status.style.color = "red";
    return;
  }

  const registro = {
    data,
    cavalo,
    reboque,
    fotos,
    criadoEm: serverTimestamp()
  };

  try {
    if (editId) {
      await updateDoc(doc(db,"usuarios",uid,"manutencoes",editId), registro);
      status.textContent = "Registro atualizado.";
      editId = null;
      $("cancelarEdicao").style.display = "none";
    } else {
      await addDoc(collection(db,"usuarios",uid,"manutencoes"), registro);
      status.textContent = "Manutenção salva.";
    }
  } catch (e) {
    status.textContent = "ERRO AO SALVAR: " + e.message;
    status.style.color = "red";
    return;
  }

  $("dataManutencao").value = "";
  $("descCavalo").value = "";
  $("descReboque").value = "";
  fotosParaUpload = [];
  fotosPreview = [];
  previewDiv.innerHTML = "";
};

/* ========================= Cálculo de Folga ========================= */
$("calcFolga").onclick = () => {
  const ini = $("inicioFolga").value;
  const fim = $("fimFolga").value;

  if (!ini || !fim){
    alert("Selecione as duas datas.");
    return;
  }

  const info = calcularRetornoFolga(ini, fim);
  $("diasFolga").value = info.folgas;
  $("retornoFolga").value = fmtBR(info.retornoISO);
};

$("limparFolga").onclick = () => {
  $("inicioFolga").value = "";
  $("fimFolga").value = "";
  $("diasFolga").value = "";
  $("retornoFolga").value = "";
};

/* ========================= PDF — COM FOTOS ========================= */
$("pdfCompleto").onclick = async () => {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ unit:"pt", format:"a4" });

  let y = 40;
  const left = 40;
  const pageWidth = pdf.internal.pageSize.getWidth();

  pdf.setFontSize(18);
  pdf.text("Relatório Completo — Motorista Plus", left, y);
  y += 30;

  // Motorista
  pdf.setFontSize(12);
  pdf.text("Dados do Motorista:", left, y); y += 16;

  document.querySelectorAll("#dadosUsuarioCard .item").forEach(it => {
    pdf.setFontSize(11);
    pdf.text(it.innerText, left, y);
    y += 14;
  });

  y += 10;

  // Folga
  pdf.setFontSize(12);
  pdf.text("Dados da Folga:", left, y); y += 16;

  pdf.setFontSize(11);
  pdf.text(`Início: ${$("inicioFolga").value || "—"}`, left, y); y += 14;
  pdf.text(`Fim: ${$("fimFolga").value || "—"}`, left, y); y += 14;
  pdf.text(`Dias: ${$("diasFolga").value || "—"}`, left, y); y += 14;
  pdf.text(`Retorno: ${$("retornoFolga").value || "—"}`, left, y); y += 20;

  // Tabela
  pdf.autoTable({
    startY: y,
    head: [["Data","Cavalo","Reboque","Fotos"]],
    body: manutencoes.map(m => [
      fmtBR(m.data),
      m.cavalo || "—",
      m.reboque || "—",
      `${m.fotos?.length || 0} foto(s)`
    ]),
    headStyles: { fillColor:[243,146,32] },
    styles: { fontSize:10 },
    margin: { left }
  });

  y = pdf.lastAutoTable.finalY + 30;

  // Fotos
  for (const m of manutencoes){
    if (!m.fotos?.length) continue;

    pdf.setFontSize(14);
    pdf.text(`Manutenção — ${fmtBR(m.data)}`, left, y);
    y += 20;

    for (const url of m.fotos){
      if (y > 700) { pdf.addPage(); y = 40; }

      const blob = await fetch(url).then(r => r.blob());
      const base64 = await new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(blob);
      });

      pdf.addImage(base64, "JPEG", left, y, 180, 180);
      y += 200;
    }

    y += 20;
  }

  pdf.save("manutencoes.pdf");
};

/* ========================= Autenticação ========================= */
onAuthStateChanged(auth, async user => {
  if (!user) return location.href = "login.html";
  uid = user.uid;

  await carregarPerfil();
  iniciarStream();
});
</script>
</body>
</html>