<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Viagem — Motorista Plus</title>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* ===== Tema Motorista Plus ===== */
    :root {
      --bg: #0b0f14;
      --bg2: #10161d;
      --card: #161c23;
      --primary: #f39220;
      --primary-700: #d47e16;
      --outline: #2b3a49;
      --text: #fff;
      --muted: #b5bcc7;
      --green: #2b9348;
      --red: #dc3545;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, Arial, sans-serif
    }

    body {
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column
    }

    /* Botão Voltar */
    #voltarPainel {
      position: fixed;
      top: 12px;
      left: 12px;
      width: auto;
      padding: 8px 14px;
      background: rgba(255, 255, 255, .08);
      color: #fff;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, .25);
      cursor: pointer;
      font-size: 14px;
      z-index: 9999;
      backdrop-filter: blur(4px);
    }

    #voltarPainel:hover {
      background: rgba(255, 255, 255, .16)
    }

    /* Header */
    header {
      background:
        linear-gradient(180deg, rgba(0, 0, 0, .3), rgba(0, 0, 0, .6)),
        url("img/Logo.Motorista-Plus.png") center/cover no-repeat;
      padding: 30px 15px;
      text-align: center;
      border-bottom: 1px solid var(--outline);
    }

    header h1 {
      font-size: clamp(20px, 4vw, 30px);
      font-weight: 800
    }

    header .plus {
      color: var(--primary)
    }

    main {
      width: 94%;
      max-width: 1100px;
      margin: 18px auto 40px;
      display: grid;
      gap: 14px;
      flex: 1;
    }

    /* Cards */
    .card {
      background: var(--card);
      border: 1px solid var(--outline);
      padding: 16px;
      border-radius: 12px;
      backdrop-filter: blur(6px);
    }

    h2 {
      color: var(--primary);
      margin-bottom: 8px;
      font-size: 1.2rem;
    }

    label {
      font-size: 13px;
      margin-bottom: 4px;
      color: #e8e8e8;
      display: block
    }

    input,
    textarea,
    button {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--outline);
      background: rgba(255, 255, 255, .08);
      color: #fff;
      font-size: 14px;
    }

    textarea {
      min-height: 80px;
      resize: vertical
    }

    /* Botões */
    .btn {
      background: var(--primary);
      border: none;
      font-weight: 700;
      color: #fff;
      cursor: pointer
    }

    .btn:hover {
      background: var(--primary-700)
    }

    .btn-green {
      background: var(--green)
    }

    .btn-red {
      background: var(--red)
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid var(--outline);
      color: var(--muted)
    }

    .grid2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 10px
    }

    /* Dados do motorista */
    #dadosUsuarioCard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
    }

    #dadosUsuarioCard .item {
      background: rgba(255, 255, 255, .05);
      border: 1px solid var(--outline);
      padding: 10px;
      border-radius: 10px;
      text-align: center;
    }

    #dadosUsuarioCard .item strong {
      display: block;
      color: var(--primary);
      margin-bottom: 4px
    }

    /* Tabela */
    .table-wrap {
      overflow-x: auto
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      margin-top: 10px
    }

    thead th {
      background: var(--primary);
      color: #fff;
      padding: 8px;
      text-align: center
    }

    td,
    th {
      border: 1px solid var(--outline);
      padding: 8px;
      text-align: center
    }

    .edit-input {
      width: 70px;
      background: rgba(255, 255, 255, .06);
      color: #fff;
      border-radius: 8px
    }

    .row-actions {
      display: flex;
      gap: 6px;
      justify-content: center;
      flex-wrap: wrap
    }

    footer {
      padding: 12px;
      text-align: center;
      color: var(--muted);
      border-top: 1px solid var(--outline)
    }
  </style>
</head>

<body>

  <!-- Botão voltar -->
  <button id="voltarPainel" onclick="window.location.href='painel.html'">← Voltar</button>

  <header>
    <h1>Planilha de Viagem — Motorista<span class="plus">Plus</span></h1>
  </header>

  <main>

    <!-- ===== Dados do motorista ===== -->
    <section class="card">
      <h2>Dados do Motorista</h2>
      <div id="dadosUsuarioCard">Carregando...</div>
    </section>

    <!-- ===== Dados da viagem ===== -->
    <section class="card">
      <h2>Viagem</h2>

      <div class="grid2">
        <div><label>Início</label><input type="date" id="viagemInicio"></div>
        <div><label>Fim</label><input type="date" id="viagemFim"></div>
        <div><label>KM Inicial</label><input type="number" id="kmInicio"></div>
        <div><label>KM Final</label><input type="number" id="kmFim"></div>
      </div>

      <div class="grid2" style="margin-top:10px">
        <div><label>Dias Viajados</label><input type="text" id="diasViajados" readonly></div>
        <div><label>Folgas</label><input type="text" id="diasFolga" readonly></div>
        <div><label>Retorno</label><input type="text" id="retornoFolga" readonly></div>
        <div><label>KM Rodados</label><input type="text" id="kmRodados" readonly></div>
      </div>

      <div class="grid2" style="margin-top:10px">
        <div>
          <label>Observações</label>
          <textarea id="observacoes"></textarea>
        </div>
        <div>
          <label>Valor da Diária (R$)</label>
          <input type="number" id="valorDiaria" step="0.01" placeholder="100.00">
        </div>
      </div>

      <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap">
        <button id="salvarViagemBtn" class="btn-green btn">Salvar</button>
        <button id="limparCamposBtn" class="btn-red btn">Limpar</button>
      </div>
      <p id="statusEdicao" style="margin-top:6px;color:var(--muted)"></p>
    </section>

    <!-- ===== Diárias ===== -->
    <section class="card">
      <h2>Diárias</h2>

      <div class="grid2">
        <div><label>Data</label><input type="date" id="diariaData"></div>
        <div><label>Qtd</label><input type="number" id="diariaQtd" min="1" value="1"></div>
      </div>

      <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
        <button id="addDiariaBtn" class="btn">Adicionar</button>
        <button id="exportCsvBtn" class="btn-ghost">Exportar CSV</button>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Tipo</th>
              <th>Qtd</th>
              <th>Valor</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="tbodyDiarias"></tbody>
        </table>
      </div>
    </section>

    <!-- PDF -->
    <section class="card" style="text-align:center">
      <button id="gerarPDFButton" class="btn" style="width:200px">Gerar PDF</button>
    </section>

  </main>

  <footer>© 2025 Motorista Plus</footer>

  <!-- ============================================================
     ====================   SCRIPT   =============================
     ============================================================ -->
  <script type="module">
    /* ===== Firebase ===== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc,
      collection, addDoc, getDocs, deleteDoc, orderBy, query, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const app = initializeApp({
      apiKey: "AIzaSyCJDj5XVOoNN8XxGb8znGlnek3tyP52o-U",
      authDomain: "motorista-plus-dc909.firebaseapp.com",
      projectId: "motorista-plus-dc909"
    });

    const auth = getAuth(app);
    const db = getFirestore(app);
    const $ = id => document.getElementById(id);

    let uid = null;
    let perfil = null;
    let viagemDoc = null;
    let diarias = [];

    /* ================= CARREGAR PERFIL ================= */
    async function carregarPerfil() {
      const snap = await getDoc(doc(db, "usuarios", uid));
      if (!snap.exists()) return;
      perfil = snap.data();
      $('dadosUsuarioCard').innerHTML = `
    <div class="item"><strong>Motorista</strong>${perfil.nome}</div>
    <div class="item"><strong>Telefone</strong>${perfil.telefone}</div>
    <div class="item"><strong>Cavalo</strong>${perfil.placaCavalo}</div>
    <div class="item"><strong>Reboque</strong>${perfil.placaReboque}</div>
    <div class="item"><strong>Email</strong>${perfil.email}</div>
  `;
    }

    /* ================= VIAGEM ================= */
    function toISO(d) { return d ? new Date(d).toISOString().slice(0, 10) : "" }
    function fmtBR(iso) { const d = new Date(iso); return `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getFullYear()}` }

    async function carregarViagem() {
      const ref = doc(db, "usuarios", uid, "viagemAtual", "dados");
      const snap = await getDoc(ref);
      if (!snap.exists()) return;

      viagemDoc = snap.data();
      $('viagemInicio').value = toISO(viagemDoc.inicio);
      $('viagemFim').value = toISO(viagemDoc.fim);
      $('kmInicio').value = viagemDoc.kmInicio;
      $('kmFim').value = viagemDoc.kmFim;
      $('observacoes').value = viagemDoc.observacoes || "";
      $('valorDiaria').value = viagemDoc.diariaValor || 100;

      preencherDerivados(viagemDoc);
      $('statusEdicao').textContent = "Editando viagem salva";
    }

    function preencherDerivados(v) {
      if (!v.inicio || !v.fim) return;
      const ini = new Date(v.inicio), fim = new Date(v.fim);

      const dias = Math.ceil((fim - ini) / 86400000) + 1;
      const folga = Math.ceil(dias / 7);
      const iniFolga = new Date(fim); iniFolga.setDate(iniFolga.getDate() + 1);
      const retFolga = new Date(iniFolga); retFolga.setDate(retFolga.getDate() + folga - 1);

      $('diasViajados').value = `${dias} dia(s)`;
      $('diasFolga').value = `${folga} dia(s)`;
      $('retornoFolga').value = fmtBR(retFolga);
      $('kmRodados').value = v.kmFim - v.kmInicio;
    }

    /* ================= DIÁRIAS ================= */
    async function carregarDiarias() {
      const col = collection(db, "usuarios", uid, "diarias");
      const q = query(col, orderBy("data", "asc"));
      const snap = await getDocs(q);
      diarias = [];
      snap.forEach(d => diarias.push({ id: d.id, ...d.data() }));
      renderDiarias();
    }

    function renderDiarias() {
      const tbody = $('tbodyDiarias');
      tbody.innerHTML = "";
      const v = Number($('valorDiaria').value || 100);

      diarias.forEach(d => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
      <td>${fmtBR(d.data)}</td>
      <td>Diária</td>
      <td><input class="edit-input" type="number" min="1" max="60" value="${d.qtd}" data-id="${d.id}"></td>
      <td>${(d.qtd * v).toFixed(2)}</td>
      <td class="row-actions">
        <button class="small-btn btn" data-act="save" data-id="${d.id}">Salvar</button>
        <button class="small-btn btn-red" data-act="del" data-id="${d.id}">Excluir</button>
      </td>`;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll("button").forEach(b => {
        b.onclick = async () => {
          const id = b.dataset.id;
          if (b.dataset.act === "del") {
            await deleteDoc(doc(db, "usuarios", uid, "diarias", id));
          } else {
            const qtd = Number(document.querySelector(`input[data-id="${id}"]`).value);
            await updateDoc(doc(db, "usuarios", uid, "diarias", id), { qtd });
          }
          carregarDiarias();
        };
      });
    }

    /* ================= SALVAR VIAGEM ================= */
    $('salvarViagemBtn').onclick = async () => {
      const ini = $('viagemInicio').value, fim = $('viagemFim').value;
      const kmI = +$('kmInicio').value, kmF = +$('kmFim').value;

      if (!ini || !fim || !kmI || !kmF) return alert("Complete todos os campos");

      const obj = {
        inicio: new Date(ini).toISOString(),
        fim: new Date(fim).toISOString(),
        kmInicio: kmI, kmFim: kmF,
        observacoes: $('observacoes').value,
        diariaValor: +$('valorDiaria').value
      };

      await setDoc(doc(db, "usuarios", uid, "viagemAtual", "dados"), obj);
      alert("Salvo!");
      carregarViagem();
    };

    /* ================= ADICIONAR DIÁRIA ================= */
    $('addDiariaBtn').onclick = async () => {
      const data = $('diariaData').value;
      const qtd = +$('diariaQtd').value;
      if (!data) return alert("Selecione a data");

      await addDoc(collection(db, "usuarios", uid, "diarias"), {
        data, qtd, createdAt: serverTimestamp()
      });

      $('diariaQtd').value = 1;
      carregarDiarias();
    };

    /* ================= EXPORTAÇÃO PDF ================= */
    $('gerarPDFButton').onclick = async () => {
      await carregarViagem();
      await carregarDiarias();
      if (!viagemDoc) return alert("Salve a viagem antes");

      const { jsPDF } = window.jspdf;
      const docpdf = new jsPDF({ unit: "pt", format: "a4" });

      const startX = 40, rowH = 18;
      let y = 40;

      try { docpdf.addImage("img/Logo.Motorista-Plus.png", "PNG", startX, 10, 110, 42); } catch (e) { }
      docpdf.setFontSize(15); docpdf.text("Planilha de Viagem — Motorista Plus", startX + 130, 40);

      y = 80; docpdf.setFontSize(11);

      docpdf.rect(startX - 5, y - 15, 520, rowH * 4);
      docpdf.text(`Motorista: ${perfil.nome}`, startX, y);
      docpdf.text(`Placas: ${perfil.placaCavalo} / ${perfil.placaReboque}`, startX + 260, y); y += rowH;
      docpdf.text(`Início: ${fmtBR(viagemDoc.inicio)}`, startX, y);
      docpdf.text(`Fim: ${fmtBR(viagemDoc.fim)}`, startX + 260, y); y += rowH;
      docpdf.text(`KM Inicial: ${viagemDoc.kmInicio}`, startX, y);
      docpdf.text(`KM Final: ${viagemDoc.kmFim}`, startX + 260, y); y += rowH;
      docpdf.text(`KM Rodados: ${viagemDoc.kmFim - viagemDoc.kmInicio}`, startX, y);

      y += rowH + 10;

      const corpo = diarias.map(d => [
        fmtBR(d.data), "Diária", String(d.qtd), (d.qtd * viagemDoc.diariaValor).toFixed(2)
      ]);

      docpdf.autoTable({
        startY: y, head: [["Data", "Tipo", "Qtd", "Valor"]],
        body: corpo,
        headStyles: { fillColor: [243, 146, 32] },
        margin: { left: startX, right: startX }
      });

      docpdf.save("planilha_viagem.pdf");
    };

    /* ================= LOGADO ================= */
    onAuthStateChanged(auth, async user => {
      if (!user) return window.location.href = "index.html";
      uid = user.uid;
      await carregarPerfil();
      await carregarViagem();
      await carregarDiarias();
    });
  </script>

</body>

</html>