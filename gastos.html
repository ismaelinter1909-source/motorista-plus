<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gastos & Diárias — Motorista Plus</title>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#0b0f14; --bg2:#10161d; --card:#161c23;
      --primary:#f39220; --primary-700:#d47e16;
      --outline:#2b3a49; --text:#fff; --muted:#b5bcc7;
      --green:#2b9348; --red:#dc3545; --info:#0077b6;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,Arial,sans-serif}
    body{background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column}

    /* Voltar no topo */
    #voltarPainelTopo{
      position:fixed; top:12px; left:12px; z-index:9999;
      width:auto; padding:8px 14px;
      background:rgba(255,255,255,.08); color:#fff;
      border-radius:8px; border:1px solid rgba(255,255,255,.25);
      cursor:pointer; font-size:14px; backdrop-filter:blur(4px);
      transition:.3s ease;
    }
    #voltarPainelTopo:hover{ background:rgba(255,255,255,.16) }

    header{
      background:linear-gradient(180deg,rgba(0,0,0,.3),rgba(0,0,0,.6));
      padding:28px 16px; text-align:center; border-bottom:1px solid var(--outline)
    }
    header h1{font-weight:800;font-size:clamp(20px,4vw,30px)}
    header .plus{color:var(--primary)}

    .wrap{width:94%;max-width:1100px;margin:18px auto;flex:1;display:grid;gap:14px}

    .card{
      background:var(--card); border:1px solid var(--outline);
      padding:16px; border-radius:12px; backdrop-filter:blur(6px)
    }

    .dados{display:flex;gap:10px;flex-wrap:wrap}
    .dados div{min-width:180px;background:rgba(255,255,255,.05);border:1px solid var(--outline);
      padding:10px;border-radius:10px}
    .dados div b{color:var(--primary)}

    h2{color:var(--primary);font-size:1.15rem;margin-bottom:8px}
    label{display:block;font-size:13px;margin-top:8px;color:#e8e8e8}

    input,select,textarea,button{
      width:100%;padding:12px;border-radius:10px;border:1px solid var(--outline);
      background:rgba(255,255,255,.08);color:#fff;font-size:14px;outline:none;
      transition:box-shadow .2s ease, transform .08s ease, background .2s ease, border-color .2s ease;
    }
    input:focus,select:focus,textarea:focus{box-shadow:0 0 0 3px rgba(243,146,32,.15);border-color:var(--primary)}

    select{
      -webkit-appearance:none;-moz-appearance:none;appearance:none;
      background-image:linear-gradient(45deg,transparent 50%, #fff 50%),
                       linear-gradient(135deg, #fff 50%, transparent 50%),
                       linear-gradient(to right, transparent, transparent);
      background-position:calc(100% - 18px) calc(50% - 3px),
                          calc(100% - 13px) calc(50% - 3px),
                          calc(100% - 2.2em) 0.6em;
      background-size:5px 5px, 5px 5px, 1px 1.6em;
      background-repeat:no-repeat;
    }

    .grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media(max-width:900px){.grid2{grid-template-columns:1fr}}

    .btn{background:var(--primary);border:none;font-weight:700;color:#fff;cursor:pointer;transition:.25s}
    .btn:hover{background:var(--primary-700);transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn-green{background:var(--green)} .btn-green:hover{filter:brightness(1.05)}
    .btn-red{background:var(--red)} .btn-red:hover{filter:brightness(1.05)}
    .btn-info{background:var(--info)} .btn-info:hover{filter:brightness(1.05)}
    .btn-ghost{background:transparent;border:1px solid var(--outline);color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap}

    ul{list-style:none;padding-left:0;margin-top:8px;max-height:260px;overflow:auto}
    li{background:rgba(255,255,255,.05);border:1px solid var(--outline);
      padding:10px;border-radius:10px;margin:6px 0;display:flex;justify-content:space-between;gap:8px;align-items:center;flex-wrap:wrap}
    .tag{font-size:12px;color:var(--muted)}
    .row-actions{display:flex;gap:8px;flex-wrap:wrap}

    canvas{display:block;margin:10px auto;max-width:420px}
    footer{padding:12px;text-align:center;color:var(--muted);border-top:1px solid var(--outline)}
  </style>
</head>
<body>

  <button id="voltarPainelTopo" onclick="window.location.href='painel.html'">← Voltar</button>

  <header>
    <h1>Gastos & Diárias — Motorista<span class="plus">Plus</span></h1>
  </header>

  <main class="wrap">
    <!-- Dados do Motorista -->
    <section class="card">
      <h2>Dados do Motorista</h2>
      <div class="dados" id="dadosUsuario"></div>
    </section>

    <!-- Diárias -->
    <section class="card">
      <h2>Período da Viagem (diárias automáticas)</h2>
      <div class="row" style="margin-top:6px">
        <div style="flex:1 1 220px">
          <label for="tripStart">Data Início</label>
          <input type="date" id="tripStart">
        </div>
        <div style="flex:1 1 220px">
          <label for="tripEnd">Data Fim</label>
          <input type="date" id="tripEnd">
        </div>
        <div style="flex:0 0 180px;align-self:end">
          <button class="btn btn-green" id="calcDiarias">Calcular Diárias</button>
        </div>
        <div style="flex:0 0 180px;align-self:end">
          <button class="btn btn-ghost" id="clearDiarias">Limpar Diárias</button>
        </div>
      </div>
      <p id="totalDiariasText" class="tag" style="margin-top:8px">Total de diárias: 0 — Valor total: R$ 0,00</p>
    </section>

    <!-- GASTOS + VALES -->
    <div class="grid2">
      <!-- Gastos -->
      <section class="card">
        <h2>Registrar Gasto</h2>
        <label for="gastoDate">Data</label>
        <input type="date" id="gastoDate">

        <label for="gastoMotivo">Motivo</label>
        <input id="gastoMotivo" placeholder="Ex: Almoço, Pedágio">

        <label for="gastoLocal">Local</label>
        <input id="gastoLocal" placeholder="Ex: Posto X">

        <label for="gastoValor">Valor (R$)</label>
        <input id="gastoValor" type="number" step="0.01" min="0">

        <label for="gastoAut">Autorização</label>
        <select id="gastoAut">
          <option value="Francisco">Francisco</option>
          <option value="Vinicios">Vinicios</option>
          <option value="Jeferson">Jeferson</option>
          <option value="Daniel">Daniel</option>
          <option value="William">William</option>
          <option value="Douglas">Douglas</option>
          <option value="Valdir">Valdir</option>
          <option value="Outro">Outro</option>
        </select>

        <div class="row" style="margin-top:10px">
          <button class="btn btn-green" id="addGasto" style="flex:1 1 160px">Salvar</button>
          <button class="btn btn-ghost" id="cancelarEditGasto" style="flex:1 1 160px;display:none">Cancelar edição</button>
          <button class="btn btn-ghost" id="clearGasto" style="flex:1 1 160px">Limpar</button>
        </div>

        <h3 style="margin-top:12px;font-size:1rem;color:var(--primary)">Lista de Gastos</h3>
        <ul id="listaGastos"></ul>
      </section>

      <!-- Vales -->
      <section class="card">
        <h2>Retirada de Vales</h2>

        <label for="valeDate">Data</label>
        <input id="valeDate" type="date">

        <label for="valeMotivo">Descrição</label>
        <input id="valeMotivo" placeholder="Ex: Vale refeição, adiantamento...">

        <label for="valeValor">Valor (R$)</label>
        <input id="valeValor" type="number" step="0.01" min="0">

        <div class="row" style="margin-top:10px">
          <button class="btn btn-green" id="addVale" style="flex:1 1 160px">Salvar</button>
          <button class="btn btn-ghost" id="cancelarEditVale" style="flex:1 1 160px;display:none">Cancelar edição</button>
          <button class="btn btn-ghost" id="clearVale" style="flex:1 1 160px">Limpar</button>
        </div>

        <h3 style="margin-top:12px;font-size:1rem;color:var(--primary)">Lista de Vales</h3>
        <ul id="listaVales"></ul>
      </section>
    </div>

    <!-- Resumo -->
    <section class="card" style="text-align:center">
      <h2>Resumo Visual</h2>
      <canvas id="chartResumo" width="420" height="280"></canvas>
      <p id="saldoTexto" style="margin-top:6px;font-weight:700"></p>
    </section>

    <!-- Ações -->
    <section class="card" style="text-align:center">
      <div class="row" style="justify-content:center">
        <button class="btn btn-green" id="gerarPDF" style="flex:0 0 200px">Gerar PDF</button>
        <button class="btn btn-ghost" id="exportExcel" style="flex:0 0 200px">Exportar Excel</button>
        <button class="btn btn-red" id="clearAll" style="flex:0 0 200px">Apagar TODOS</button>
      </div>
    </section>

  </main>

  <footer>© 2025 Motorista Plus</footer>

  <!-- SCRIPT COMPLETO -->
  <script type="module">
    /* ================= Firebase (motorista-plus-c53f4) ================= */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { 
      getAuth, onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore, doc, getDoc,
      collection, addDoc, updateDoc, deleteDoc,
      query, orderBy, onSnapshot, getDocs, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const app = initializeApp({
      apiKey: "AIzaSyCnlpnTTJvJPZxuZdmpKQWbbHtvH72nMUU",
      authDomain: "motorista-plus-c53f4.firebaseapp.com",
      projectId: "motorista-plus-c53f4",
      storageBucket: "motorista-plus-c53f4.firebasestorage.app",
      messagingSenderId: "766097061342",
      appId: "1:766097061342:web:36d999bec6d9fe8c46994f",
      measurementId: "G-CBT2D0CXPN"
    });

    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* ================= Constantes/UI ================= */
    const $ = (id)=>document.getElementById(id);
    const DIARIA_VALOR = 4.28;
    let totalDiarias = 0;

    let uid = null;
    let perfil = null;
    let gastos = []; // {id,date,motivo,local,valor,aut}
    let vales  = []; // {id,date,motivo,valor}
    let editGastoId = null;
    let editValeId  = null;
    let chart = null;

    const fmtBR = (isoLike)=>{
      const d = new Date(isoLike);
      if(isNaN(d)) return "";
      return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()}`;
    };

    /* ================= Perfil ================= */
    async function carregarPerfil(){
      const snap = await getDoc(doc(db,"usuarios", uid));
      if(!snap.exists()) return;
      perfil = snap.data();
      $('dadosUsuario').innerHTML = `
        <div><b>Motorista:</b> ${perfil.nome || '—'}</div>
        <div><b>Cavalo:</b> ${perfil.placaCavalo || '—'}</div>
        <div><b>Reboque:</b> ${perfil.placaReboque || '—'}</div>
        <div><b>Email:</b> ${perfil.email || '—'}</div>
        <div><b>Telefone:</b> ${perfil.telefone || '—'}</div>
      `;
    }

    /* ================= Streams (tempo real) ================= */
    function iniciarStreams(){
      // gastos
      const qG = query(collection(db,"usuarios",uid,"gastos"), orderBy("criadoEm","desc"));
      onSnapshot(qG, (snap)=>{
        gastos = snap.docs.map(d=>{
          const x = d.data();
          return {
            id:d.id,
            date: (typeof x.date==='string')? x.date : (x.date?.toDate?.()? x.date.toDate().toISOString().slice(0,10):""),
            motivo: x.motivo||"",
            local:  x.local||"",
            valor:  Number(x.valor||0),
            aut:    x.aut||""
          };
        });
        renderGastos();
        atualizarResumo();
      });

      // vales
      const qV = query(collection(db,"usuarios",uid,"vales"), orderBy("criadoEm","desc"));
      onSnapshot(qV, (snap)=>{
        vales = snap.docs.map(d=>{
          const x = d.data();
          return {
            id:d.id,
            date: (typeof x.date==='string')? x.date : (x.date?.toDate?.()? x.date.toDate().toISOString().slice(0,10):""),
            motivo: x.motivo||"",
            valor:  Number(x.valor||0)
          };
        });
        renderVales();
        atualizarResumo();
      });
    }

    /* ================= Render Listas ================= */
    function renderGastos(){
      const ul = $('listaGastos');
      if(!gastos.length){ ul.innerHTML = '<li class="tag">(nenhum)</li>'; return; }
      ul.innerHTML = gastos.map(g=>`
        <li>
          <div style="flex:1;min-width:240px">
            <div style="font-weight:700">Gasto — ${fmtBR(g.date)}</div>
            <div class="tag">${g.motivo} / ${g.local} — Aut.: ${g.aut}</div>
          </div>
          <div style="display:flex;align-items:center;gap:10px">
            <div style="font-weight:700">R$ ${g.valor.toFixed(2)}</div>
            <div class="row-actions">
              <button class="btn" data-type="g" data-act="edit" data-id="${g.id}">Editar</button>
              <button class="btn-red" data-type="g" data-act="del" data-id="${g.id}">Remover</button>
            </div>
          </div>
        </li>
      `).join('');

      ul.querySelectorAll('button').forEach(b=>{
        b.onclick = async ()=>{
          const id  = b.dataset.id;
          const tp  = b.dataset.type;
          const act = b.dataset.act;

          if(tp==='g' && act==='edit'){
            const g = gastos.find(x=>x.id===id);
            if(!g) return;
            $('gastoDate').value   = g.date;
            $('gastoMotivo').value = g.motivo;
            $('gastoLocal').value  = g.local;
            $('gastoValor').value  = g.valor;
            $('gastoAut').value    = g.aut || 'Francisco';
            editGastoId = id;
            $('cancelarEditGasto').style.display = 'inline-block';
            $('gastoMotivo').focus();
          }
          if(tp==='g' && act==='del'){
            if(!confirm('Remover este gasto?')) return;
            await deleteDoc(doc(db,"usuarios",uid,"gastos",id));
          }
        };
      });
    }

    function renderVales(){
      const ul = $('listaVales');
      if(!vales.length){ ul.innerHTML = '<li class="tag">(nenhum)</li>'; return; }
      ul.innerHTML = vales.map(v=>`
        <li>
          <div style="flex:1;min-width:240px">
            <div style="font-weight:700">Vale — ${fmtBR(v.date)}</div>
            <div class="tag">${v.motivo || '—'}</div>
          </div>
          <div style="display:flex;align-items:center;gap:10px">
            <div style="font-weight:700">R$ ${v.valor.toFixed(2)}</div>
            <div class="row-actions">
              <button class="btn" data-type="v" data-act="edit" data-id="${v.id}">Editar</button>
              <button class="btn-red" data-type="v" data-act="del" data-id="${v.id}">Remover</button>
            </div>
          </div>
        </li>
      `).join('');

      ul.querySelectorAll('button').forEach(b=>{
        b.onclick = async ()=>{
          const id  = b.dataset.id;
          const tp  = b.dataset.type;
          const act = b.dataset.act;

          if(tp==='v' && act==='edit'){
            const v = vales.find(x=>x.id===id);
            if(!v) return;
            $('valeDate').value   = v.date;
            $('valeMotivo').value = v.motivo || '';
            $('valeValor').value  = v.valor;
            editValeId = id;
            $('cancelarEditVale').style.display = 'inline-block';
            $('valeMotivo').focus();
          }
          if(tp==='v' && act==='del'){
            if(!confirm('Remover este vale?')) return;
            await deleteDoc(doc(db,"usuarios",uid,"vales",id));
          }
        };
      });
    }

    /* ================= Resumo / Gráfico ================= */
    function atualizarResumo(){
      const bonus = +(totalDiarias * DIARIA_VALOR).toFixed(2);
      const totalG = +gastos.reduce((s,g)=>s + (Number(g.valor)||0), 0).toFixed(2);
      const totalV = +vales.reduce((s,v)=>s + (Number(v.valor)||0), 0).toFixed(2);

      $('totalDiariasText').textContent =
        `Total de diárias: ${totalDiarias} — Valor total: R$ ${bonus.toFixed(2)}`;

      // Regra definida: compara (bônus + gastos) com (vales)
      const base = bonus + totalG;
      const diff = Math.abs(base - totalV).toFixed(2);
      const motoristaDeve = base > totalV; // se base maior, motorista deve

      $('saldoTexto').textContent = motoristaDeve
        ? `Saldo: O motorista deve à empresa R$ ${diff}`
        : `Saldo: A empresa deve ao motorista R$ ${diff}`;

      const ctx = $('chartResumo').getContext('2d');
      if(chart) chart.destroy();
      chart = new Chart(ctx, {
        type:'pie',
        data:{
          labels:['Bônus','Gastos','Vales'],
          datasets:[{ data:[bonus,totalG,totalV] }]
        },
        options:{ plugins:{ legend:{ position:'bottom' } } }
      });
    }

    /* ================= Diárias ================= */
    $('calcDiarias').onclick = ()=>{
      const s = $('tripStart').value;
      const e = $('tripEnd').value;
      if(!s || !e || new Date(e) < new Date(s)){
        alert('Selecione datas válidas.'); return;
      }
      totalDiarias = Math.floor((new Date(e)-new Date(s))/(1000*60*60*24)) + 1;
      atualizarResumo();
    };
    $('clearDiarias').onclick = ()=>{
      totalDiarias = 0;
      $('tripStart').value = '';
      $('tripEnd').value   = '';
      atualizarResumo();
    };

    /* ================= CRUD GASTOS ================= */
    $('addGasto').onclick = async ()=>{
      const d = $('gastoDate').value;
      const m = $('gastoMotivo').value.trim();
      const l = $('gastoLocal').value.trim();
      const v = parseFloat($('gastoValor').value || 0);
      const a = $('gastoAut').value;

      if(!d || !m || !l || !(v>0)){
        alert('Preencha todos os campos e valor > 0'); return;
      }

      const payload = { date:d, motivo:m, local:l, valor:v, aut:a, criadoEm:serverTimestamp() };

      if(editGastoId){
        await updateDoc(doc(db,"usuarios",uid,"gastos",editGastoId), payload);
        editGastoId = null;
        $('cancelarEditGasto').style.display = 'none';
      }else{
        await addDoc(collection(db,"usuarios",uid,"gastos"), payload);
      }

      $('gastoDate').value = '';
      $('gastoMotivo').value = '';
      $('gastoLocal').value = '';
      $('gastoValor').value = '';
      $('gastoAut').value   = 'Francisco';
    };

    $('cancelarEditGasto').onclick = ()=>{
      editGastoId = null;
      $('cancelarEditGasto').style.display = 'none';
      $('gastoDate').value = $('gastoMotivo').value = $('gastoLocal').value = $('gastoValor').value = '';
      $('gastoAut').value = 'Francisco';
    };

    $('clearGasto').onclick = ()=>{
      $('gastoDate').value = $('gastoMotivo').value = $('gastoLocal').value = $('gastoValor').value = '';
      $('gastoAut').value = 'Francisco';
    };

    /* ================= CRUD VALES ================= */
    $('addVale').onclick = async ()=>{
      const d = $('valeDate').value;
      const v = parseFloat($('valeValor').value || 0);
      const m = $('valeMotivo').value.trim();

      if(!d || !(v>0)){
        alert('Preencha data e valor > 0'); return;
      }

      const payload = { date:d, motivo:m, valor:v, criadoEm:serverTimestamp() };

      if(editValeId){
        await updateDoc(doc(db,"usuarios",uid,"vales",editValeId), payload);
        editValeId = null;
        $('cancelarEditVale').style.display = 'none';
      }else{
        await addDoc(collection(db,"usuarios",uid,"vales"), payload);
      }

      $('valeDate').value = '';
      $('valeValor').value = '';
      $('valeMotivo').value = '';
    };

    $('cancelarEditVale').onclick = ()=>{
      editValeId = null;
      $('cancelarEditVale').style.display = 'none';
      $('valeDate').value = $('valeValor').value = $('valeMotivo').value = '';
    };

    $('clearVale').onclick = ()=>{
      $('valeDate').value = $('valeValor').value = $('valeMotivo').value = '';
    };

    /* ================= Ações gerais ================= */
    $('clearAll').onclick = async ()=>{
      if(!confirm('Excluir TODOS os gastos e vales?')) return;
      const colG = await getDocs(collection(db,"usuarios",uid,"gastos"));
      const colV = await getDocs(collection(db,"usuarios",uid,"vales"));
      const jobs = [];
      colG.forEach(d=> jobs.push(deleteDoc(d.ref)));
      colV.forEach(d=> jobs.push(deleteDoc(d.ref)));
      await Promise.all(jobs);
    };

    /* ================= PDF (SEM LOGO) ================= */
    function tabelaPDF(doc, startX, startY, headers, rows, colWidths){
      let y = startY;
      const rh = 20;
      const col = (i)=> colWidths.slice(0,i).reduce((a,b)=>a+b,0);

      // header
      headers.forEach((h,i)=>{ doc.rect(startX+col(i), y, colWidths[i], rh); });
      headers.forEach((h,i)=>{ doc.text(h, startX+col(i)+6, y+rh-6); });
      y += rh;

      // rows
      rows.forEach(r=>{
        r.forEach((cell,i)=>{
          doc.rect(startX+col(i), y, colWidths[i], rh);
          doc.text(String(cell), startX+col(i)+6, y+rh-6);
        });
        y += rh;
      });

      return y+10;
    }

    $('gerarPDF').onclick = ()=>{
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'pt', format:'a4' });

      const startX = 40;
      let y = 44;

      doc.setFontSize(16);
      doc.text('Relatório Financeiro — Motorista Plus', startX, y); 
      y += 24;

      doc.setFontSize(11);
      const uInfo = [
        ['Motorista', perfil?.nome || '—'],
        ['Cavalo',    perfil?.placaCavalo || '—'],
        ['Reboque',   perfil?.placaReboque || '—'],
        ['E-mail',    perfil?.email || '—']
      ];
      uInfo.forEach(r=>{ doc.text(`${r[0]}: ${r[1]}`, startX, y); y += 18; });
      y += 6;

      // Diárias / Bônus — descrição exigida
      const bonus = +(totalDiarias * DIARIA_VALOR).toFixed(2);
      y = tabelaPDF(
        doc, startX, y,
        ['Tipo','Quantidade','Descrição','Valor (R$)'],
        [['Bônus', totalDiarias, '(Valor diário de 4,28)', bonus.toFixed(2)]],
        [120,100,220,120]
      );

      // Gastos
      const gRows = gastos.length
        ? gastos.map(g=>['Gasto', fmtBR(g.date), `${g.motivo} / ${g.local} — Aut.: ${g.aut}`, g.valor.toFixed(2)])
        : [['Gasto','—','—','0,00']];
      y = tabelaPDF(
        doc, startX, y,
        ['Tipo','Data','Motivo / Local','Valor (R$)'],
        gRows,
        [120,100,220,120]
      );

      // Vales (com data/descrição/valor)
      const vRows = vales.length
        ? vales.map(v=>['Vale', fmtBR(v.date), (v.motivo||'—'), v.valor.toFixed(2)])
        : [['Vale','—','—','0,00']];
      y = tabelaPDF(
        doc, startX, y,
        ['Tipo','Data','Descrição','Valor (R$)'],
        vRows,
        [120,100,220,120]
      );

      // Saldo final (regra solicitada)
      const totalG = +gastos.reduce((s,g)=>s + (Number(g.valor)||0), 0).toFixed(2);
      const totalV = +vales.reduce((s,v)=>s + (Number(v.valor)||0), 0).toFixed(2);
      const base   = bonus + totalG;
      const diff   = Math.abs(base - totalV).toFixed(2);
      const motoristaDeve = base > totalV;

      doc.setFontSize(12);
      doc.text(
        motoristaDeve
          ? `Saldo Final: R$ ${diff} — O motorista deve à empresa`
          : `Saldo Final: R$ ${diff} — A empresa deve ao motorista`,
        startX, y
      );

      doc.save('relatorio_financeiro.pdf');
    };

    /* ================= Excel ================= */
    $('exportExcel').onclick = ()=>{
      const bonus = +(totalDiarias * DIARIA_VALOR).toFixed(2);
      const totalG = +gastos.reduce((s,g)=>s + (Number(g.valor)||0), 0).toFixed(2);
      const totalV = +vales.reduce((s,v)=>s + (Number(v.valor)||0), 0).toFixed(2);
      const base   = bonus + totalG;
      const diff   = Math.abs(base - totalV).toFixed(2);
      const motoristaDeve = base > totalV;

      const ws_data = [
        ['Relatório Financeiro — Motorista Plus'],
        ['Motorista', perfil?.nome || '—'],
        ['Cavalo', perfil?.placaCavalo || '—'],
        ['Reboque', perfil?.placaReboque || '—'],
        [],
        ['Tipo','Quantidade/Data','Descrição','Valor (R$)'],
        ['Bônus', totalDiarias, '(Valor diário de 4,28)', bonus.toFixed(2)],
        ...gastos.map(g=>['Gasto', fmtBR(g.date), `${g.motivo} / ${g.local} — Aut.: ${g.aut}`, g.valor.toFixed(2)]),
        ...vales.map(v=>['Vale', fmtBR(v.date), v.motivo||'—', v.valor.toFixed(2)]),
        [],
        ['Saldo Final', '', motoristaDeve ? 'Motorista deve' : 'Empresa deve', diff]
      ];
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      XLSX.utils.book_append_sheet(wb, ws, 'Resumo');
      XLSX.writeFile(wb, 'resumo_financeiro.xlsx');
    };

    /* ================= Apagar TODOS ================= */
    $('clearAll').onclick = async ()=>{
      if(!confirm('Excluir TODOS os gastos e vales?')) return;
      const gs = await getDocs(collection(db,"usuarios",uid,"gastos"));
      const vs = await getDocs(collection(db,"usuarios",uid,"vales"));
      const jobs = [];
      gs.forEach(d=> jobs.push(deleteDoc(d.ref)));
      vs.forEach(d=> jobs.push(deleteDoc(d.ref)));
      await Promise.all(jobs);
    };

    /* ================= Auth bootstrap ================= */
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ window.location.href='login.html'; return; }
      uid = user.uid;
      await carregarPerfil();
      iniciarStreams();
      atualizarResumo();
    });
  </script>
</body>
</html>